<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>添加小品</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./style/addSymbolBatch.css" rel="stylesheet">
    <link href="./js/layerTree/icons/iconfont.css" rel="stylesheet">
    <script src="./js/layerTree/vue.global.js"></script>
    <script src="./js/layerTree/naive-ui.min.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div class="vue-container" id="add-symbol-container" style="display: none;">
        <div id="app">
            <div class="panel-container">
                <div class="panel-header">
                    <div class="panel-header-title">添加小品</div>
                    <span class="panel-header-close" id="close">X</span>
                </div>

                <!-- vue component content -->
                <n-config-provider :theme-overrides="overridesTheme" :theme="darkTheme" style="margin-top: 20px;">
                    <n-scrollbar style="max-height: 520px;padding-right: 10px;" trigger="none">
                        <div class="row-item">
                            <span>符号类型</span>
                            <n-select style="width: 240px" v-model:value="state.selectedTypeId"
                                :options="state.symbolClassOptions" :focusable="false"/>
                        </div>

                        <div class="row-item no-center">
                            <span class="name">符号库</span>
                            <div class="icon-list-space" style="width: 240px">
                                <n-scrollbar style="max-height: 160px">
                                    <div style="display: flex;flex-wrap: wrap;">
                                        <div v-for="(model, index) in state.symbolOptionsList.data"
                                            :class="model.isSelect ? 'selected-img' : 'normal-img'"
                                            style="width: 50px; height: 50px; margin: 5px 12px">
                                            <img :key="index" :src="model.thumbnail" :title="model.name"
                                                v-show="model.name" class="draw-img" @click="changleIconItem(model)"
                                                @dblclick="cancleIconItem(model)" />
                                        </div>
                                    </div>
                                </n-scrollbar>
                            </div>
                        </div>

                        <div class="row-item">
                            <span>添加模式</span>
                            <n-select v-model:value="state.addType" :options="state.addTypeOptions"
                                style="width: 240px"  :focusable="false"/>
                        </div>
                        <div class="row-item" v-if="state.addType === 'face'" style="margin-bottom: 3px;">
                            <span></span>
                            <n-checkbox v-model:checked="state.multiSelection"
                                style="margin-bottom: 10px;margin-right: 153px;" :focusable="false">
                                种类多选
                            </n-checkbox>
                        </div>


                        <div class="row-item" v-if="state.addType === 'line'">
                            <span>间隔</span>
                            <n-input-number v-model:value="state.space" style="width: 240px"
                                :min="0.1"  :focusable="false">
                                <template #suffix> 米 </template>
                            </n-input-number>
                        </div>

                        <div class="row-item" v-if="state.addType === 'face'">
                            <span>密度</span>
                            <n-input-number v-model:value="state.density" style="width: 240px" :min="0" :max="1"
                                :step="0.01"  :focusable="false">
                                <!-- <template #suffix> 平方米 </template> -->
                            </n-input-number>
                        </div>

                        <div class="row-item" style="margin-right: 10px" v-show="state.selectedTypeId == 0">
                            <span>随机大小</span>
                            <div class="check-content">
                                <n-checkbox v-model:checked="state.isRandomScale" :focusable="false"
                                    style="margin-left: -12px;margin-right: 13px;"></n-checkbox>
                                <div class="slider-box">
                                    <span :class="state.isRandomScale ? 'normal-text' : 'disabled-text'">{{ state.scaleRange[0] }}</span>
                                    <span :class="state.isRandomScale ? 'normal-text' : 'disabled-text'" style="position: relative;left: 170px;">{{ state.scaleRange[1] }}</span>
                                    <n-slider style="width: 150px;margin-right: 20px;padding: 0 2px;" v-model:value="state.scaleRange" :step="0.1" range :min="0.1" :max="5.0" :disabled="!state.isRandomScale" />
                                </div>
                            </div>
                        </div>

                        <div class="row-item" style="margin-right: 10px" v-show="state.selectedTypeId == 0">
                            <span>随机角度</span>
                            <div class="check-content">
                                <n-checkbox v-model:checked="state.isRandomRotate" :focusable="false"
                                    style="margin-left: -12px;margin-right: 13px;"></n-checkbox>
                                <div class="slider-box" style="width: 190px;">
                                    <span :class="state.isRandomRotate ? 'normal-text' : 'disabled-text'">{{ state.rotateRange[0] }}</span>
                                    <span :class="state.isRandomRotate ? 'normal-text' : 'disabled-text'" style="position: relative;left: 150px;">{{ state.rotateRange[1] }}</span>
                                    <n-slider style="width: 150px;margin-right: 30px;margin-left: -20px;" v-model:value="state.rotateRange" :step="1" range :min="1" :max="360" :disabled="!state.isRandomRotate" />
                                </div>
                            </div>
                        </div>


                        <div class="row-item">
                            <span>符号编辑</span>
                            <n-checkbox v-model:checked="state.openDrag" style="margin-bottom: 10px;margin-left: -24px;"
                                :focusable="false">
                                任意拖拽
                            </n-checkbox>
                            <n-checkbox v-model:checked="state.selectDel" style="margin-bottom: 10px"
                                :focusable="false">
                                点选删除
                            </n-checkbox>
                        </div>

                        <span style="font-size: 14px; color: rgba(255, 255, 255, 0.85); position: relative; top: -75px;">小品列表</span>
                        <div class="icon-list-space"
                            style="margin-left: 100px; margin-bottom: 10px; margin-top: -130px;">
                            <n-scrollbar x-scrollable style="max-height:360px" trigger="none">
                                <n-tree 
                                    style="width: 230px;" 
                                    block-line 
                                    :data="treeData" 
                                    :render-suffix="renderSuffix"
                                    :node-props="nodeProps" 
                                    :default-expanded-keys="['0','2','3']"
                                />
                            </n-scrollbar>
                        </div>
                    </n-scrollbar>
                    
                    <div class="btn-row-item" style="margin-left: 100px; margin-top: -60px;">
                        <n-button type="info" color="#3499E5" text-color="#fff" :focusable="false" @click="add"
                            style="margin-right: 10px">绘制</n-button>
                        <n-button :focusable="false" text-color="#fff" @click="finishAllDraw">结束</n-button>
                    </div>
                </n-config-provider>

            </div>
        </div>
    </div>
    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>
    <script type="module">
        import DrawHandler from "./js/addSymbols/drawHandler.js";
        import AddSymbol from "./js/addSymbols/draw-skit.js";
        import DragTool from "./js/addSymbols/drag-tool.js";
        import MouseTip from "./js/addSymbols/mouseTip.js";
        import SymbolOptions from "./js/addSymbols/symbolOptions.js";

        function onload(SuperMap3D) {
            const viewer = new SuperMap3D.Viewer('Container', {
                timeline: true,
                infoBox: false, 
                contextOptions: {
                    contextType: Number(2)  // Webgl2:2 ; WebGPU:3
                }
            });

            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer, undefined);
            });
        }

        async function init(SuperMap3D, scene, viewer) {
            window.viewer = viewer; // 必须将viewer绑在window上以便导入的模块能全局访问
            viewer.resolutionScale = window.devicePixelRatio;

            // 加载高德影像地图
            viewer.imageryLayers.addImageryProvider(new SuperMap3D.UrlTemplateImageryProvider({
                url: 'https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                minimumLevel: 3,
                maximumLevel: 18,
            }));

            // 已保存的小品列表json文件
            await SuperMap3D.loadJson('./js/addSymbols/all-skit.json').then(function (data) {
                if(!data) return;
                window.jsonTreeData = data;
            });

            // 打开场景
            const promise = scene.open(URL_CONFIG.SCENE_BIMBUILDING);
            promise.then(function (layers) {
                document.getElementById('loadingbar').style.display = 'none';
                document.getElementById('add-symbol-container').style.display = 'block';

                // 初始化Vue组件
                initVueComponents(scene, viewer);
            })
        }


        // 初始化Vue组件
        function initVueComponents(scene, viewer) {
            // 对象解构
            const { h, ref, reactive, watch } = Vue;
            const { NButton,darkTheme,useMessage } = naive;

            const defaulModelUrl = "./data/s3mLibrary/newTree/001_Platanus.s3mb";
            const addTypeOptions_tree = [
                {
                    label: () => '单个添加',
                    value: "single",
                },
                {
                    label: () => '沿线添加',
                    value: "line",
                },
                {
                    label: () => '区域添加',
                    value: "face",
                },
            ];
            const addTypeOptions_other = [
                {
                    label: () => '单个添加',
                    value: "single",
                },
                {
                    label: () => '沿线添加',
                    value: "line",
                }
            ];

            // 初始化变量
            const state = reactive({
                selectedTypeId: 0,
                space: 10,
                density: 0.1,
                addType: "single",
                currentModelUrl: defaulModelUrl,
                currentModelUrlArray: [defaulModelUrl],
                symbolClassOptions: [
                    {
                        label: () => '树木',
                        value: 0,
                    },
                    {
                        label: () => '公共设施',
                        value: 1,
                    },
                    {
                        label: () => '交通',
                        value: 2,
                    },
                ],
                addTypeOptions: addTypeOptions_tree,
                symbolOptionsList: SymbolOptions[0],
                multiSelection: false,
                delType: 1,
                scaleNumber: 1,
                rotateNumber: 1,
                openDrag: false,
                selectDel: false,
                isRandomScale: false,
                scaleRange: [1.0, 4.0],
                isRandomRotate: false,
                rotateRange: [50, 300],
                isDrawing: false,
            });


            // 树根目录结构
            const emptyRoot = [
                {
                    label: '全部小品',
                    key: '0',
                    children: [
                        {
                            label: '单个添加',
                            key: '1',
                            children: []
                        }, {
                            label: '沿线添加',
                            key: '2',
                            children: []
                        }, {
                            label: '区域添加',
                            key: '3',
                            children: []
                        }
                    ]
                }
            ]

            // 转为vue响应式对象
            const treeData = Vue.reactive(emptyRoot);

            // 符号添加器
            const addSymbol = new AddSymbol(viewer, {});

            // 点、线、面添加方式handler
            let handlerPolyline, handlerPolygon;
            const handlerPoint = new SuperMap3D.ScreenSpaceEventHandler(viewer.scene.canvas);

            // 绑定左键点选pick和右键结束绘制相关功能
            const handlerClick = new SuperMap3D.ScreenSpaceEventHandler(viewer.scene.canvas);

            // 鼠标移动提示相关
            const mouseTip = new MouseTip(document.body);
            const mouseTipHandler = new SuperMap3D.ScreenSpaceEventHandler(viewer.scene.canvas);

            // 需要支持移动的实体，其name必须包含'addSymbol'
            const dragtool = new DragTool({
                viewer: viewer,
                treeData: treeData,
                entityCanMoveNameString: 'addSymbol',
            });

            // 实例集合
            let selectInstance = undefined; // 当前选中的实例
            let instanceCollection_tree = new SuperMap3D.S3MInstanceCollection(viewer.scene._context);
            instanceCollection_tree.customID = 'plantTree';
            viewer.scene.primitives.add(instanceCollection_tree);

            // 打开之前保存过的jsonTree
            if(window.jsonTreeData) openJsonTree(window.jsonTreeData);

            // 初始化各类handler
            inithandler();
            function inithandler() {
                state.symbolOptionsList.data[0].isSelect = true;

                const panelContainer = document.getElementById('add-symbol-container'); // 当移动到面板位置的时候，关闭提示
                if (panelContainer) panelContainer.addEventListener('mousemove', () => { if (mouseTip) mouseTip.setVisible(false); });

                handlerClick.setInputAction((e) => { click_symbol(e) }, SuperMap3D.ScreenSpaceEventType.LEFT_CLICK);
                handlerClick.setInputAction((e) => { clickR_finish(e) }, SuperMap3D.ScreenSpaceEventType.RIGHT_CLICK);

                // 绑定鼠标移动提示事件
                if (mouseTipHandler) mouseTipHandler.setInputAction(e => {
                    let tipContent = computedMouseTipContent();
                    tipContent != '' ? mouseTip.showAt(e.endPosition, `<p>${tipContent}</p>`) : mouseTip.setVisible(false);
                }, SuperMap3D.ScreenSpaceEventType.MOUSE_MOVE);

                // 根据不同的情况计算鼠标的提示内容
                function computedMouseTipContent() {
                    if (state.openDrag) return '鼠标左键按下选中对象，鼠标移动拖动对象，鼠标左键弹起拖拽结束';
                    if (state.selectDel) return '左键点击实体即可删除';
                    if (!state.isDrawing) return '';

                    let addType = state.addType;
                    if (addType == 'single') {
                        return '点击左键添加实体，点击右键关闭添加';
                    } else if (addType == 'line') {
                        if (!handlerPolyline && !handlerPolyline.active) return '';
                        return handlerPolyline.positions.length <= 1 ? '点击左键添加线节点，点击右键结束绘制' : '点击左键继续添加节点，点击右键根据绘制线生成树实体';
                    } else if (addType == 'face') {
                        if (!handlerPolygon && !handlerPolygon.active) return '';
                        return handlerPolygon.positions.length <= 2 ? '点击左键添加面节点，点击右键结束绘制' : '点击左键继续添加节点，点击右键根据绘制面生成树实体';
                    }
                }
            }



            // 选择符号库
            function changleIconItem(item) {
                if (state.multiSelection) {
                    for (let i = 0; i < state.symbolOptionsList.data.length; i++) {
                        if (state.symbolOptionsList.data[i].id == item.id) {
                            state.symbolOptionsList.data[i].isSelect = true;
                        }
                    }
                    let itemIndex = state.currentModelUrlArray.indexOf(item.path);
                    if (itemIndex == -1) state.currentModelUrlArray.push(item.path);
                } else {
                    for (let i = 0; i < state.symbolOptionsList.data.length; i++) {
                        if (state.symbolOptionsList.data[i].id == item.id) {
                            state.symbolOptionsList.data[i].isSelect = true;
                        } else {
                            state.symbolOptionsList.data[i].isSelect = false;
                        }
                    }
                    state.currentModelUrl = item.path;
                    state.currentModelUrlArray = [item.path];
                }
            }

            // 取消所选符号
            function cancleIconItem(item) {
                if (state.multiSelection) {
                    for (let i = 0; i < state.symbolOptionsList.data.length; i++) {
                        if (state.symbolOptionsList.data[i].id == item.id) {
                            state.symbolOptionsList.data[i].isSelect = false;
                            let pathIndex = state.currentModelUrlArray.indexOf(item.path);
                            state.currentModelUrlArray.splice(pathIndex, 1);
                        }
                    }
                } else {
                    for (let i = 0; i < state.symbolOptionsList.data.length; i++) {
                        if (state.symbolOptionsList.data[i].id == item.id) {
                            state.symbolOptionsList.data[i].isSelect = false;
                            state.currentModelUrl = "";
                            state.currentModelUrlArray = [];
                        }
                    }
                }
            }

            // 取消所有选择的符号
            function cancleAllItem() {
                for (let i = 0; i < state.symbolOptionsList.data.length; i++) {
                    state.symbolOptionsList.data[i].isSelect = false;
                }
            }


            
            // 图层列表添加删除后缀
            function renderSuffix({ option }) {
                if (option.key && option.key.length >= 5) { // 单个项目
                    return h("div", {}, [
                        h(
                            NButton,
                            {
                                bordered: false,
                                text: true,
                                focusable: false,
                                title: '快速定位',
                                onClick: () => {
                                    instenceLocate(option);
                                },
                            },
                            {
                                icon: () => h("i", { class: "iconfont icondingwei", style: "color: rgba(255,255,255,0.65)" }, "")
                            }
                        ),
                        h(
                            NButton,
                            {
                                bordered: false,
                                text: true,
                                focusable: false,
                                title: '移除',
                                onClick: () => {
                                    removeTreeOption(option);
                                },
                            },
                            {
                                icon: () => h("i", { class: "iconfont iconshanchu", style: "color: #DC5849" }, "")
                            }
                        )
                    ]);
                } else if (option.key && option.children.length > 0 && option.key != '0') { // 集合
                    return h("div", {}, [
                        h(
                            NButton,
                            {
                                bordered: false,
                                text: true,
                                focusable: false,
                                title: '移除',
                                onClick: () => {
                                    removeTreeOption(option);
                                },
                            },
                            {
                                icon: () => h("i", { class: "iconfont iconshanchu", style: "color: #DC5849" }, "")
                            }
                        )
                    ]);
                } else if (option.key && option.key == '0') { // 根目录
                    return h("div", {}, [
                        h(
                            NButton,
                            {
                                bordered: false,
                                text: true,
                                focusable: false,
                                title: '移除所有小品',
                                onClick: () => {
                                    clearAllTree();
                                },
                            },
                            {
                                icon: () => h("i", { class: "iconfont iconshanchu", style: "color: #DC5849" }, "")
                            }
                        ),
                        h(
                            NButton,
                            {
                                bordered: false,
                                text: true,
                                focusable: false,
                                title: '导入小品资源JSON文件',
                                onClick: () => {
                                    openFile();
                                },
                            },
                            {
                                icon: () => h("i", { class: "iconfont icondaoru", style: "color: rgba(255,255,255,0.65)" }, "")
                            }
                        ),
                        h(
                            NButton,
                            {
                                bordered: false,
                                text: true,
                                focusable: false,
                                title: '导出小品资源JSON文件',
                                onClick: () => {
                                    downLoadTree();
                                },
                            },
                            {
                                icon: () => h("i", { class: "iconfont icondaochu", style: "color: rgba(255,255,255,0.65)" }, "")
                            }
                        )
                    ]
                    );
                }
            }

            // 删除实例
            function removeTreeOption(option) {
                if (!instanceCollection_tree) {
                    viewer.scene.primitives._primitives.forEach(primitive => {
                        if (primitive.customID && primitive.customID == "plantTree") {
                            instanceCollection_tree = primitive;
                        }
                    })
                    if (!instanceCollection_tree) return;
                };
                if (option.key == '0') { // 删除所有：clearAllTree()
                } else if (option.key == '1') { // 删除所有点添加
                    option.children.forEach(node => {
                        instanceCollection_tree.removeInstance(node.url, [node.options.id]);
                    })
                    treeData[0].children[0].children = [];
                } else if (option.key == '2') { // 删除所有线添加
                    option.children.forEach(nodes => {
                        nodes.children.forEach(node => {
                            instanceCollection_tree.removeInstance(node.url, [node.options.id]);
                        })
                    })
                    treeData[0].children[1].children = [];
                } else if (option.key == '3') { // 删除所有面添加
                    option.children.forEach(nodes => {
                        nodes.children.forEach(node => {
                            instanceCollection_tree.removeInstance(node.url, [node.options.id]);
                        })
                    })
                    treeData[0].children[2].children = [];
                } else if (option.type == 'polylineGroup') { // 删除线集合
                    option.children.forEach(node => {
                        instanceCollection_tree.removeInstance(node.url, [node.options.id]);
                    })
                    let targetGroup = treeData[0].children[1];
                    delTarget(targetGroup, option);
                } else if (option.type == 'polygonGroup') { // 删除面集合
                    option.children.forEach(node => {
                        instanceCollection_tree.removeInstance(node.url, [node.options.id]);
                    })
                    let targetGroup = treeData[0].children[2];
                    delTarget(targetGroup, option);
                } else {
                    instanceCollection_tree.removeInstance(option.url, [option.options.id]); // 单个删除
                    if (option.type == 'point') { // 点集合中
                        let targetGroup = treeData[0].children[0];
                        delTarget(targetGroup, option);
                    } else if (option.type == 'polyline') { // 线集合中
                        let lineAddNodes = treeData[0].children[1].children;
                        let targetGroup = lineAddNodes.find(item => item.key == option.parentKey);
                        delTarget(targetGroup, option);
                    } else if (option.type == 'polygon') { // 面集合中
                        let polygonAddNodes = treeData[0].children[2].children;
                        let targetGroup = polygonAddNodes.find(item => item.key == option.parentKey);
                        delTarget(targetGroup, option);
                    }
                }

                function delTarget(targetGroup, option) {
                    let delTarget = undefined;
                    targetGroup.children.map((node, index) => {
                        if (node.key == option.key) {
                            delTarget = targetGroup.children.splice(index, 1);
                        }
                    })
                    return delTarget;
                }
            }

            // 定位实例
            function instenceLocate(option) {
                let BoundingSphere = new SuperMap3D.BoundingSphere(option.options.position, 5);
                viewer.camera.flyToBoundingSphere(BoundingSphere, {
                    duration: 0.5
                });
            }

            // 将添加的树小品保存为本地json文件
            function downLoadTree() {
                const camera_tree = getCamera();
                const SaveTime = getTime();
                const treeOptions = { TreeGroup: treeData };
                const treeJsonData = {
                    Camera: camera_tree,
                    SaveTime: SaveTime,
                    SkitTreeCollection: treeOptions
                }

                console.log("保存的小品JSON:", treeJsonData);

                saveAsJson(JSON.stringify(treeJsonData), '全部小品'); // 保存为json存到本地
                setTimeout(() => {
                    alert('小品保存成功');
                }, 1000);

                // 获取当前相机位置
                function getCamera() {
                    let camera = viewer.scene.camera;
                    let curCamera = {
                        position: {
                            x: camera.positionWC.x,
                            y: camera.positionWC.y,
                            z: camera.positionWC.z,
                        },
                        heading: camera.heading,
                        pitch: camera.pitch,
                        roll: camera.roll,
                        positionCartographic: camera.positionCartographic, //供平面场景（哥伦布视图）下使用
                    };
                    return curCamera;
                }

                // 获取当前时间当作保存时间
                function getTime() {
                    let nowData = new Date();
                    return `${nowData.toLocaleDateString()}-${nowData.toLocaleTimeString()}`;
                }

                // 将JS对象转为JSON保存到本地
                function saveAsJson(str, fileName) {
                    const blob = new Blob([str], { type: "application/json;charset=utf-8" });
                    const href = URL.createObjectURL(blob);
                    const alink = document.createElement("a");
                    alink.style.display = "none";
                    alink.download = `${fileName}.json`; // 下载后文件名
                    alink.href = href;
                    document.body.appendChild(alink);
                    alink.click();
                    document.body.removeChild(alink); // 下载完成移除元素
                    URL.revokeObjectURL(href); // 释放掉blob对象
                }
            }

            // 导入已保存的小品json并添加到场景中（入口） - 通过创建input来读取本地json文件
            function openFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.style.display = 'none';
                input.accept = '.json';

                document.body.appendChild(input);

                input.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const jsonData = JSON.parse(e.target.result);
                        if (!jsonData) return;

                        clearAllTree(); // 清除上一次的树

                        openJsonTree(jsonData); // 往场景中添加json内容
                    };

                    reader.readAsText(file);
                });

                input.click();


            
            }

            // 根据传入的json数据往场景中添加内容
            function openJsonTree(jsonData){
                if(!jsonData || !jsonData.Camera || !jsonData.SkitTreeCollection) return;

                if (jsonData.Camera) openCamera(jsonData.Camera); // 设置相机位置

                if (jsonData.SkitTreeCollection) {
                    console.log('导入的小品JSON:', jsonData.SkitTreeCollection);
                    // 先处理JSON中的种树数据，转换成符合iEarth规范的类型
                    let treeDataHandled = handleTreeData(jsonData.SkitTreeCollection);
                    // 遍历种树：使用处理好合规的数据
                    setSkitTreeCollection(treeDataHandled); 
                    treeData[0] = treeDataHandled.TreeGroup[0];
                }


                // 定位相机
                function openCamera(curCamera) {
                    let cameraX = curCamera.position.x;
                    let cameraY = curCamera.position.y;
                    let cameraZ = curCamera.position.z;
                    viewer.scene.camera.setView({
                        destination: new SuperMap3D.Cartesian3(cameraX, cameraY, cameraZ),
                        orientation: {
                            heading: curCamera.heading,
                            pitch: curCamera.pitch,
                            roll: curCamera.roll
                        }
                    });
                }

                // 处理原始JSON数据，使其符合iEarth保存规范
                function handleTreeData(treeData) {
                    let isEarthSave = treeData.isEarthSave;
                    let treeDataChild = treeData.TreeGroup[0].children;

                    // 合规：图层树的option里面的key等涉及索引相关内容必须基于intanceID生成（参考:drawSkit.vue->addItemToTree()）

                    // iEarth保存过的，符合规范，只需要检查有无空数组即可
                    if (isEarthSave) {
                        // 校验当前图层树是否存在空数组,如果有直接删除
                        treeDataChild.forEach((nodes) => { // 单个添加不用管，空数组重点是处理沿线和区域添加的
                            if (nodes.label === '沿线添加') {
                                nodes.children.forEach((polylineGroup) => {
                                    if (polylineGroup.children == 0) removeTargetOption(nodes, polylineGroup);
                                })
                            } else if (nodes.label === '区域添加') {
                                nodes.children.forEach((polygonGroup) => {
                                    if (polygonGroup.children == 0) removeTargetOption(nodes, polygonGroup);
                                })
                            }
                        })
                    } else { // 处理历史版本：主要是处理每个option的key、id、parentKey以及label、name，将其转换成iEarth规范（只要是导入iEarth的种树JSON都会转换成合规的）
                        treeDataChild.forEach((nodes) => {
                            if (nodes.label === '单个添加') {
                                nodes.children.forEach((pointItem, index) => {
                                    const currentIndex = index + 1; // 从1开始，避免出现0
                                    if (pointItem && pointItem.url && pointItem.options) {
                                        pointItem.key = `1-0-${currentIndex}`;
                                        pointItem.label = `point-${currentIndex}`;
                                        pointItem.type = "point";
                                        pointItem.options.id = `point-${currentIndex}-addSymbol`;
                                    } else {
                                        console.log('异常数据:', pointItem); // 剔除JSON中的异常数据
                                        removeTargetOption(nodes, pointItem);
                                    }
                                })
                            } else if (nodes.label === '沿线添加') {
                                nodes.children.forEach((polylineGroup, index) => {
                                    const currentIndex = index + 1;
                                    if (polylineGroup.children == 0) removeTargetOption(nodes, polylineGroup);
                                    polylineGroup.key = `2-${currentIndex}`;
                                    polylineGroup.label = `线集合-${currentIndex}`;
                                    polylineGroup.name = `polyline-${currentIndex}`;
                                    polylineGroup.type = `polylineGroup`;
                                    polylineGroup.children.forEach((child, index_child) => {
                                        if (child && child.url && child.options) {
                                            const keySame = `${currentIndex}-${index_child}`;
                                            child.key = `2-${keySame}`;
                                            child.label = `line-${keySame}`;
                                            child.parentKey = `2-${currentIndex}`;
                                            child.type = "polyline";
                                            child.options.id = `polyline-${keySame}-addSymbol`;
                                        } else {
                                            console.log('异常数据:', child); // 剔除JSON中的异常数据
                                            removeTargetOption(polylineGroup, child);
                                        }
                                    })
                                })
                            } else if (nodes.label === '区域添加') {
                                nodes.children.forEach((polygonGroup, index) => {
                                    const currentIndex = index + 1;
                                    if (polygonGroup.children == 0) removeTargetOption(nodes, polygonGroup);
                                    polygonGroup.key = `3-${currentIndex}`;
                                    polygonGroup.label = `面集合-${currentIndex}`;
                                    polygonGroup.name = `face-${currentIndex}`;
                                    polygonGroup.type = `polygonGroup`;
                                    polygonGroup.children.forEach((child, index_child) => {
                                        if (child && child.url && child.options) {
                                            const keySame = `${currentIndex}-${index_child}`;
                                            child.key = `3-${keySame}`;
                                            child.label = `face-${keySame}`;
                                            child.parentKey = `3-${currentIndex}`;
                                            child.type = "polygon";
                                            child.options.id = `polygon-${keySame}-addSymbol`;
                                        } else {
                                            console.log('异常数据:', child); // 剔除JSON中的异常数据
                                            removeTargetOption(polygonGroup, child);
                                        }
                                    })
                                })
                            }
                        })
                    }

                    return treeData;

                    // 删除数组中指定option
                    function removeTargetOption(targetParent, targetOption) {
                        targetParent.children.map((node, index) => {
                            if (node.key == targetOption.key) {
                                targetParent.children.splice(index, 1);
                            }
                        })
                    }
                }

                // 根据传入JSON，遍历种树
                function setSkitTreeCollection(treeData) {
                    if (!instanceCollection_tree) return;
                    growTreeByJSON(treeData.TreeGroup[0].children, instanceCollection_tree);
                }

                // 根据传入的数据来种树
                function growTreeByJSON(treeDataChild, instanceCollection) {
                    treeDataChild.forEach((nodes) => {
                        if (nodes.label === '单个添加') {
                            // 遍历点
                            nodes.children.forEach((pointItem) => {
                                if (pointItem && pointItem.url && pointItem.options) {
                                    instanceCollection.add(pointItem.url, pointItem.options);
                                }
                            })
                        } else if (nodes.label === '沿线添加') {
                            // 遍历线进行添加
                            nodes.children.forEach((polylineGroup) => {
                                if (polylineGroup.children.length > 0) {
                                    polylineGroup.children.forEach((polylineItem) => {
                                        if (polylineItem && polylineItem.url && polylineItem.options) {
                                            instanceCollection.add(polylineItem.url, polylineItem.options)
                                        }
                                    })
                                }
                            })
                        } else if (nodes.label === '区域添加') {
                            // 遍历面进行添加
                            nodes.children.forEach((polygonGroup) => {
                                if (polygonGroup.children.length > 0) {
                                    polygonGroup.children.forEach((polygonItem) => {
                                        if (polygonItem && polygonItem.url && polygonItem.options) {
                                            instanceCollection.add(polygonItem.url, polygonItem.options)
                                        }
                                    })
                                }
                            })
                        }
                    })
                }
            
            }



            // 左键控制选中或者添加d
            async function click_symbol(e) {

                // 绘制模式下关闭点选
                if (state.isDrawing) return;

                // 拾取到选中的实体
                let symbol = await viewer.scene.pickAsync(e.position) || viewer.selectedEntity;
                if (symbol && symbol.primitive && symbol.id && typeof symbol.id == 'string' && symbol.id.includes('addSymbol')) { // instanceID中含有addSymbol才是我们的种的树
                    selectInstance = symbol.primitive;
                } else {
                    selectInstance = undefined;
                    dragtool.closeModelEditor(); // 关闭编辑框
                    return;
                }

                if (state.openDrag || state.selectDel) { // 编辑模式下禁止开启模型编辑器：拖拽+点选
                    dragtool.closeModelEditor();
                } else {
                    dragtool.openModelEditor(selectInstance); // 开启编辑框
                }

                // 点选删除
                if (state.selectDel) {
                    clearSelectTree();
                }
            }

            // 右键结束添加，恢复之前状态
            function clickR_finish() {
                // 处理点添加
                if (handlerPoint) handlerPoint.removeInputAction(SuperMap3D.ScreenSpaceEventType.LEFT_CLICK);
                if (state.addType == 'single') {
                    state.isDrawing = false;
                    if (mouseTip) mouseTip.setVisible(false);
                }

                // 处理线添加
                if (handlerPolyline && handlerPolyline.active) { // 当前handle处于活跃状态
                    if (handlerPolyline.positions.length <= 1) { // 活跃状态但未绘制或者只绘制添加了一个点，就点击右键了，此次绘制销毁。
                        handlerPolyline.clearHandler();
                        handlerPolyline.destroy();
                        handlerPolyline = null;
                        state.isDrawing = false;
                        if (mouseTip) mouseTip.setVisible(false);
                    }
                }

                // 处理面添加
                if (handlerPolygon && handlerPolygon.active) { // 当前handle处于活跃状态
                    if (handlerPolygon.positions.length <= 2) { // 活跃状态但未绘制或者只绘制添加了一个点，就点击右键了，此次绘制销毁。
                        handlerPolygon.clearHandler();
                        handlerPolygon.destroy();
                        handlerPolygon = null;
                        state.isDrawing = false;
                        if (mouseTip) mouseTip.setVisible(false);
                    }
                }

                // 恢复鼠标样式
                viewer.enableCursorStyle = true;
                document.body.classList.remove("measureCur");
                document.body.classList.remove('drawCur');
            }

            // 结束当前所有绘制
            function finishAllDraw() {
                if (handlerPoint) handlerPoint.removeInputAction(SuperMap3D.ScreenSpaceEventType.LEFT_CLICK);

                if (handlerPolyline) {
                    handlerPolyline.clearHandler();
                    handlerPolyline.destroy();
                    handlerPolyline = null;
                }

                if (handlerPolygon) {
                    handlerPolygon.clearHandler();
                    handlerPolygon.destroy();
                    handlerPolygon = null;
                }

                state.isDrawing = false;

                // 恢复鼠标样式
                viewer.enableCursorStyle = true;
                document.body.classList.remove("measureCur");
                document.body.classList.remove('drawCur');
            }




            // 计算当前索引值（基于当前图层树数据）
            function computedCurrentIndex(type) {
                let index = -1;
                if (type == 'point') {
                    index = 0;
                } else if (type == 'polylineGroup') {
                    index = 1;
                } else if (type == 'polygonGroup') {
                    index = 2;
                }
                if (index == -1) return;
                let targetList = treeData[0].children[index].children;
                let lastOne = targetList[targetList.length - 1];
                if (lastOne) {
                    let cusIndex = lastOne.label.split('-')[1];
                    return Number(cusIndex) + 1;
                } else {
                    return 1;
                }
            }

            // 向图层列表中添加项目
            function addItemToTree(item, type) {
                if (!item) return;
                if (type == 'point') { // 添加点集合
                    let instanceID = item.options.id;
                    let keyIndex = instanceID.split('-')[1];
                    item.label = instanceID.replace('-addSymbol', '');
                    item.type = type;
                    item.key = `1-0-${keyIndex}`;
                    treeData[0].children[0].children.push(item);
                } else if (type == 'polylineGroup') {
                    if (item.length <= 1) return; // 场景中未成功添加实例
                    let currentIndex = item[item.length - 1];
                    let group = {
                        label: `线集合-${currentIndex}`,
                        name: `polyline-${currentIndex}`,
                        key: `2-${currentIndex}`,
                        type: type,
                        children: []
                    }

                    item.forEach((node, index) => {
                        if (node && node.url) {
                            let instanceID = node.options.id;
                            let keyIndex = instanceID.split('-')[2];
                            node.label = instanceID.replace('-addSymbol', '').replace('poly', '');
                            node.type = 'polyline';
                            node.key = `${group.key}-${keyIndex}`;
                            node.parentKey = group.key;
                            group.children.push(node);
                        }
                    })

                    treeData[0].children[1].children.push(group);
                } else if (type == 'polygonGroup') {
                    if (item.length <= 1) return;
                    let currentIndex = item[item.length - 1];
                    let group = {
                        label: `面集合-${currentIndex}`,
                        name: `polygon-${currentIndex}`,
                        key: `3-${currentIndex}`,
                        type: type,
                        children: []
                    }

                    item.forEach((node, index) => {
                        if (node && node.url) {
                            let instanceID = node.options.id;
                            let keyIndex = instanceID.split('-')[2];
                            node.label = instanceID.replace('-addSymbol', '').replace('polygon', 'face');;
                            node.type = 'polygon';
                            node.key = `${group.key}-${keyIndex}`;
                            node.parentKey = group.key;
                            group.children.push(node);
                        }
                    })

                    treeData[0].children[2].children.push(group);
                }
            }




            // 添加
            function add() {
                state.openDrag = false; // 添加时，关闭拖拽
                state.selectDel = false; // 添加时，关闭点选删除
                dragtool.closeModelEditor(); // 关闭编辑框
                if (!instanceCollection_tree) return;
                if (state.currentModelUrl == "" || state.currentModelUrlArray.length == 0) {
                    alert('请选择符号');
                    return;
                }

                finishAllDraw(); // 绘制前先结束所有绘制

                state.isDrawing = true;
                switch (state.addType) {
                    case "single":
                        add_single();
                        break;
                    case "line":
                        add_line();
                        break;
                    case "face":
                        add_face();
                        break;
                    default:
                        add_single();
                        break;
                }
            }

            // 单个添加
            function add_single() {
                if (!handlerPoint) return;

                // 鼠标提示和样式
                viewer.enableCursorStyle = false;
                viewer._element.style.cursor = "";
                document.body.classList.add("measureCur");

                handlerPoint.setInputAction(e => {
                    viewer.scene.pickPositionAsync(e.position, new SuperMap3D.Cartesian3())
                        .then(position=>{
                            let path = state.currentModelUrl;
                            let currentIndex = computedCurrentIndex('point');
                            let pointID = `point-${currentIndex}-addSymbol`;
                            let point_option = addSymbol.addByPoint(path, position, pointID);
                            addItemToTree(point_option, 'point');
                        })
                }, SuperMap3D.ScreenSpaceEventType.LEFT_CLICK);
            }

            // 沿线添加
            function add_line() {
                if (!handlerPolyline) handlerPolyline = DrawHandler("Polyline");
                add_line_draw(handlerPolyline);
                function add_line_draw(handlerPolyline) {
                    if (!handlerPolyline) return;
                    handlerPolyline.handlerDrawing().then((res) => {
                        let path = state.currentModelUrl;
                        let currentIndex = computedCurrentIndex('polylineGroup');
                        let line_options_promise = addSymbol.addByline(path, res.object.positions, state.space, currentIndex);
                        line_options_promise.then(line_options => {
                            addItemToTree(line_options, 'polylineGroup');
                        })
                        handlerPolyline.polylineTransparent.show = false;
                        handlerPolyline.positions.length = 0;
                        add_line_draw(handlerPolyline); // 通过这种方式连续添加 (只有当该次绘制成功添加之后才可以)
                    },
                        (err) => {
                            console.log(err);
                        }
                    );
                    handlerPolyline.activate();
                }
            }

            // 区域添加
            function add_face() {
                if (!handlerPolygon) handlerPolygon = DrawHandler("Polygon");
                add_face_draw(handlerPolygon);
                function add_face_draw(handlerPolygon) {
                    if (!handlerPolygon) return;
                    handlerPolygon.handlerDrawing().then((res) => {
                        let path = state.currentModelUrlArray;
                        let area = getArea(res.object.positions);
                        let count = Math.floor(area) * Number(state.density);
                        let currentIndex = computedCurrentIndex('polygonGroup');
                        let polygon_options = addSymbol.addByFace(path, res.object.positions, Math.floor(count), currentIndex);
                        addItemToTree(polygon_options, 'polygonGroup');
                        handlerPolygon.polylineTransparent.show = false;

                        handlerPolygon.positions.length = 0;
                        add_face_draw(handlerPolygon); // 通过这种方式连续添加 (只有当该次绘制成功添加之后才可以)
                    },
                        (err) => {
                            console.log(err);
                        }
                    );
                    handlerPolygon.activate();
                }

                // 根据传入的点计算多边形面积：[Cartesian3]
                function getArea(points) {
                    let res = 0;
                    //拆分三角曲面

                    for (let i = 0; i < points.length - 2; i++) {
                        let j = (i + 1) % points.length;
                        let k = (i + 2) % points.length;
                        let totalAngle = Angle(points[i], points[j], points[k]);

                        let dis_temp1 = distance(points[j], points[0]);
                        let dis_temp2 = distance(points[k], points[0]);
                        res += dis_temp1 * dis_temp2 * Math.sin(totalAngle) / 2;
                    }

                    res = Math.abs(res).toFixed(4);
                    return res;

                    // 方向
                    function Bearing(from, to) {
                        from = SuperMap3D.Cartographic.fromCartesian(from);
                        to = SuperMap3D.Cartographic.fromCartesian(to);

                        let lat1 = from.latitude;
                        let lon1 = from.longitude;
                        let lat2 = to.latitude;
                        let lon2 = to.longitude;
                        let angle = -Math.atan2(Math.sin(lon1 - lon2) * Math.cos(lat2), Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon1 - lon2));
                        if (angle < 0) {
                            angle += Math.PI * 2.0;
                        }
                        let degreesPerRadian = 180.0 / Math.PI; //弧度转化为角度

                        angle = angle * degreesPerRadian; //角度
                        return angle;
                    }

                    // 角度
                    function Angle(p1, p2, p3) {
                        let bearing21 = Bearing(p2, p1);
                        let bearing23 = Bearing(p2, p3);
                        let angle = bearing21 - bearing23;
                        if (angle < 0) {
                            angle += 360;
                        }
                        return angle;
                    }

                    // 距离
                    function distance(point1, point2) {
                        let point1cartographic = SuperMap3D.Cartographic.fromCartesian(point1);
                        let point2cartographic = SuperMap3D.Cartographic.fromCartesian(point2);
                        /**根据经纬度计算出距离**/
                        let geodesic = new SuperMap3D.EllipsoidGeodesic();
                        geodesic.setEndPoints(point1cartographic, point2cartographic);
                        let s = geodesic.surfaceDistance;
                        //返回两点之间的距离
                        s = Math.sqrt(Math.pow(s, 2) + Math.pow(point2cartographic.height - point1cartographic.height, 2));
                        return s;
                    }

                };
            }



            // 专门用来删除点选选中的树
            function clearSelectOption(selectInstance) {
                if (!selectInstance.id) return;
                let treeDataList = treeData[0].children;
                let instanceID = selectInstance.id;
                let idList = instanceID.split('-'); // instance中的ID里面可以直接生成其在图层列表中对应的parentKey，因为他们都是基于currentIndex生成的
                let type = idList[0];
                let target = undefined;
                if (type == 'point') {  // 点集合
                    target = treeDataList[0].children.find((child) => {
                        if (child.options && child.options.id) {
                            return instanceID === child.options.id;
                        }
                    })
                    if (target) removeTargetOption(treeDataList[0], target);
                } else if (type == 'polyline') { // 线集合
                    let parentKey = `2-${idList[1]}`;
                    treeDataList[1].children.forEach((node) => {
                        if (node.key == parentKey) {
                            target = node.children.find((child) => {
                                if (child.options && child.options.id) {
                                    return instanceID === child.options.id;
                                }
                            })
                            if (target) removeTargetOption(node, target);
                        }
                    })
                } else if (type == 'polygon') { // 面集合
                    let parentKey = `3-${idList[1]}`;
                    treeDataList[2].children.forEach((node) => {
                        if (node.key == parentKey) {
                            target = node.children.find((child) => {
                                if (child.options && child.options.id) {
                                    return instanceID === child.options.id;
                                }
                            })
                            if (target) removeTargetOption(node, target);
                        }
                    })
                }

                return target;

                // 删除数组中指定option
                function removeTargetOption(targetParent, targetOption) {
                    targetParent.children.map((node, index) => {
                        if (node.key == targetOption.key) {
                            targetParent.children.splice(index, 1);
                        }
                    })
                }
            }

            // 清除所有
            function clearAllTree() {
                finishAllDraw();
                addSymbol.destroy(); // 需要调用他的destroy方法，主要是重置this.instanceCollection = null；避免该对象销毁后仍然调用
                selectInstance = undefined;

                state.isRandomScale = false;
                state.isRandomRotate = false;

                if (dragtool) dragtool.cancelDrag();
                state.openDrag = false;
                state.selectDel = false;

                // 清空图层列表
                treeData[0].children[0].children = [];
                treeData[0].children[1].children = [];
                treeData[0].children[2].children = [];

                if (handlerPolyline) handlerPolyline.clearHandler();
                if (handlerPolygon) handlerPolygon.clearHandler();

                // 当点击全部删除时，删除InstanceCollection
                if (instanceCollection_tree) viewer.scene.primitives.remove(instanceCollection_tree);
                instanceCollection_tree = null;
                instanceCollection_tree = new SuperMap3D.S3MInstanceCollection(viewer.scene._context);
                instanceCollection_tree.selectedColor = SuperMap3D.Color.GOLD; // 没效果
                instanceCollection_tree.customID = 'plantTree';
                viewer.scene.primitives.add(instanceCollection_tree);
            }

            // 清除选中的
            function clearSelectTree() {
                if (selectInstance && instanceCollection_tree) {
                    // 删除图层列表中的树
                    let targetOption = clearSelectOption(selectInstance);
                    if (!targetOption || !targetOption.url) return;
                    let instanceUrl = targetOption.url;

                    // 删除场景中的树
                    instanceCollection_tree.removeInstance(instanceUrl, [selectInstance.id]);
                }
            }



            // 自定义点击事件
            function nodeProps({ option }) {
                return {
                    onClick() {
                        console.log('node-props:', option);
                    }
                }
            }


            // 重写主题样式
            const overridesTheme = {
                common: {
                    primaryColor: "rgba(52, 153, 229, 1)",
                    primaryColorHover: "rgba(52, 153, 229, 1)",
                    primaryColorPressed: "rgba(255,255,255,0.85)",
                    primaryColorSuppl: "rgba(255,255,255,0.45)",
                },
                Button: {
                    fontSizeMedium: "14px", // 底部操作按钮：宽高和文字大小自适应浏览器
                    textColor: "rgba(255,255,255,0.65)", // 设置默认n-button全局样式
                    border: "1px solid rgba(255,255,255,0.65)",
                    textColorHover: "#5EB7F2",
                    borderHover: "1px solid #5EB7F2",
                    textColorPressed: "#2276BF",
                    borderPressed: "1px solid #2276BF",
                },
                Tabs: {
                    barColor: "#3499e5", // tabs底部横条颜色
                    tabFontSizeMedium: "14px", // tabs标签文字大小 - 兼容移动端样式
                },
                ColorPicker: {
                    border: "none", // color-pick颜色条去掉边框
                },
                Divider: {
                    color: "rgba(255, 255, 255, 0.15)", // 分割条颜色
                },
                Checkbox: {
                    colorChecked: "#3499E5",
                    checkMarkColor: "#fff",
                },
                Slider: {
                    fillColor: "#3499E5",
                    fillColorHover: "#3499E5",
                    handleSize: "12px",
                },
                Switch: {
                    railColorActive: "#3499E5",
                },
                Select: {
                    color:"rgba(255, 255, 255, 0.15)"
                }
            };

            // 创建Vue
            const App = {
                setup() {
                    // 符号类型
                    watch(
                        () => state.selectedTypeId,
                        (val) => {
                            cancleAllItem();
                            switch (val) {
                                case 0:
                                    state.symbolOptionsList = SymbolOptions[0];
                                    state.symbolOptionsList.data[0].isSelect = true;
                                    state.currentModelUrl = SymbolOptions[0].data[0].path;
                                    state.currentModelUrlArray = [SymbolOptions[0].data[0].path];
                                    state.addTypeOptions = addTypeOptions_tree;
                                    state.addType = "single";
                                    break;
                                case 1:
                                    state.symbolOptionsList = SymbolOptions[1];
                                    state.symbolOptionsList.data[0].isSelect = true;
                                    state.currentModelUrl = SymbolOptions[1].data[0].path;
                                    state.addTypeOptions = addTypeOptions_other;
                                    state.addType = "single";
                                    break;
                                case 2:
                                    state.symbolOptionsList = SymbolOptions[2];
                                    state.symbolOptionsList.data[0].isSelect = true;
                                    state.currentModelUrl = SymbolOptions[2].data[0].path;
                                    state.addTypeOptions = addTypeOptions_other;
                                    state.addType = "single";
                                    break;
                                default:
                                    break;
                            }
                        }
                    );
                    
                    // 添加类型
                    watch(
                        () => state.addType,
                        () => {
                            finishAllDraw();
                            state.isDrawing = false;
                            state.multiSelection = false;
                        }
                    );
                    // 多选
                    watch(
                        () => state.multiSelection,
                        (val) => {
                            if (!val) {
                                for (let i = 0; i < state.symbolOptionsList.data.length; i++) {
                                    state.symbolOptionsList.data[i].isSelect = false;
                                }
                                state.currentModelUrlArray = [defaulModelUrl];
                                state.currentModelUrl = [defaulModelUrl]
                                state.symbolOptionsList.data[0].isSelect = true;
                            }
                        }
                    );

                    // 符号编辑
                    watch(
                        () => state.openDrag,
                        (val) => {
                            if (val) {
                                finishAllDraw();
                                state.selectDel = false; //拖拽和点选暂不同时开启
                                dragtool.closeModelEditor(); // 关闭编辑框
                                dragtool.startDrag();
                                console.log('开启任意拖拽'); // alert
                            } else {
                                dragtool.cancelDrag();
                                console.log('关闭任意拖拽'); // alert
                            }
                        }
                    );
                    watch(
                        () => state.selectDel,
                        (val) => {
                            if (val) {
                                finishAllDraw();
                                state.openDrag = false; //拖拽和点选暂不同时开启
                                dragtool.closeModelEditor(); // 关闭编辑框
                                console.log('开启点选删除'); // alert
                            } else {
                                console.log('关闭点选删除'); // alert
                            }
                        }
                    );

                    // 随机大小角度
                    watch(
                        () => state.isRandomScale,
                        (val) => {
                            val ? addSymbol.updateScaleRange(state.scaleRange) : addSymbol.updateScaleRange([1, 1]);
                        }
                    );
                    watch(
                        () => state.scaleRange,
                        (val) => {
                            if (val) addSymbol.updateScaleRange(val);
                        }
                    );
                    watch(
                        () => state.isRandomRotate,
                        (val) => {
                            val ? addSymbol.updateRotateRange(state.rotateRange) : addSymbol.updateRotateRange([1, 1]);
                        }
                    );
                    watch(
                        () => state.rotateRange,
                        (val) => {
                            if (val) addSymbol.updateRotateRange(val);
                        }
                    );

                    return {
                        state,
                        treeData,
                        defaultExpandedKeys: ['1', '2', '3'],
                        overridesTheme,
                        nodeProps,
                        renderSuffix,
                        add,
                        finishAllDraw,
                        changleIconItem,
                        cancleIconItem,
                        darkTheme
                    }
                }
            }
            const app = Vue.createApp(App);
            app.use(naive);
            app.mount('#app');
        }

        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>