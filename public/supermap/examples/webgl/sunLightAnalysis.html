<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>日照分析</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <link href="./style/sunLightAnalysis.css" rel="stylesheet">
    <link href="./css/bootstrap-select.min.css" rel="stylesheet">
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script src="js/bootstrap-select.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="./js/spectrum.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/tooltip.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>
    <div id='toolbar' style="position: absolute;left: 5px;top: 5px;display: none;">
        <div class="titleBox">
            <div class="titl">日照分析</div>
            <span class="close2" aria-hidden="false">x</span>
        </div>
        <div class="inputBox">
            <label class="lab">日期选择</label>
            <input id="selDate" type="date" style="width: 206px; margin-bottom: 0px;color:white;" />
        </div>
        <div class="inputBox">
            <label class="lab" for="startTime">开始时间</label>
            <select id="startTime" class="selectstyle">
                <option value="0">0:00</option>
                <option value="2">2:00</option>
                <option value="4">4:00</option>
                <option value="6">6:00</option>
                <option value="8">8:00</option>
                <option value="10" selected>10:00</option>
                <option value="12">12:00</option>
                <option value="14">14:00</option>
                <option value="16">16:00</option>
                <option value="18">18:00</option>
                <option value="20">20:00</option>
                <option value="22">22:00</option>
            </select>
        </div>
        <div class="inputBox">
            <label class="lab" for="endTime">结束时间</label>
            <select id="endTime" class="selectstyle">
                <option value="2">2:00</option>
                <option value="4">4:00</option>
                <option value="6">6:00</option>
                <option value="8">8:00</option>
                <option value="10">10:00</option>
                <option value="12">12:00</option>
                <option value="14">14:00</option>
                <option value="16">16:00</option>
                <option value="18" selected>18:00</option>
                <option value="20">20:00</option>
                <option value="22">22:00</option>
                <option value="24">24:00</option>
            </select>
        </div>

        <div class="inputBox" style="display: flex;">
            <label class="lab">显示模式</label>
            <div class="content radio-box">
                <div style="display: flex;flex-direction: row;margin-right: 28px;align-items: center;">
                    <input type="radio" name="displayType" value="0" id="sunLight" checked>
                    <label for="sunLight">日照</label>
                </div>
                <div id="img-container" style="top: -2px;left: -25px;">
                    <img src="./images/iconTip/question.png" title="日照累计时长">
                </div>
                <div style="display: flex;flex-direction: row;margin-right: 28px;align-items: center;">
                    <input type="radio" name="displayType" value="1" id="shadow">
                    <label for="shadow">阴影</label>
                </div>
                <div id="img-container" style="top: -2px;right: 25px;">
                    <img src="./images/iconTip/question.png" title="阴影累计时长">
                </div>
            </div>
        </div>

        <div class="inputBox" id="colortable-box" style="display: flex;">
            <label class="lab" for="colorTable">颜色表</label>
            <div class="element" id="colorTable" title="设置颜色表" style="margin-left: 5px;">
                <select class="selectpicker">
                    <option value="4"
                        data-content="<span class='label band4' style='top:-2px'>&nbsp</span>&nbsp</span>">&nbsp
                    </option>
                    <option value="1"
                        data-content="<span class='label band1' style='top:-2px'>&nbsp</span>&nbsp</span>">&nbsp
                    </option>
                    <option value="2"
                        data-content="<span class='label band2' style='top:-2px'>&nbsp</span>&nbsp</span>">&nbsp
                    </option>
                    <option value="3"
                        data-content="<span class='label band3' style='top:-2px'>&nbsp</span>&nbsp</span>">&nbsp
                    </option>
                    <option value="5"
                        data-content="<span class='label band5' style='top:-2px'>&nbsp</span>&nbsp</span>">&nbsp
                    </option>
                </select>
            </div>
        </div>

        <div class="inputBox" id="color-box" style="display: none;">
            <label class="lab" for="colorTable">颜色设置</label>
            <input class="colorPicker content" id="colorPicker">
        </div>

        <div class="inputBox">
            <label class="lab">最远距离</label>
            <div class="rangeBox">
                <input type="range" id="maxDistance" min="10" max="3000" value="2000" step="10">
            </div>
            <input type="text" id="maxDistance_input" size="5" value="2000（米）" style="color: #ffffff;margin-top: 3px;">
        </div>

        <div style="margin: 0 0 12px 110px;">
            <button type="button" id="shadowAnalysis" class="btn_foot"
                style=" background:rgba(52,153,229,1);">分析</button>
            <button type="button" id="clear" class="btn_foot"
                style="border: 1px solid rgba(255, 255, 255, .65);color:rgba(255, 255, 255, .65)">清除</button>
        </div>

        <div class="legend-toolbar">
            <p>日照分析模式下统计时长情况</p>
            <div id="color-legend">
                <div class="color-legend-label" > > <span id="top">7</span>小时</div>
                <br/>
                <div class="color-legend-label" > = <span id="middle">5</span>小时</div>
                <br/>
                <div class="color-legend-label" style="margin-top:-2px;"> < <span id="bottom">2</span>小时</div>
            </div>

            <p>
                提示：鼠标悬浮获取日照时长
            </p>
        </div>
    </div>

    <script type="text/javascript">
           function onload(SuperMap3D) {
            // 通过config.js中的getEngineType,获取引擎类型（EngineType）用于设置启动方式
            let EngineType = getEngineType();
            let viewer = new SuperMap3D.Viewer('Container', {
                contextOptions: {
                    contextType: Number(EngineType), // Webgl2:2 ; WebGPU:3
                },
                timeline: true
            });

            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }

        function init(SuperMap3D, scene, viewer) {
            window.viewer = viewer;
            viewer.resolutionScale = window.devicePixelRatio;
            var scene = viewer.scene;
            var bablePosition = undefined;
            var bableDom = document.getElementById("shadowRadioBox");
            var tooltip = createTooltip(document.body);
            var colorTable = undefined;
            var mode = 0;

            $('#selDate').val(getRealTimeDate());
            $('#toolbar').show();
            $('#loadingbar').remove();

            viewer.imageryLayers.addImageryProvider(
                new SuperMap3D.SuperMapImageryProvider({
                    url: "http://www.supermapol.com/realspace/services/map-China400/rest/maps/China400",
                })
            );

            var promise = viewer.scene.open(URL_CONFIG.SCENE_CHONGQING_TX);
            promise.then(function (layers) {
                viewer.camera.setView({
                    "destination": {
                        "x": -1586580.311169008,
                        "y": 5328772.540159214,
                        "z": 3115220.677548043
                    },
                    "orientation": {
                        "heading": 6.204761801185258,
                        "pitch": -0.3741055955037009,
                        "roll": 0.0000013986611389071868
                    }
                })

                let baiMoLayer = layers[0];
                baiMoLayer.shadowType = 2;
     
                baiMoLayer.style3D.fillStyle = SuperMap3D.FillStyle.Fill_And_WireFrame;
                baiMoLayer.style3D.lineColor = SuperMap3D.Color.fromCssColorString('rgb(67,67,67)');

                var sunLightAnalysis = scene.sunlightAnalysis;

                var dateValue = $("#selDate").val();
                var startTime = new Date(dateValue);
                startTime.setHours(Number($("#startTime :selected").val()));
                sunLightAnalysis.startTime = SuperMap3D.JulianDate.fromDate(startTime);

                var endTime = new Date(dateValue);
                endTime.setHours(Number($("#endTime :selected").val()));
                sunLightAnalysis.endTime = SuperMap3D.JulianDate.fromDate(endTime);

                var handler = new SuperMap3D.ScreenSpaceEventHandler(scene.canvas);
                handler.setInputAction(function (e) {
                    if (!sunLightAnalysis.enabled) {
                        return;
                    }

                    var posWC = e.endPosition || e.position;

                    sunLightAnalysis.getDurationAsync(posWC).then(function(seconds){
                        var miniutes = Math.floor(seconds / 60);
                        var hours = Math.floor(miniutes / 60);
                        miniutes = miniutes % 60;

                        if (seconds != -1) {
                            if (Number(mode) == 0) {
                                tooltip.showAt(posWC, `<p>日照时长：${hours} 小时 ${miniutes} 分</p>`);
                            } else {
                                tooltip.showAt(posWC, `<p>阴影时长：${hours} 小时 ${miniutes} 分</p>`);
                            }
                        }
                    });
                }, SuperMap3D.ScreenSpaceEventType.MOUSE_MOVE);

                // 更新图例
                function updateLegendHours(startHour, endHour) {
                    if(startHour == 10 && endHour == 18){
                        $('#top').text(7);
                        $('#middle').text(5);
                        $('#bottom').text(2);
                        return;
                    }
                    if (startHour && endHour) {
                        let dValue = ((endHour - startHour) / 4).toFixed(1);
                        $('#top').text(dValue * 3);
                        $('#middle').text(dValue * 2);
                        $('#bottom').text(dValue);
                    }
                }

                let curStartTime = 10;
                let curEndTime = 18;
                function checkTime(startHour, endHour){
                    if(startHour >= endHour){
                        $("#startTime").val(`${curStartTime}`);
                        $("#endTime").val(`${curEndTime}`);
                        alert('开始时间不得大于结束时间，请重新选择');
                        return false;
                    }else{
                        return true;
                    }
                }

                // 选择时间
                $('#startTime').change(function () {
                    var startTime = new Date($("#selDate").val());
                    var startHour = Number($(this).val());
                    var endHour = Number($("#endTime :selected").val());

                    let checked = checkTime(startHour,endHour);
                    if(checked){
                        startTime.setHours(startHour);
                        sunLightAnalysis.startTime = SuperMap3D.JulianDate.fromDate(startTime);
                        updateLegendHours(startHour,endHour);
                        curStartTime = startHour;
                        curEndTime = endHour;
                    }

                });
                $('#endTime').change(function () {
                    var endTime = new Date($("#selDate").val());
                    var endHour = Number($(this).val());
                    var startHour = Number($("#startTime :selected").val());

                    let checked = checkTime(startHour,endHour);
                    if(checked){
                        endTime.setHours(endHour);
                        sunLightAnalysis.endTime = SuperMap3D.JulianDate.fromDate(endTime);
                        updateLegendHours(startHour,endHour);
                        curStartTime = startHour;
                        curEndTime = endHour;
                    }
                });

                // 选择模式
                $('#sunLight').click(function () {
                    mode = $('#sunLight').val();
                    sunLightAnalysis.displayMode = parseInt(mode);
                    $("#infoText").text("日照时长");
                    $("#color-box").hide();
                    $("#colortable-box").show();
                    var value = $("#colorTable").find("option:selected")[0].value;
                    if(Number(value) == 4){
                        $(".legend-toolbar").show();
                    }else{
                        $(".legend-toolbar").hide();
                    }
                });
                $('#shadow').click(function () {
                    mode = $('#shadow').val();
                    sunLightAnalysis.displayMode = parseInt(mode);
                    $("#infoText").text("阴影时长");
                    $("#color-box").show();
                    $("#colortable-box").hide();
                    $(".legend-toolbar").hide();
                });

                // 移入工具栏关闭toolTip
                $('#toolbar').mouseenter(function () {
                    tooltip.setVisible(false);
                });
                $('#toolbar').mouseleave(function () {
                    if (sunLightAnalysis.enabled) {
                        tooltip.setVisible(true);
                    }
                });

                // 颜色选择器
                $("#colorPicker").spectrum({
                    color: "rgba(0,0,255,1)",
                    showPalette: true,
                    showAlpha: true,
                    localStorageKey: "spectrum.demo",
                    preferredFormat:'rgb'
                });
                $("#colorPicker").on('change', function(event) {
                    var selectColor = new SuperMap3D.Color.fromCssColorString(event.target.value);
                    sunLightAnalysis.visualizationColor = selectColor;
                });

                // 颜色表
                $('#colorTable').change(function () {
                    colorTable = new SuperMap3D.ColorTable();
                    var value = $("#colorTable").find("option:selected")[0].value;
                    setColorTable(colorTable, value);
                    sunLightAnalysis.setColorTable(colorTable);

                    if(Number(value) == 4){
                        $(".legend-toolbar").show();
                    }else{
                        $(".legend-toolbar").hide();
                    }
                });

                // 日照分析最远距离
                $('#maxDistance').mousemove(function () {
                    var val = $('#maxDistance').val();
                    $('#maxDistance_input').val(`${val}（米）`);
                    if (sunLightAnalysis._shadowMap) sunLightAnalysis._shadowMap.maximumDistance = Number(val);
                });

                // 开始分析
                $('#shadowAnalysis').click(function () {
                    // if (sunLightAnalysis._shadowMap) sunLightAnalysis._shadowMap.maximumDistance = 100;
                    if (colorTable) sunLightAnalysis.setColorTable(colorTable);
                    sunLightAnalysis.run();
                });

                // 清除
                $('#clear').click(function () {
                    sunLightAnalysis.clear();
                    tooltip.setVisible(false);
                });
            }, function (e) {
                consoloe.log(e);
            });

            // 设置颜色表
            function setColorTable(colorTable, key) {
                switch (key) {
                    case "1":
                        colorTable.insert(0, new SuperMap3D.Color(0, 39 / 255, 148 / 255));
                        colorTable.insert(1, new SuperMap3D.Color(149 / 255, 232 / 255, 249 / 255));
                        break;
                    case "2":
                        colorTable.insert(0, new SuperMap3D.Color(162 / 255, 251 / 255, 194 / 255));
                        colorTable.insert(1, new SuperMap3D.Color(1, 103 / 255, 103 / 255));
                        break;
                    case "3":
                        colorTable.insert(0, new SuperMap3D.Color(230 / 255, 198 / 255, 1));
                        colorTable.insert(1, new SuperMap3D.Color(157 / 255, 0, 1));
                        break;
                    case "4":
                        colorTable.insert(0, new SuperMap3D.Color(0, 0, 1, 1));
                        colorTable.insert(0.4, new SuperMap3D.Color(0, 0, 1, 1));
                        colorTable.insert(0.6, new SuperMap3D.Color(0, 1, 1, 1));
                        colorTable.insert(0.8, new SuperMap3D.Color(1, 1, 0, 1));
                        colorTable.insert(1, new SuperMap3D.Color(1, 0, 0, 1));
                        break;
                    case "5":
                        colorTable.insert(0, new SuperMap3D.Color(186 / 255, 1, 229 / 255));
                        colorTable.insert(1, new SuperMap3D.Color(26 / 255, 185 / 255, 156 / 255));
                        break;
                    default:
                        break;
                }
            }


            // 获取当前系统日期
            function getRealTimeDate() {
                var currentDate = new Date();
                var day = currentDate.getDate(); //获取天
                var month = currentDate.getMonth() + 1; // 获取月
                var year = currentDate.getFullYear(); // 获取年份

                // 补零操作
                day = (day < 10 ? "0" : "") + day;
                month = (month < 10 ? "0" : "") + month;

                // 构建格式化日期字符串
                var realTimeDate = year + "-" + month + "-" + day;
                return realTimeDate;
            }
        }
        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>