
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<meta name="viewport"
			content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
		<title>全国用电量TOP10</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/config.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
    <script src="./js/echarts.min.js"></script>
    <script src="./support/special/electricity/EchartsLayer2.js"></script>
	</head>
	<body>

		<div id="cesiumContainer" style="width: 100%;height: 100%;background-image: url('./support/special/electricity/images/background.png');"></div>
        <div
			style="height: 80px;width: 100%;position: absolute;top: 0;z-index: 100;color: white;text-align: center;font-size: 30px;font-weight: 900;">
			<p>2018年全国用电量TOP10区域展示</p>
		</div>
		<div id="nanhai"
			style="position: absolute;right: 20px;bottom: 20px; width: 180px;height: 280px;background-image: url('./support/special/electricity/images/nanhai1.png');z-index: 100;background-size: 100% 100%;">
		</div>
		<div id="powertop"
			style="position: absolute;left: 15px;top: 0; width: 300px;height: 100%;;z-index: 200;background-color: #00000000;pointer-events: none">
		</div>
		<div id='loadingbar' class="spinner">
			<div class="spinner-container container1">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="spinner-container container2">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="spinner-container container3">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
		</div>
		<script>
			var viewer;

			function onload(SuperMap3D) {
				var chinaRegion = {};
				var xres = parseInt(window.screen.width * window.devicePixelRatio);
				var yres = parseInt(window.screen.height * window.devicePixelRatio);
				viewer = new SuperMap3D.Viewer('cesiumContainer', {
					baseLayerPicker: false,
					navigation: false,
					orderIndependentTranslucency: false,
					selectionIndicator:false,
					infoBox: false,
					shouldAnimate: true,
					contextOptions: {
						webgl: {
							alpha: true
						},
					maxDrawingBufferWidth: xres,
					maxDrawingBufferHeight: yres

					},
					sceneMode: 3
				});
                $(".cesium-widget-credits").hide();
				viewer.resolutionScale = window.devicePixelRatio;
				viewer.useBrowserRecommendedResolution = true;
				
				var endTime = new Date('2017-05-13');
				endTime.setHours(16);
				viewer.clock.currentTime = SuperMap3D.JulianDate.fromDate(endTime);
				viewer.scene.postProcessStages.fxaa.enabled = false;
				var scene = viewer.scene;
				viewer.scene.globe.show = false;
				viewer.scene.bloomEffect.show = true;
				viewer.scene.bloomEffect.threshold = 0.9;
				viewer.scene.bloomEffect.bloomIntensity = 5;
				viewer.scene.hdrEnabled = true;
				scene.skyBox.show = false;
				scene.backgroundColor = new SuperMap3D.Color(0.0, 0.0, 0.0, 0.0);
				scene.lightSource.ambientLightColor = new SuperMap3D.Color(0.3, 0.3, 0.3, 0.4);

				var promise = viewer.scene.open("https://www.supermapol.com/realspace/services/3D-chinablue/rest/realspace")
				promise.then(function(layers) {

					var pos = new SuperMap3D.Cartesian3(11886358.457028255, -785938.6640827719, 5494521.622125353);
					var convertPos = SuperMap3D.SceneTransforms.convert2DToCartesian(scene, pos);
					scene.camera.setView({
						//将经度、纬度、高度的坐标转换为笛卡尔坐标
						destination: convertPos,
						orientation: {
							heading: 6.242737301765953,
							pitch: -0.8570961371273946,
							roll: 2.4158453015843406e-13
						}
					});
					var layer = scene.layers.find('CHINA_bottom');
					var style3D = new SuperMap3D.Style3D();
					var color = new SuperMap3D.Color(1, 0, 0, 0.5);
					style3D.fillForeColor = color;
					layer.style3D = style3D;

					var layertop = scene.layers.find('CHINA_top');
					layertop.selectColorType = SuperMap3D.SelectColorType.SILHOUETTE;
					layertop.selectedColor = new SuperMap3D.Color(0, 1, 1, 1);
					layertop.selectedLineColor = new SuperMap3D.Color(0, 1, 1, 1);
				}, function() {
					var title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？';
					widget.showErrorPanel(title, undefined, e);
				});
				$.ajax({
					url: './support/special/electricity/json/fenjie3857.json',
					success: function(data) {
						var geometrys = data.features;
						for (var i = 0; i < geometrys.length; i++) {
							var geometry = geometrys[i].geometry;
							var coordinates = geometry.coordinates;
							var pipeLinePts = [];
							for (var j = 0; j < coordinates.length; j++) {

								var pos = new SuperMap3D.Cartesian3(coordinates[j][0], coordinates[j][1], 500);
								var convertPos = SuperMap3D.SceneTransforms.convert2DToCartesian(scene,
									pos); //3857转换为笛卡尔坐标
								pipeLinePts.push(convertPos);
							}
							viewer.entities.add({
								polyline: {
									positions: pipeLinePts,
									width: 2,
									material: new SuperMap3D.Color(94 / 255, 213 / 255, 245 / 255, 0.5)
								}
							})
						}

					}
				});
				$.ajax({
					url: './support/special/electricity/json/chinabounds.json',
					success: function(data) {
						var geometrys = data.features;
						for (var i = 0; i < geometrys.length; i++) {
							var geometry = geometrys[i].geometry;
							var coordinates = geometry.coordinates;
							var pipeLinePts = [];
							for (var j = 0; j < coordinates.length; j++) {

								var pos = new SuperMap3D.Cartesian3(coordinates[j][0], coordinates[j][1], 2000);
								var convertPos = SuperMap3D.SceneTransforms.convert2DToCartesian(scene,
									pos); //3857转换为笛卡尔坐标
								pipeLinePts.push(convertPos);
							}
							viewer.entities.add({
								polyline: {
									positions: pipeLinePts,
									width: 2.5,
									material: new SuperMap3D.Color(94 / 255, 213 / 255, 245 / 255, 1)
								}
							})
						}
					}
				});

				var position = new SuperMap3D.Cartesian3(7981110.566460701, 3795088.9529435365, -80000);
				var convertposition = SuperMap3D.SceneTransforms.convert2DToCartesian(scene, position); //3857转换为笛卡尔坐标

				var targetPosition = new SuperMap3D.Cartesian3(8995343.536513155, 3917366.6014486784, -80000);
				var converttargetPosition = SuperMap3D.SceneTransforms.convert2DToCartesian(scene, targetPosition); //3857转换为笛卡尔坐标

				var options_n = {
					targetPosition: targetPosition,
					intensity: 10,
				};
				var directionalLight_n = new SuperMap3D.DirectionalLight(position, options_n);
				viewer.scene.addLightSource(directionalLight_n);
				addPOIeChart();

				function addPOIeChart() {

					var data = [];
					var geoCoordMap = {};

					$.ajax({
						url: './support/special/electricity/json/taiwan_3857.json',
						success: function(datas) {
							var geometrys = datas.features;
							for (var i = 0; i < geometrys.length; i++) {
								var geometry = geometrys[i].geometry;
								var coordinates = geometry.coordinates;
								var name = geometrys[i].properties.name;
								geoCoordMap[name] = [coordinates[0], coordinates[1]];

								var position = new SuperMap3D.Cartesian3(coordinates[0], coordinates[1],
									500);
								var convertposition = SuperMap3D.SceneTransforms.convert2DToCartesian(scene,
									position);
								viewer.entities.add({
									// id: name,
									position: convertposition,
									label: {
										text: name,
										style: SuperMap3D.LabelStyle.FILL_AND_OUTLINE,
										fillColor: new SuperMap3D.Color(255 / 255, 255 / 255, 255 / 255, 0.9),
										outlineColor: new SuperMap3D.Color(79 / 255, 128 / 255, 169 / 255, 0.9),
										disableDepthTestDistance: Number.POSITIVE_INFINITY,
										font: 15-Math.pow(window.devicePixelRatio,2)+'px Arial bold',
										//scale:1/window.devicePixelRatio
									}
								})


							}
						}
					});








					
					$.ajax({
						url: './support/special/electricity/json/ChinaPowerTP10.json',
						success: function(datas) {

							let realtimeDataEntities = []
							var geometrys = datas.features;
							for (var i = 0; i < geometrys.length; i++) {
								var geometry = geometrys[i].geometry;
								var coordinates = geometry.coordinates;
								var name = geometrys[i].properties.name;
								data.push({
									'name': name,
									'value': geometrys[i].properties.value
								})
								geoCoordMap[name] = [coordinates[0], coordinates[1]];

							}
							var myImage = new Image();
							myImage.src = "./support/special/electricity/images/lable.png";
							myImage.crossOrigin = "Anonymous";
							myImage.onload = function() {

								for (var i = 0; i < data.length; i++) {

									var labelname = data[i].name;
									let width = 660,
										height = 400;

									var lableposition = geoCoordMap[data[i].name];
									var canvas = document.createElement("canvas");
									let context = canvas.getContext("2d");
									canvas.width = width;
									canvas.height = height;
									context.rect(0, 0, width, height);
									context.clearRect(0, 0, width, height);
									context.drawImage(
										myImage,
										0,
										0,
										canvas.width / 3 * 0.8,
										canvas.height / 3.5,
										0,
										0,
										canvas.width,
										canvas.height
									);
									context.font = "bold "+(75-Math.pow(window.devicePixelRatio,2))+"px Microsoft YaHei";
									context.textAlign = "center";
									var left = 200;
									var top = 120;

									if (labelname === "广东省") {
										context.fillStyle = "#f0515e";
									} else {
										context.fillStyle = "#fff";
									}
									context.fillText(labelname, canvas.width / 2, top - 10);
									var grad = context.createLinearGradient(0, 0, 0, 500);
									grad.addColorStop("0", "white");
									if (labelname === "广东省") {
										grad.addColorStop("1.0", 'red');
									} else {
										grad.addColorStop("1.0", '#18DBFD');
									}
									context.fillStyle = grad;
									context.font = "bold "+(67-Math.pow(window.devicePixelRatio,2))+"px Microsoft YaHei";

									context.fillText(data[i].value + " 亿千瓦时", canvas.width / 2, top + 80);





									var position = new SuperMap3D.Cartesian3(lableposition[0], lableposition[1],
										500);
									var convertposition = SuperMap3D.SceneTransforms.convert2DToCartesian(scene,
										position);
									if (labelname === "内蒙古自治区") {
										viewer.entities.add({
											// id: name,
											position: convertposition,
											billboard: {
												image: canvas,
												disableDepthTestDistance: Number.POSITIVE_INFINITY,
												scale: 0.2,
												pixelOffset: new window.SuperMap3D.Cartesian2(85, 15),
											},
										})
									} else {
										viewer.entities.add({
											// id: name,
											position: convertposition,
											billboard: {
												image: canvas,
												disableDepthTestDistance: Number.POSITIVE_INFINITY,
												scale: 0.2,
												pixelOffset: new window.SuperMap3D.Cartesian2(0, -30),
											},
										})

									}

								}

							}

							const convertData = function(data) {
								const res = [];
								for (let i = 0; i < data.length; i++) {
									const geoCoord = geoCoordMap[data[i].name];
									if (geoCoord) {
										res.push({
											name: data[i].name,
											value: geoCoord.concat(data[i].value)
										});
									}
								}
								return res;
							};
							const options = {
								animation: !1,
								// backgroundColor: '#404a59',
								GLMap: {},
								series: [{
									name: '前5',
									type: 'effectScatter',
									coordinateSystem: 'GLMap',
									data: convertData(data.sort(function(a, b) {
										return b.value - a.value;
									}).slice(0, 50)),
									symbolSize: function(val) {
										return val[2] / 240;
									},
									showEffectOn: 'render',
									rippleEffect: {
										brushType: 'stroke'
									},
									hoverAnimation: true,
									itemStyle: {
										normal: {
											color: '#00FFFA',
											shadowBlur: 20,
											shadowColor: '#333'
										}
									},
									zlevel: 1
								}]
							};

							var echartsLayer = new EchartsLayer(viewer);
							echartsLayer.chart.setOption(options);
						}
					});
					let handlerPoint = new SuperMap3D.ScreenSpaceEventHandler(window.viewer.scene.canvas);
					handlerPoint.setInputAction(function(event) {
						viewer.entities.removeById("selectedId");

						var layertop = scene.layers.find('CHINA_top');
						var selection = layertop.getSelection();
						if (selection.length > 0) {
							var selectedId = Number(selection[selection.length - 1]);
							viewer.entities.add({
								id: "selectedId",
								polygon: {
									hierarchy: new SuperMap3D.PolygonHierarchy(chinaRegion[selectedId]),

									material: new SuperMap3D.Color(0 / 255, 255 / 255, 255 / 255, 0.3)
								}
							})
						} else {

						}

					}, SuperMap3D.ScreenSpaceEventType.LEFT_CLICK);
					$.ajax({
						url: './support/special/electricity/json/CHINARegion.json',
						success: function(data) {
							var geometrys = data.features;
							for (var i = 0; i < geometrys.length; i++) {
								var geometry = geometrys[i].geometry;
								var coordinates;
								if (geometry.coordinates.length == 1) {
									coordinates = geometry.coordinates[0];
								} else {
									coordinates = geometry.coordinates[0][0];
								}
								var pipeLinePts = [];
								for (var j = 0; j < coordinates.length; j++) {

									var pos = new SuperMap3D.Cartesian3(coordinates[j][0], coordinates[j][1], 0);
									var convertPos = SuperMap3D.SceneTransforms.convert2DToCartesian(scene,
										pos); //3857转换为笛卡尔坐标
									pipeLinePts.push(convertPos);
								}
								chinaRegion[geometrys[i].properties.SmUserID] = pipeLinePts;
							}
						}
					});

				}

				var chinaDatas = [{
						name: '广东',
						value: 6323.35
					},
					{
						name: '江苏',
						value: 6128
					},
					{
						name: '山东',
						value: 6083.88
					},
					{
						name: '浙江',
						value: 4532.8
					},

					{
						name: '河南',
						value: 3417.68
					},
					{
						name: '河北',
						value: 3366.28
					},
					{
						name: '内蒙古',
						value: 3353
					},
					{
						name: '四川',
						value: 2459
					},
					{
						name: '福建',
						value: 2313.8
					},
					{
						name: '辽宁',
						value: 2302.38
					},
					{
						name: '山西',
						value: 2160.53
					},
					{
						name: '新疆',
						value: 2138.33
					},
					{
						name: '安徽',
						value: 2135.07
					},
					{
						name: '湖北',
						value: 2071.43
					},
					{
						name: '湖南',
						value: 1745.24
					},
					{
						name: '广西',
						value: 1702.75
					},
					{
						name: '云南',
						value: 1679.1
					},
					{
						name: '上海',
						value: 1566.67
					},
					{
						name: '贵州',
						value: 1482.12
					},
					{
						name: '江西',
						value: 1428.77
					},
					{
						name: '陕西',
						value: 1384.84
					},
					{
						name: '甘肃',
						value: 1289.52
					},
					{
						name: '北京',
						value: 1142.38
					},
					{
						name: '重庆',
						value: 1114
					},
					{
						name: '宁夏',
						value: 935.15
					},
					{
						name: '天津',
						value: 861.44
					},
					{
						name: '黑龙江',
						value: 763.01
					},
					{
						name: '吉林',
						value: 750.57
					},
					{
						name: '青海',
						value: 738.34
					},
					{
						name: '海南',
						value: 326.78
					},
					{
						name: '西藏',
						value: 69.02
					},
					{
						name: '台湾',
						value: 55
					},
					{
						name: '香港',
						value: 45
					},
					{
						name: '澳门',
						value: 40
					}

				];

				var yData = [];
				var barData = chinaDatas;
				barData = barData.sort(function(a, b) {
					return b.value - a.value;
				});
				for (var j = 0; j < barData.length; j++) {
					if (j < 10) {
						yData.push('0' + j + barData[j].name);
					} else {
						yData.push(j + barData[j].name);
					}
				}

				var poweroption = {
					backgroundColor: '#00000000',
					title: [{
						show: true,
						text: '',
						subtext: '单位：亿千瓦时',
						subtextStyle: {
							color: '#ffffff'
						},
						textStyle: {
							color: '#fff',
							fontSize: 18
						},
						left: 10,
						top: 40
					}],
					grid: {
						left: 100,
						top: 80,
						bottom: 20,
						width: '200'
					},
					xAxis: {
						show: false
					},
					yAxis: {
						type: 'category',
						inverse: true,
						nameGap: 18,
						axisLine: {
							show: false,
							lineStyle: {
								color: '#ddd'
							}
						},
						axisTick: {
							show: false,
							lineStyle: {
								color: '#ddd'
							}
						},
						axisLabel: {
							interval: 0,
							margin: 85,
							textStyle: {
								color: '#fff',
								align: 'left',
								fontSize: 14
							},
							rich: {
								a: {
									color: '#fff',
									backgroundColor: '#18DBFD',
									width: 20,
									height: 20,
									align: 'center',
									borderRadius: 2
								},
								b: {
									color: '#fff',
									backgroundColor: '#4C83FF',
									width: 20,
									height: 20,
									align: 'center',
									borderRadius: 2
								}
							},
							formatter:function(params){
                                if (parseInt(params.slice(0, 2)) < 10) {
									return [
										'{a|' + (parseInt(params.slice(0, 2)) + 1) + '}' + '  ' + params.slice(2)
									]
								} else {
									return [
										'{b|' + (parseInt(params.slice(0, 2)) + 1) + '}' + '  ' + params.slice(2)
									]
								}
                            }
						},
						data: yData
					},
					series: [{
						name: 'barSer',
						type: 'bar',
						roam: false,
						visualMap: false,
						zlevel: 2,
						barMaxWidth: 16,
						barGap: 0,
						itemStyle: {
							normal: {
								color: function(params) {
									var colorList = [
										{
											colorStops: [{
												offset: 0,
												color: '#18DBFD00'
											}, {
												offset: 1,
												color: '#18DBFDFF'
											}]
										},										
										{
											colorStops: [{
												offset: 0,
												color: '#4C83FF00'
											}, {
												offset: 1,
												color: '#4C83FFFF'
											}]
										}
									];
									if (params.dataIndex < 10) {
										return colorList[0]
									} else {
										return colorList[1]
									}
								},
								barBorderRadius: [0, 15, 15, 0]
							}
						},
						label: {
							normal: {
								show: true,
								textBorderColor: '#333',
								textBorderWidth: 2
							}
						},
						data: barData.sort((a, b) => {
							return b.value - a.value;
						})
					}]
				};
				var myChart = echarts.init(document.getElementById('powertop'));
				myChart.setOption(poweroption)
				$('#loadingbar').remove();
			}
			if (typeof SuperMap3D !== 'undefined') {
				window.startupCalled = true;
				onload(SuperMap3D);
			}
		</script>
	</body>
</html>
