<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>四川省晕渲图</title>
  <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
  <link href="./css/pretty.css" rel="stylesheet">
  <script src="./js/jquery.min.js"></script>
  <script src="./js/config.js"></script>
  <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
  <div id="Container">
  </div>
  <script type="text/javascript">
    function onload(SuperMap3D) {
      const obj = [6378137.0, 6378137.0, 6356752.3142451793];
      SuperMap3D.Ellipsoid.WGS84 = Object.freeze(new SuperMap3D.Ellipsoid(obj[0], obj[1], obj[2]));
      const viewer = new SuperMap3D.Viewer('Container', {
        timeline: false,
        infoBox: false,
        selectionIndicator: false,
      });

      viewer.scenePromise.then(function (scene) {
        init(SuperMap3D, scene, viewer);
      });
    }

    function init(SuperMap3D, scene, viewer) {
      scene.lightSource.ambientLightColor = SuperMap3D.Color.BLUE;
      scene.lightSource.visibleDistanceMax = 50000000;
      scene.skyAtmosphere.show = true;
      scene.hdrEnabled = true;
      scene.sun.show = true;
      scene.shadowMap = true;
      scene.shadows = true;
      scene.lightSource.ambientLightColor = new SuperMap3D.Color(0.65, 0.65, 0.65, 1);
      
      const endTime = new Date('2017-05-13');
      endTime.setHours(20);
      viewer.clock.currentTime = SuperMap3D.JulianDate.fromDate(endTime);
      
      const widget = viewer.cesiumWidget;
      try {
        let position1 = new SuperMap3D.Cartesian3.fromDegrees(116.261209157595, 39.3042238956531, 480);
        let targetPosition1 = new SuperMap3D.Cartesian3.fromDegrees(116.261209157595, 39.3042238956531, 430);
        let dirLightOptions = {
          targetPosition: targetPosition1,
          color: new SuperMap3D.Color(1.0, 1.0, 1.0, 1),
          intensity: 0.55
        };
        directionalLight_1 = new SuperMap3D.DirectionalLight(position1, dirLightOptions);
        scene.addLightSource(directionalLight_1);

        viewer.imageryLayers.addImageryProvider(new SuperMap3D.SuperMapImageryProvider({
          url: 'https://www.supermapol.com/realspace/services/map-scyx/rest/maps/China_DARK',
        }));

        //打开所发布三维服务下的所有图层
        const url = 'https://www.supermapol.com/realspace/services/3D-scyx/rest/realspace';
        const promise = scene.open(url);
        promise.then(function (layers) {
          const layer = viewer.scene.layers.find('sichuan_Model_3');
          const layer2 = viewer.scene.layers.find('Buffer@DataSource');
          rotapic();   //底图旋转
          borderline();  //各市边线
          fanguang();  //泛光     

          layer.brightness = 1.1;
          layer.contrast = 1.44;
          layer.hue = 6.22;
          layer.saturation = 0.7;
          layer2.brightness = 1.5;
          layer2.contrast = 1.54;
          // layer.style3D.bottomAltitude = -20000;  
          // layer2.style3D.bottomAltitude = -20000; 
          if (!scene.pickPositionSupported) {
            alert('不支持深度纹理,无法拾取位置！');
          }
        }, function (e) {
          if (widget._showRenderLoopErrors) {
            let title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？';
            widget.showErrorPanel(title, undefined, e);
          }
        });
      } catch (e) {
        if (widget._showRenderLoopErrors) {
          let title = '渲染时发生错误，已停止渲染。';
          widget.showErrorPanel(title, undefined, e);
        }
      }

      let rotation = SuperMap3D.Math.toRadians(30);
      function rotapic() {
        let POIEntity = viewer.entities.add({     //底部旋转图片
          name: "test1",
          position: SuperMap3D.Cartesian3.fromDegrees(102.93464741761072, 30.449421089102337, 3000),
          ellipse: {
            semiMinorAxis: 600000,
            semiMajorAxis: 600000,
            height: 3000,
            material: new SuperMap3D.ImageMaterialProperty({
              image: './support/imgs/xuanyuncircle.png',
              repeat: new SuperMap3D.Cartesian2(1, 1),
              color: new SuperMap3D.Color.WHITE.withAlpha(0.4)
            }),
            rotation: new SuperMap3D.CallbackProperty(getRotationValue, false),
            stRotation: new SuperMap3D.CallbackProperty(getRotationValue, false),
            outline: false, // height must be set for outline to display
            numberOfVerticalLines: 100
          },
          description: '测试数据'
        });
      }

      function getRotationValue() {
        rotation += 0.0006;
        return rotation;
      }

      function borderline() {
        //城市边界线
        let promise = SuperMap3D.GeoJsonDataSource.load('./support/json/sichuanCity_3D.json');
        promise.then(function (dataSource) {
          viewer.dataSources.add(dataSource);
          let entities = dataSource.entities.values;
          for (let i = 0; i < entities.length; i++) {
            let entity = entities[i];
            entity.polyline.material =
              new SuperMap3D.PolylineGlowMaterialProperty({
                glowPower: 0.3,
                color: new SuperMap3D.Color(250 / 255, 192 / 255, 143 / 255).withAlpha(1),
              });
            entity.polyline.width = 2
          }
        }).otherwise(function (error) {
          window.alert(error);
        });
        //省界泛光线           
        $.ajax({
          url: './support/json/sichuanBounds_3D.json',
          success: function (datas) {
            let points = [];
            let geometrys = datas.features;
            for (let i = 0; i < geometrys.length; i++) {
              let geometry = geometrys[i].geometry;
              let coordinates = geometry.coordinates;
              for (let item of coordinates) {
                points.push(item[0]);
                points.push(item[1]);
                points.push(item[2])
              };
              viewer.entities.add({
                polyline: {
                  positions: new SuperMap3D.Cartesian3.fromDegreesArrayHeights(points),
                  material: SuperMap3D.Color.WHITE,
                  width: 2
                }
              });
            }
          }
        });
        $.ajax({
          url: './support/json/sichuanbounds2.json',
          success: function (datas) {
            let points = [];
            let geometrys = datas.features;
            for (let i = 0; i < geometrys.length; i++) {
              let geometry = geometrys[i].geometry;
              let coordinates = geometry.coordinates;
              for (let item of coordinates) {
                points.push(item[0]);
                points.push(item[1]);
                points.push(0)
              };
              viewer.entities.add({
                polyline: {
                  positions: new SuperMap3D.Cartesian3.fromDegreesArrayHeights(points),
                  material: new SuperMap3D.PolylineGlowMaterialProperty({
                    glowPower: 0.3,
                    color: new SuperMap3D.Color(0, 2.88, 23.9, 1.0),
                  }),
                  width: 2
                }
              });
            }
          }
        })
      }

      function fanguang() {
        scene.bloomEffect.show = true;//开启泛光
        scene.bloomEffect.threshold = 2.9;
        scene.bloomEffect.bloomIntensity = 0.05;
        scene.hdrEnabled = true; // 开启hdr
      }

      $('#loadingbar').remove();
    }

    if (typeof SuperMap3D !== 'undefined') {
      window.startupCalled = true;
      onload(SuperMap3D);
    }
  </script>
</body>

</html>