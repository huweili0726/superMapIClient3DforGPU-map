<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>三维流场</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <link href="./style/sunLightAnalysis.css" rel="stylesheet">
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script src="./js/config.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>
    <div id='toolbar' style="position: absolute;left: 5px;top: 5px;">
        <div class="titleBox">
            <div class="titl">三维流场</div>
            <span class="close2" aria-hidden="false">x</span>
        </div>

        <div class="inputBox">
            <label class="lab" for="timeDim">选择时序</label>
            <select id="timeDim" class="selectstyle">
                <option value="" style="display: none">选择时序</option>
            </select>
        </div>
        <div class="inputBox">
            <label class="lab" for="particleMode">粒子渲染模式</label>
            <select id="particleMode" class="selectstyle">
                <option value="0" >图片</option>
                <option value="1" selected>点图元</option>
            </select>
        </div>
        <div class="inputBox" id="imageSizeInMetersBox">
            <label class="lab" for="imageSizeInMeters">图像单位</label>
            <select id="imageSizeInMeters" class="selectstyle">
                <option value="1" selected>米</option>
                <option value="0">像素</option>
            </select>
        </div>

        <div class="inputBox">
            <label class="lab">粒子大小</label>
            <div class="rangeBox">
                <input type="range" id="particleSize" min="1" max="50" step="1" value="2">
            </div>
            <input type="text" id="particleSize_input" size="1" value="10" style="color: #ffffff;margin-top: 3px;">
        </div>

        <div class="inputBox">
            <label class="lab">水平粒子密度</label>
            <div class="rangeBox">
                <input type="range" id="horizontalDensity" min="1" max="100" step="1" value="1">
            </div>
            <input type="text" id="horizontalDensity_input" size="1" value="1" style="color: #ffffff;margin-top: 3px;">
        </div>

        <div class="inputBox">
            <label class="lab">垂直粒子密度</label>
            <div class="rangeBox">
                <input type="range" id="verticalDensity" min="0.1" max="1.0" step="0.1" value="0.1">
            </div>
            <input type="text" id="verticalDensity_input" size="0.1" value="0.1"
                style="color: #ffffff;margin-top: 3px;">
        </div>

        <div class="inputBox">
            <label class="lab">粒子运动速度</label>
            <div class="rangeBox">
                <input type="range" id="velocityScale" min="1" max="20" step="1" value="1">
            </div>
            <input type="text" id="velocityScale_input" size="1" value="1" style="color: #ffffff;margin-top: 3px;">
        </div>
    </div>

    <script type="text/javascript">
        function onload(SuperMap3D) {
            // 通过config.js中的getEngineType,获取引擎类型（EngineType）用于设置启动方式
            let EngineType = getEngineType();
            let viewer = new SuperMap3D.Viewer('Container', {
                contextOptions: {
                    contextType: 2, // Webgl2:2 ; WebGPU:3 ；三维流场暂不支持WebGPU引擎
                },
                timeline: false
            });

            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }

        function init(SuperMap3D, scene, viewer) {
            window.viewer = viewer;
            viewer.resolutionScale = window.devicePixelRatio;

            scene.skyBox.show = false;
            scene.sun.show = false;
            scene.skyAtmosphere.show = false;
            scene.globe.depthTestAgainstTerrain = false;
            scene.skyBox.show = false;
            scene.fog.enabled = false;
            scene.globe.show = false;

            const url = 'https://www.supermapol.com/realspace/services/3D-SanWeiLiuChang/rest/realspace/datas/%E4%B8%89%E7%BB%B4%E6%B5%81%E5%9C%BA%E7%94%A8%E4%BE%8B%E6%95%B0%E6%8D%AE/config';
            const promise = scene.addS3MTilesLayerByScp(url, {
                name: 'field3d'
            });

            promise.then(function (layer) {
                $('#loadingbar').remove();

                // 根据图层定位
                // scene.camera.setView({
                //     destination: new SuperMap3D.Cartesian3.fromRadians(
                //         (layer.layerBounds.west + layer.layerBounds.east) * 0.5,
                //         (layer.layerBounds.south + layer.layerBounds.north) * 0.5,
                //         1000
                //     ),
                //     orientation: {
                //         pitch: -Math.PI / 2
                //     }
                // });

                scene.camera.setView({
                    destination: new SuperMap3D.Cartesian3.fromDegrees(115.8817275215527, 40.63164710941161, 30581.897563948303),
                    orientation: {
                        heading: 2.3128577760886637,
                        pitch: -0.37505118499938606,
                        roll: 0.000035877104795467574
                    }
                });

                initLayer(layer);

                // 默认使用点图元的方式显示流场数据
                layer.particleVelocityFieldEffect.particleMode = 1;

                $('#timeDim').on("change", function () {
                    const index = parseInt($(this).val());
                    layer.temporalSetting.setLoaction(SuperMap3D.CategoryFieldName.RasterField, index);
                });

                $("#particleMode").on("change", function () {
                    const mode = parseFloat($(this).val());
                    layer.particleVelocityFieldEffect.particleMode = mode;

                    // 点图元模式隐藏图像单位选项，切换时改为合适的粒子大小
                    if(mode === 1){
                        const size = 2;
                        layer.particleVelocityFieldEffect.particleSize = size;
                        $("#imageSizeInMetersBox").hide();
                        $("#particleSize").val(size);
                        $('#particleSize_input').val(size);
                    }else{
                        const size = 20;
                        layer.particleVelocityFieldEffect.particleSize = size;
                        $("#imageSizeInMetersBox").show();
                        $("#particleSize").val(size);
                        $('#particleSize_input').val(size);
                    }
                });

                $('#imageSizeInMeters').on("change", function () {
                    const value = Boolean(parseInt($(this).val()));
                    layer.particleVelocityFieldEffect.imageSizeInMeters = value;
                });


                $("#particleSize").mousemove(function () {
                    const size = $(this).val();
                    layer.particleVelocityFieldEffect.particleSize = size;
                    $('#particleSize_input').val(`${size}`);
                });
                $("#horizontalDensity").mousemove(function () {
                    const hDensity = $(this).val();
                    layer.particleVelocityFieldEffect.horizontalDensity = hDensity;
                    $('#horizontalDensity_input').val(`${hDensity}`);
                });
                $("#verticalDensity").mousemove(function () {
                    const vDensity = $(this).val();
                    layer.particleVelocityFieldEffect.verticalDensity = vDensity;
                    $('#verticalDensity_input').val(`${vDensity}`);
                });
                $("#velocityScale").mousemove(function () {
                    const scale = $(this).val();
                    layer.particleVelocityFieldEffect.velocityScale = scale;
                    $('#velocityScale_input').val(`${scale}`);
                });


            }, function (e) {
                consoloe.log(e);
            });

            function initLayer(layer) {
                $('#timeDim').empty();//先清空options

                let menu = document.getElementById('timeDim');
                let fieldName = layer.temporalSetting.getFieldName(SuperMap3D.CategoryFieldName.RasterField);

                let timeSize = layer.temporaInfos[fieldName].sizeInfo.allTemporalCount;
                for (let i = 1; i <= timeSize; i++) {
                    var option = document.createElement('option');
                    option.innerHTML = `时序-${i}`;
                    option.value = parseInt(i);
                    menu.appendChild(option);
                }
                $('#layersList').val(1);


                layer.particleVelocityFieldEffect.velocityScale = 10;
                layer.particleVelocityFieldEffect.particleSize = 2;
                layer.particleVelocityFieldEffect.imageSizeInMeters = true;
                layer.particleVelocityFieldEffect.horizontalDensity = 50;

                $("#velocityScale").val(10);
                $("#particleSize").val(2);
                $("#horizontalDensity").val(50);
                $("#particleMode").val(1);

                setHypsometric(layer);
            }


            function setHypsometric(layer) {
                var hyp = new SuperMap3D.HypsometricSetting();

                let floor = 0;
                let ceil = 0.1;
                let dx = (ceil - floor) / 5;
                const colorTable = new SuperMap3D.ColorTable();
                colorTable.insert(floor, new SuperMap3D.Color(255 / 255, 35 / 255, 35 / 255, 1.0));
                colorTable.insert(floor + dx, new SuperMap3D.Color(223 / 255, 202 / 255, 67 / 255, 1.0));
                colorTable.insert(floor + dx * 2, new SuperMap3D.Color(116 / 255, 205 / 255, 180 / 255, 1.0));
                colorTable.insert(floor + dx * 3, new SuperMap3D.Color(107 / 255, 159 / 255, 204 / 255, 1.0));
                colorTable.insert(floor + dx * 4, new SuperMap3D.Color(107 / 255, 143 / 255, 204 / 255, 1.0));

                hyp.ColorTable = colorTable;
                //设置图层分层设色属性
                layer.hypsometricSetting = {
                    hypsometricSetting: hyp,
                    analysisMode: SuperMap3D.HypsometricSettingEnum.AnalysisRegionMode.ARM_ALL
                };
            }
        }
        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>