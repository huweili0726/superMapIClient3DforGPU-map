<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>聚合</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/spectrum.js"></script>
    <script src="./js/kdbush/kdbush.js"></script>
    <script src="./js/config.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>

    <script>
        function onload(SuperMap3D) {
            // 通过config.js中的getEngineType,获取引擎类型（EngineType）用于设置启动方式
            let EngineType = getEngineType();
            let viewer = new SuperMap3D.Viewer('Container', {
                infoBox:false,
                contextOptions: {
                    contextType: Number(EngineType), // Webgl2:2 ; WebGPU:3
                }
            });

            viewer.resolutionScale = window.devicePixelRatio;

            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }

        function init(SuperMap3D, scene, viewer) {
            // 加载高德影像地图
            viewer.imageryLayers.addImageryProvider(new SuperMap3D.UrlTemplateImageryProvider({
                url: 'https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                minimumLevel: 3,
                maximumLevel: 18,
            }));

            viewer.dataSources.add(
                new SuperMap3D.GeoJsonDataSource()
                    .load("./data/json/clustering.geojson")
                    .then((dataSource) => {
                        // 设置聚合参数
                        dataSource.clustering.enabled = true;
                        dataSource.clustering.pixelRange = 60;
                        dataSource.clustering.minimumClusterSize = 2;
                        dataSource.entities.values.forEach((entity) => {
                            // 将点拉伸一定高度，防止被地形压盖
                            entity.position._value.z += 2000;
                            entity._id = `mark-${entity.id}`;
                            entity.billboard = {
                                image: "./images/EntityGeometry/mark.png",
                                width: 32,
                                height: 32,
                            };
                        });
                        dataSource.clustering.clusterEvent.addEventListener(
                            (clusteredEntities, cluster) => {
                                // 关闭自带的显示聚合数量的标签
                                cluster.label.show = false;
                                cluster.billboard.show = true;
                                cluster.billboard.verticalOrigin = SuperMap3D.VerticalOrigin.BOTTOM;

                                cluster.billboard.image = combineIconAndLabel(
                                    clusteredEntities.length,
                                    128,
                                    // "./images/EntityGeometry/mark-icon.png",
                                );
                                cluster.billboard.width = 40;
                                cluster.billboard.height = 40;
                            }
                        );
                        return dataSource;
                    })
            );

            viewer.camera.setView({
                destination: SuperMap3D.Cartesian3.fromDegrees(120.36, 36.09, 40000),
            });

            /**
            * @description: 将图片和文字合成新图标使用（参考SuperMap3D源码）
            * @param {*} label：文字
            * @param {*} size：画布大小
            * @param {*} url：图片地址
            * @return {*} 返回canvas
            */
            function combineIconAndLabel(label, size ,url) {
                // 创建画布对象
                let canvas = document.createElement("canvas");
                canvas.width = size;
                canvas.height = size;
                let ctx = canvas.getContext("2d");

                function renderLable(ctx, label, size) {
                    // 渲染字体
                    ctx.fillStyle = SuperMap3D.Color.BLACK.toCssColorString();
                    ctx.font = "bold 60px Microsoft YaHei";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillStyle = "rgb(255, 255, 255, 0.85)"
                    ctx.fillText(label, size / 2, size / 2);
                }

                if(url){
                    let promise = new SuperMap3D.Resource.fetchImage(url).then((image) => {
                        // 渲染图片
                        try {
                            ctx.drawImage(image, 0, 0,size,size);
                        } catch (e) {
                            console.log(e);
                        }

                        renderLable(ctx, label, size);
                        return canvas;
                    });
                    return promise;
                }else{ 
                    // 渲染圆圈
                    let x = y = radius = size / 2;
                    ctx.arc(x, y, radius, 0, 2 * Math.PI, false);
                    let lable_number = Number(label);
                    if (lable_number > 10) {
                        ctx.fillStyle = 'rgba(255,0,0,0.5)';
                    } else if (lable_number > 5) {
                        ctx.fillStyle = 'rgba(255,165,0,0.5)';
                    } else if (lable_number <= 5) {
                        ctx.fillStyle = 'rgba(0,128,0,0.5)';
                    }
                    ctx.fill();

                    // 渲染字体
                    renderLable(ctx, label, size);

                    return canvas;
                }
            }

            $('#loadingbar').remove();
        }
        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>