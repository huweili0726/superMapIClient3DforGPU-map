<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>交通仿真</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./style/trafficSimulation.css" rel="stylesheet">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/config.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>

    <div id="toolbar" class="tool-bar param-container">
        <div class="param-item">
            <input type="checkbox" id="bubble">
            <label>显示气泡信息</label>
            <input type="checkbox" id="select">
            <label>选中车辆跟随</label>
        </div>
        <div class="param-item">
            <label>气泡最小可见性:</label>
            <input id="minVisual" type="number" value="10" style="text-align: center">
        </div>
        <div class="param-item">
            <label>气泡最大可见性:</label>
            <input id="maxVisual" type="number" value="1000" style="text-align: center">
        </div>

    </div>
    <script>
        function onload(SuperMap3D) {
            // 通过config.js中的getEngineType,获取引擎类型（EngineType）用于设置启动方式
            var EngineType = getEngineType(); 
            let viewer = new SuperMap3D.Viewer('Container', {
                contextOptions: {
                    contextType: Number(EngineType), // Webgl2:2 ; WebGPU:3
                },
                shouldAnimate: true,  //打开时间
                infoBox: false,
                selectionIndicator: false
            });
            viewer.scenePromise.then(function(scene){
                init(SuperMap3D, scene, viewer);
            });
        }
        function init(SuperMap3D, scene, viewer){
            // 环境设置
            scene.shadowMap.darkness = 1.275; //设置第二重烘焙纹理的效果（明暗程度）
            scene.debugShowFramesPerSecond = true;
            scene.hdrEnabled = false;
            scene.sun.show = true;

            // 定义变量
            let sceneUrl = URL_CONFIG.SCENE_CBD;
            let dataUrl = "http://www.supermapol.com/realspace/services/data-road/rest/data/featureResults.rjson?returnContent=true";
            let timeInterval;
            let modelUrls = [ //加载模型信息,若要使用webgpu只能用gltf 2.0数据
                './SampleData/models/car.gltf',
                './SampleData/models/car.gltf',
                './SampleData/models/car.gltf',
                './SampleData/models/car.gltf'
            ];
            let speed = 10; //速度 m/s
            let showBubble = false;  //显示气泡
            let near = parseFloat($("#minVisual").val());//调节最大最小可见距离
            let far = parseFloat($("#maxVisual").val());
            let distanceDisplayCondition = new SuperMap3D.DistanceDisplayCondition(near, far);
            let selected = false; //是否选中模型跟随
            let isInterpolation = true;  //是否平滑标签运动

            let promise = scene.open(sceneUrl);
            promise.then(function () {
                scene.camera.setView({
                    destination: new SuperMap3D.Cartesian3.fromDegrees(116.45767224455432, 39.9099165872182, 107.471387926923),
                    orientation: {
                        heading: 3.770997,
                        pitch: -0.332010,
                        roll: 6.283185307179563
                    }
                });

                //创建车辆路线
                function createCarLines(routes) {
                    let count = routes.length;
                    let startLines = [];
                    let otherLines = [];
                    let startLine, otherLine;
                    for (let i = 0; i < count; i++) {
                        let line = routes[i];
                        let point3ds = line.geometry.points;
                        let isStart = line.fieldValues[12];
                        if (isStart == 'true') {
                            startline = [].concat(point3ds);
                            startLines.push(startline);
                        } else {
                            otherLine = [].concat(point3ds);
                            otherLines.push(otherLine);
                        }
                    }
                    return startLines;

                }

                // 获取车辆所有路线
                function getRouoteLines() {
                    let sqlParameter = {
                        "datasetNames": ["CBD车道:" + "车道三维"],
                        getFeatureMode: "SQL",
                        queryParameter: {
                            attributeFilter: "SMID>0"
                        }
                    };
                    let queryData = JSON.stringify(sqlParameter);
                    return $.ajax({ type: "post", url: dataUrl, data: queryData }).then((result) => {
                        let resultObj = JSON.parse(result);
                        if (resultObj.featureCount > 0) {
                            return createCarLines(resultObj.features);
                        }
                        return []
                    })
                }

                // 创建车和标签
                function createCarAndLabel(coordinates, modelUrl, line) {
                    let property = new SuperMap3D.SampledPositionProperty();
                    const length = coordinates.length;
                    let start = viewer.clock.currentTime.clone();
                    let stopTime = 0;
                    let timeArr = [];
                    let positions = [];
                    for (let i = 1; i < length; i += 1) {
                        let pos1 = SuperMap3D.Cartesian3.fromDegrees(coordinates[i - 1].x, coordinates[i - 1].y, coordinates[i - 1].z);
                        let pos2 = SuperMap3D.Cartesian3.fromDegrees(coordinates[i].x, coordinates[i].y, coordinates[i].z);
                        let dis = SuperMap3D.Cartesian3.distance(pos1, pos2);
                        stopTime += dis / speed;
                        const time = SuperMap3D.JulianDate.addSeconds(start, stopTime, new SuperMap3D.JulianDate());
                        timeArr.push(time);
                        positions.push(pos2);
                    }
                    property.addSamples(timeArr, positions);
                    if (isInterpolation) { //是否插值失标签平滑运动
                        property.setInterpolationOptions({ // 点插值
                            interpolationDegree: 5,
                            interpolationAlgorithm: SuperMap3D.LagrangePolynomialApproximation, //LagrangePolynomialApproximation LinearApproximation  HermitePolynomialApproximation
                        });
                    }
                    let entity = viewer.entities.add({
                        // id: id,
                        position: property,
                        orientation: new SuperMap3D.VelocityOrientationProperty(property),
                        label: {
                            text: '车辆',
                            font: '14px sans-serif',
                            fillColor: SuperMap3D.Color.SKYBLUE,
                            outlineColor: SuperMap3D.Color.BLACK,
                            outlineWidth: 1,
                            style: SuperMap3D.LabelStyle.FILL_AND_OUTLINE,
                            eyeOffset: new SuperMap3D.Cartesian3(0, 4, 0),
                            scaleByDistance: new SuperMap3D.NearFarScalar(0, 1.5, 500, 1),
                            show: new SuperMap3D.CallbackProperty(function () {
                                return showBubble;
                            }, false),
                            distanceDisplayCondition: new SuperMap3D.CallbackProperty(function () {
                                return distanceDisplayCondition
                            }, false)
                        },
                        model: {
                            uri: modelUrl, //plane  SuperMap_Ground
                            scale: 2.0
                        },
                    });
                    setTimeout(() => {
                        viewer.entities.remove(entity);
                        createCarAndLabel(line, modelUrl, line);
                    }, stopTime * 1000);
                }

                async function addCarsAndTabels() {
                    let lines = await getRouoteLines();
                    let linesLen = lines.length;
                    for (let i = 0; i < linesLen; i++) {
                        for (let j = 0; j < modelUrls.length; j++) {
                            let modelUrl = modelUrls[j];
                            let line = lines[i];
                            let index = Math.floor(Math.random() * (line.length - 1)); //一条路线上随机的取一个点作为车辆的起始位置
                            let point = line[index];
                            if (!point) continue;
                            createCarAndLabel(line.slice(index), modelUrl, line);
                        }
                    }
                    $('#loadingbar').remove();
                }

                addCarsAndTabels();

                $("#bubble").on('input', function () {
                    showBubble = $(this).prop("checked");
                });

                $("#select").on('input', function () {
                    viewer.trackedEntity = null;
                    clearListenerTracked();
                    selected = $(this).prop("checked");
                });

                $("#minVisual,#maxVisual").on('input', function () {
                    let near = parseFloat($("#minVisual").val());
                    let far = parseFloat($("#maxVisual").val());
                    if (near >= far) {
                        return;
                    }
                    distanceDisplayCondition.near = near;
                    distanceDisplayCondition.far = far;
                });

            }, function () {
                let title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？';
            });


            // 第一视角跟随
            let scratch = new SuperMap3D.Matrix4();
            function setCameraPosition(entity, time, offset = new SuperMap3D.Cartesian3(-20, 0, 3)) {
                const position = entity.position.getValue(time);
                const orientation = entity.orientation.getValue(time);
                if (!SuperMap3D.defined(position)) {
                    clearListenerTracked();
                    return undefined;
                }
                if (!SuperMap3D.defined(orientation)) {
                    scratch = SuperMap3D.Transforms.eastNorthUpToFixedFrame(position, undefined, this.scratch);
                } else {
                    scratch = SuperMap3D.Matrix4.fromRotationTranslation(SuperMap3D.Matrix3.fromQuaternion(orientation), position, scratch);
                }
                // let m = SuperMap3D.Matrix4.setTranslation(SuperMap3D.Matrix4.IDENTITY,new SuperMap3D.Cartesian3(0, 0, 4),new SuperMap3D.Matrix4()) //设置视角参考点偏移，默认为模型中心点
                // scratch =  SuperMap3D.Matrix4.multiply(scratch, m, scratch);
                viewer.scene.camera.lookAtTransform(scratch, offset); // 修改相机
            }

            let listener;
            function addListenerTracked(entity) {
                clearListenerTracked();
                listener = viewer.scene.preRender.addEventListener((scene, time) => {
                    setCameraPosition(entity, time)
                });
            }

            function clearListenerTracked() {
                if (listener) {
                    listener();
                    listener = null;
                }
                viewer.camera.lookAtTransform(SuperMap3D.Matrix4.IDENTITY);
                viewer.trackedEntity = null;
            }


            //鼠标左键选中小车实现跟踪
            let screenSpaceEventHandler = new SuperMap3D.ScreenSpaceEventHandler(scene.canvas);
            screenSpaceEventHandler.setInputAction(function (e) {
                if (!selected) return;
                scene.pickAsync(e.position).then(function(pickedObject){
                    if (!pickedObject || pickedObject?.primitive instanceof SuperMap3D.S3MTilesLayer) return;
                    addListenerTracked(pickedObject.id);
                });
            }, SuperMap3D.ScreenSpaceEventType.LEFT_CLICK);

            $('#loadingbar').remove();
        }

        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>