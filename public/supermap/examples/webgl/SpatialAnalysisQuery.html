<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>空间分析查询</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <link href="./style/sunLightAnalysis.css" rel="stylesheet">
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/tooltip.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>
    <div id='toolbar' style="position: absolute;left: 5px;top: 5px;">
        <div class="titleBox">
            <div class="titl">空间分析查询</div>
            <span class="close2" aria-hidden="false">x</span>
        </div>

        <div class="inputBox">
            <label class="lab" for="queryMode">查询模式</label>
            <select id="queryMode" class="selectstyle">
                <option value="INTERSECTS" selected>相交</option>
                <option value="DISJOINT">相离</option>
                <option value="CONTAINS" disabled>包含</option>
            </select>
        </div>
        <div class="inputBox">
            <label class="lab" for="queryWay">查询方式</label>
            <select id="queryWay" class="selectstyle">
                <option value="polygon" selected>三维面</option>
                <option value="volume">三维体</option>
            </select>
        </div>
        <div style="margin: 0 0 12px 110px;">
            <button type="button" id="draw" class="btn_foot" style=" background:rgba(52,153,229,1);">绘制</button>
            <button type="button" id="clear" class="btn_foot"
                style="border: 1px solid rgba(255, 255, 255, .65);color:rgba(255, 255, 255, .65)">清除</button>
        </div>
    </div>

    <script>
        function onload(SuperMap3D) {
            // 通过config.js中的getEngineType,获取引擎类型（EngineType）用于设置启动方式
            const EngineType = getEngineType();
            const viewer = new SuperMap3D.Viewer('Container', {
                contextOptions: {
                    contextType: Number(EngineType), // Webgl2:2 ; WebGPU:3
                }
            });

            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }
        function init(SuperMap3D, scene, viewer) {
            viewer.resolutionScale = window.devicePixelRatio;

            // // 加载高德影像地图
            // viewer.imageryLayers.addImageryProvider(new SuperMap3D.UrlTemplateImageryProvider({
            //     url: 'https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
            //     minimumLevel: 3,
            //     maximumLevel: 18,
            // }));


            const widget = viewer.Widget;
            const tooltip = createTooltip(document.body);

            const spatialanalystUrl = "http://172.16.120.103:8091/iserver/services/spatialAnalysis-CBD/restjsr/spatialanalyst/datasets/Building@CBD/spatialquery3d.json";
            const materialColor = SuperMap3D.Color.fromCssColorString("rgba(224,207,226,0.65)")
            const heightLightColor = SuperMap3D.Color.RED;
            const handlerPolygon = new SuperMap3D.DrawHandler(viewer, SuperMap3D.DrawMode.Polygon);
            const handlerVolume = new SuperMap3D.DrawHandler(viewer, SuperMap3D.DrawMode.Polygon);
            const handlerOrthogonal = new SuperMap3D.ScreenSpaceEventHandler(viewer.scene.canvas);

            let extrudedHeight = 1;
            let bodyEntity = undefined;
            let buildLayer = undefined;

            try {
                // const promise = scene.open("http://172.16.120.191:8090/iserver/services/3D-CBDCache20200416/rest/realspace"); // ID不对应
                const promise = scene.open("http://172.16.120.103:8091/iserver/services/3D-KJCXcbd/rest/realspace"); // ID对应：同一个数据集发的三维服务和分析服务
                promise.then(function (layer) {
                    buildLayer = viewer.scene.layers.find("Building");

                    // 三维面handler
                    handlerPolygon.activeEvt.addEventListener(function (isActive) {
                        if (isActive == true) {
                            viewer.enableCursorStyle = false;
                            viewer._element.style.cursor = '';
                            $('body').removeClass('drawCur').addClass('drawCur');
                        } else {
                            viewer.enableCursorStyle = true;
                            $('body').removeClass('drawCur');
                        }
                    });
                    handlerPolygon.movingEvt.addEventListener(function (windowPosition) {
                        if (windowPosition.x < 210 && windowPosition.y < 120) {
                            tooltip.setVisible(false);
                            return;
                        }
                        if (handlerPolygon.isDrawing) {
                            tooltip.showAt(windowPosition, '<p>点击确定查询区域中间点</p><p>右键单击结束绘制</p>');
                        } else {
                            tooltip.showAt(windowPosition, '<p>点击绘制查询区域第一个点</p>');
                        }
                    });
                    handlerPolygon.drawEvt.addEventListener(function (result) {
                        tooltip.setVisible(false);

                        const positions = result.positions;
                        const points = [];
                        for (let i = 0; i < positions.length; i++) {
                            const position = positions[i];
                            const trans = cartesiantoDegrees(position);
                            const point = { // 查询点对象
                                x: trans[0],
                                y: trans[1],
                                z: trans[2]
                            };
                            points.push(point);
                        }

                        queryBySpatialanalyst(points);
                    });

                    // 三维体handler
                    handlerVolume.activeEvt.addEventListener(function (isActive) {
                        if (isActive == true) {
                            viewer.enableCursorStyle = false;
                            viewer._element.style.cursor = '';
                            $('body').removeClass('drawCur').addClass('drawCur');
                        } else {
                            viewer.enableCursorStyle = true;
                            $('body').removeClass('drawCur');
                        }
                    });
                    handlerVolume.movingEvt.addEventListener(function (windowPosition) {
                        tooltip.showAt(windowPosition, '<p>绘制底面</p>');
                    });
                    handlerVolume.drawEvt.addEventListener(function (res) {
                        bodyEntity = createBaseSurface(res.positions);

                        if (handlerVolume.polygon) handlerVolume.polygon.show = false;
                        if (handlerVolume.polyline) handlerVolume.polyline.show = false;
                        handlerVolume.deactivate();
                        tooltip.setVisible(false);

                        handlerOrthogonal.setInputAction(e => {
                            tooltip.showAt(e.endPosition, '<p>鼠标上下拉伸面实体,左键双击结束</p>');

                            // 实现编辑Z轴，获取Z轴上编辑后的点坐标
                            let pWindow = e.endPosition;
                            let editPoint = getEditZPoint(pWindow, res.positions);
                            let degree = cartesiantoDegrees(editPoint);

                            if (degree[2] > 1) {
                                extrudedHeight = degree[2];
                            } else {
                                extrudedHeight = 1;
                            }

                        }, SuperMap3D.ScreenSpaceEventType.MOUSE_MOVE);

                        // 左键双击移除拉伸事件
                        handlerOrthogonal.setInputAction(e => {
                            viewer.trackedEntity = undefined;
                            handlerOrthogonal.removeInputAction(SuperMap3D.ScreenSpaceEventType.MOUSE_MOVE);//移除事件
                            $('body').removeClass('drawCur');
                            if (!handlerOrthogonal.isDestroyed()) handlerOrthogonal.destroy;
                            tooltip.setVisible(false);

                            // 处理查询逻辑
                            const positions = res.positions;
                            const points = [];
                            for (let i = 0; i < positions.length; i++) {
                                const position = positions[i];
                                const trans = cartesiantoDegrees(position);
                                const point = { // 查询点对象,可不包含z高度值，查询使用拉伸高度
                                    x: trans[0],
                                    y: trans[1]
                                };
                                points.push(point);
                            }

                            queryBySpatialanalyst(points, extrudedHeight);
                        }, SuperMap3D.ScreenSpaceEventType.LEFT_DOUBLE_CLICK)
                    })

                }, function () {
                    const title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？';
                    widget.showErrorPanel(title, undefined, e);
                });
            } catch (e) {
                if (widget._showRenderLoopErrors) {
                    const title = '渲染时发生错误，已停止渲染。';
                    widget.showErrorPanel(title, undefined, e);
                }
            }

            // 创建面entity
            function createBaseSurface(pos, material) {
                let entity = viewer?.entities.add({
                    show: true,
                    name: 'add-surface-1',
                    polygon: {
                        hierarchy: {
                            positions: [...pos],
                        },
                        material: materialColor,
                        perPositionHeight: false,
                        extrudedHeight: new SuperMap3D.CallbackProperty(function () {
                            return extrudedHeight;
                        }, false)
                    }
                });
                return entity;
            }

            // 实现编辑Z轴
            function getEditZPoint(windowPosition, cornerPointArray) {
                let ray0 = viewer.camera.getPickRay(windowPosition);
                let pWindow1 = new SuperMap3D.Cartesian2(windowPosition.x + 5, windowPosition.y);
                let ray1 = viewer.camera.getPickRay(pWindow1);

                let normal = new SuperMap3D.Cartesian3();
                normal = SuperMap3D.Cartesian3.cross(ray0.direction, ray1.direction, normal);

                let normalize = new SuperMap3D.Cartesian3();
                SuperMap3D.Cartesian3.normalize(normal, normalize);
                let plane = SuperMap3D.Plane.fromPointNormal(viewer.camera.position, normalize);

                let ray = new SuperMap3D.Ray(SuperMap3D.Cartesian3.ZERO, cornerPointArray[cornerPointArray.length - 1])
                let editPoint = SuperMap3D.IntersectionTests.rayPlane(ray, plane);

                return editPoint;
            }

            //笛卡尔转经纬度
            function cartesiantoDegrees(Cartesians) {
                let array = [].concat(Cartesians);
                let positions = [];
                for (let i = 0, len = array.length; i < len; i++) {
                    let cartographic = SuperMap3D.Cartographic.fromCartesian(array[i]);
                    let longitude = Number(SuperMap3D.Math.toDegrees(cartographic.longitude));
                    let latitude = Number(SuperMap3D.Math.toDegrees(cartographic.latitude));
                    let h = Number(cartographic.height);
                    if (positions.indexOf(longitude) == -1 && positions.indexOf(latitude) == -1) {
                        positions.push(longitude);
                        positions.push(latitude);
                        positions.push(h);
                    }
                }
                return positions
            };

            // 测试服务
            // 服务：http://172.16.120.103:8091/iserver/services/spatialAnalysis-CBD/restjsr/spatialanalyst/datasets/Building@CBD/spatialquery3d
            // 参数：{"type":"REGION3D" ,"points":[{"x":116.45128694936257,"y":39.912270977305916,"z":300},{"x":116.4549355762918,"y":39.91224872348007,"z":300},{"x": 116.45160761907131,"y":39.91053409808734,"z":300}]}
            function queryBySpatialanalyst(queryPoints, extendedHeight) {

                // 查询模式
                const queryMode = $("#queryMode :selected").val();

                const queryObj = {
                    "operateRegion": {
                        "type": "REGION3D",
                        "points": queryPoints
                    },
                    "bottomAltitude": "0",
                    "extendedHeight": extendedHeight ?? "0",
                    "sourceDatasetFilter": {
                        "attributeFilter": ""
                    },
                    "positionMode": queryMode ?? "INTERSECTS", // "DISJOINT"相离 "INTERSECTS"相交  "CONTAINS"包含
                }
                console.log("查询参数：", queryObj);

                const queryData = JSON.stringify(queryObj); // 转化为JSON字符串作为查询参数

                // 先发送POST请求，得到分析结果资源
                $.ajax({
                    url: spatialanalystUrl,
                    async: true,
                    data: queryData,
                    method: "POST"
                }).done(function (result) {
                    // 再发送一次GET请求，获取到具体的IDs列表
                    $.ajax({
                        url: result.newResourceLocation + ".json",
                        method: "GET"
                    }).done(function (data) {
                        console.log("ID列表:", data.ids);

                        // 后续可根据模型ID，调用数据服务或者IndexDB查询属性信息
                        if (data && data.ids && data.ids.length > 0) {

                            // 设置模型高亮
                            buildLayer.removeAllObjsColor();
                            buildLayer.setObjsColor(data.ids, heightLightColor);
                        }

                    })
                });

            }

            function clear() {
                const queryWay = $("#queryMode :selected").val();
                if (queryWay === 'volume') {
                    if (handlerPolygon.polygon) handlerPolygon.polygon.show = false;
                    if (handlerPolygon.polygon) handlerPolygon.polyline.show = false;
                }

                if (bodyEntity) {
                    viewer.entities.remove(bodyEntity);
                    bodyEntity = undefined;
                    extrudedHeight = 1;
                }

                buildLayer && buildLayer.removeAllObjsColor();
            }

            $("#draw").click(function () {
                clear();

                const queryWay = $("#queryWay :selected").val();
                if (queryWay === 'polygon') { // 三维面查询
                    handlerPolygon.activate();
                } else { // 三维体查询
                    handlerVolume.activate();
                }
            });

            // 处理三维面、三维体切换对查询模式有限制的逻辑
            $('#queryWay').change(function () {
                $("#queryMode option").each(function () {
                    $(this).removeAttr("disabled");
                })

                const queryWay = $("#queryWay :selected").val();
                if (queryWay === 'polygon') { // 三维面在当前范例中仅支持相交和相离
                    $("#queryMode").val("INTERSECTS");
                    $("#queryMode option").each(function () {
                        if ((this).value === "CONTAINS") {
                            $(this).attr("disabled", true)
                        }
                    })
                } else { // 三维体在当前范例中仅支持包含
                    $("#queryMode").val("CONTAINS");
                    $("#queryMode option").each(function () {
                        if ((this).value !== "CONTAINS") {
                            $(this).attr("disabled", true)
                        }
                    })
                }
            });

            $("#clear").click(function () {
                clear();
                if (handlerPolygon.polygon) handlerPolygon.polygon.show = false;
                if (handlerPolygon.polygon) handlerPolygon.polyline.show = false;
            });
            $('#loadingbar').remove();
        }

        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>