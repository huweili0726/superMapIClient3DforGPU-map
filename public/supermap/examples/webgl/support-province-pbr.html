<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>湖北省PBR材质球面场景</title>
  <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
  <link href="./css/pretty.css" rel="stylesheet">
  <script src="./js/jquery.min.js"></script>
  <script src="./js/config.js"></script>
  <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
  <div id="Container"></div>
  <script type="text/javascript">
    function onload(SuperMap3D) {
      const obj = [6378137.0, 6378137.0, 6356752.3142451793];
      SuperMap3D.Ellipsoid.WGS84 = Object.freeze(new SuperMap3D.Ellipsoid(obj[0], obj[1], obj[2]));
      const viewer = new SuperMap3D.Viewer('Container', {
        timeline: false,
        infoBox: false,
        selectionIndicator: false,
      });

      viewer.scenePromise.then(function (scene) {
        init(SuperMap3D, scene, viewer);
      });
    }

    function init(SuperMap3D, scene, viewer) {
      scene.lightSource.visibleDistanceMax = 50000000;
      scene.skyAtmosphere.show = true;
      scene.fog.enabled = false;
      scene.hdrEnabled = true;
      scene.sun.show = true;
      scene.shadowMap = true;
      scene.shadows = true;
      scene.lightSource.ambientLightColor = new SuperMap3D.Color(0.65, 0.65, 0.65, 1);
      
      const endTime = new Date('2017-05-13');
      endTime.setHours(20);
      viewer.clock.currentTime = SuperMap3D.JulianDate.fromDate(endTime);
     
      const widget = viewer.cesiumWidget;
      try {
        viewer.imageryLayers.addImageryProvider(new SuperMap3D.SuperMapImageryProvider({
          url: 'https://www.supermapol.com/realspace/services/map-WorkSpace_pbr1/rest/maps/China_DARK',
        }));

        //打开所发布三维服务下的所有图层
        const url = 'https://www.supermapol.com/realspace/services/3D-WorkSpace_pbr1/rest/realspace';
        const promise = scene.open(url);
        promise.then(function (layers) {
          scene.camera.setView({
            destination: new SuperMap3D.Cartesian3(-2348243.1706049335, 5903410.098378219, 3186906.1012373925),
            orientation: {
              heading: 0.12570799157006984,
              pitch: -1.015089189824093,
              roll: 6.394884621840902e-14
            }
          });
          const layer = viewer.scene.layers.find('pbrmodel');
          layer.selectedColor = SuperMap3D.Color.LIGHTGRAY;
          rotapic();   //底图旋转
          getwall();  //边界拉升墙与各市边线
          getweijixian();  //尾迹线
          fanguang();  //泛光
          lightSource();  //光照
          if (!scene.pickPositionSupported) {
            alert('不支持深度纹理,无法拾取位置！');
          }
        }, function (e) {
          if (widget._showRenderLoopErrors) {
            let title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？';
            widget.showErrorPanel(title, undefined, e);
          }
        });
      } catch (e) {
        if (widget._showRenderLoopErrors) {
          let title = '渲染时发生错误，已停止渲染。';
          widget.showErrorPanel(title, undefined, e);
        }
      }

      let pointLight1, pointLight2, pointLight3, pointLight4;

      function lightSource() {
        let position1 = new SuperMap3D.Cartesian3.fromDegrees(112.93148639465068, 32.96111077680518, 200000);
        let position2 = new SuperMap3D.Cartesian3.fromDegrees(111.7615563319393, 28.76267842539194, 200000);
        let position3 = new SuperMap3D.Cartesian3.fromDegrees(107.61844848814378, 31.805333082173135, 200000);
        let position4 = new SuperMap3D.Cartesian3.fromDegrees(117.62221244748726, 29.429625217914637, 200000);
        let options = {
          color: SuperMap3D.Color.WHITE,
          cutoffDistance: 5165200,
          decay: 10,
          intensity: 15.2
        };
        pointLight1 = new SuperMap3D.PointLight(position1, options);
        pointLight2 = new SuperMap3D.PointLight(position2, options);
        pointLight3 = new SuperMap3D.PointLight(position3, options);
        pointLight4 = new SuperMap3D.PointLight(position4, options);
        scene.addLightSource(pointLight1);
        scene.addLightSource(pointLight2);
        scene.addLightSource(pointLight3);
        scene.addLightSource(pointLight4);
      }

      let rotation = SuperMap3D.Math.toRadians(30);
      function rotapic() {
        let POIEntity = viewer.entities.add({     //底部旋转图片
          name: "test1",
          position: SuperMap3D.Cartesian3.fromDegrees(112.493897091852, 31.052776658956, 3000),
          ellipse: {
            semiMinorAxis: 400000,
            semiMajorAxis: 400000,
            height: 3000,
            material: new SuperMap3D.ImageMaterialProperty({
              image: './support/imgs/bottom_circle_green.png',
              repeat: new SuperMap3D.Cartesian2(1, 1),
              transparent: true,
              color: new SuperMap3D.Color(8 / 255, 76 / 255, 167 / 255)
            }),
            rotation: new SuperMap3D.CallbackProperty(getRotationValue, false),
            stRotation: new SuperMap3D.CallbackProperty(getRotationValue, false),
            outline: false,
            numberOfVerticalLines: 100
          },
          description: '测试数据'
        });
      }

      function getRotationValue() {
        rotation += 0.001;
        return rotation;
      }

      function fanguang() {
        scene.bloomEffect.show = true;//开启泛光
        scene.bloomEffect.threshold = 10;
        scene.bloomEffect.bloomIntensity = 0.05;
        scene.hdrEnabled = true; // 开启hdr
      }

      function getwall() {
        let sqlParameter = {
          datasetNames: ["DataSource:bianjie"],
          getFeatureMode: "SQL",
          queryParameter: {
            attributeFilter: "smid>0"
          }
        };
        let url = "https://www.supermapol.com/proxy/11d78d147afa4b5e/iserver/services/data_hubeipbr_m2zutfns/rest/data/featureResults.rjson?returnContent=true";
        let queryData = JSON.stringify(sqlParameter);
        $.ajax({
          type: "post",
          url: url,
          data: queryData,
          success: function (result) {
            let resultObj = JSON.parse(result);
            for (let i of resultObj.features) {
              addwall(i);
            }
          },
          error: function (msg) {
            console.log(msg);
          },
        })
      }

      function getweijixian() {
        let sqlParameter = {
          datasetNames: ["DataSource:weijixian"],
          getFeatureMode: "SQL",
          queryParameter: {
            attributeFilter: "smid>0"
          }
        };
        let url = "https://www.supermapol.com/proxy/11d78d147afa4b5e/iserver/services/data_hubeipbr_m2zutfns/rest/data/featureResults.rjson?returnContent=true";
        let queryData = JSON.stringify(sqlParameter);
        $.ajax({
          type: "post",
          url: url,
          data: queryData,
          success: function (result) {
            let resultObj = JSON.parse(result);
            for (let i of resultObj.features) {
              addweijixian(i);
            }
          },
          error: function (msg) {
            console.log(msg);
          },
        })
      }

      function addweijixian(feature) {
        let lonLatArr = getLonLatArray2(feature.geometry.points);
        viewer.entities.add({
          polyline: {
            positions: new SuperMap3D.Cartesian3.fromDegreesArrayHeights(lonLatArr),
            material: new SuperMap3D.PolylineTrailMaterialProperty({ // 尾迹线材质
              color: new SuperMap3D.Color(0, 2.88, 23.9, 1.0),
              trailLength: 0.7,
              period: 10.0,
            }),
            width: 2
          }
        });
      }

      function addwall(feature) {
        let lonLatArr = getLonLatArray(feature);
        let minHeights = getMinHeights(feature.geometry.points);
        let maxHeights = getMaxHeights(feature);
        viewer.entities.add({
          wall: {
            positions: new SuperMap3D.Cartesian3.fromDegreesArrayHeights(lonLatArr),
            minimumHeights: minHeights,
            maximumHeights: maxHeights,
            material: SuperMap3D.Color.GRAY
          },
          polyline: {
            positions: new SuperMap3D.Cartesian3.fromDegreesArrayHeights(lonLatArr),
            material: new SuperMap3D.PolylineGlowMaterialProperty({
              glowPower: 0.2,
              color: SuperMap3D.Color.LIGHTSKYBLUE,
            }),
            width: 2
          }
        });
      }

      function getLonLatArray(featrue) {
        let points = featrue.geometry.points;
        let point3D = [];
        points.forEach(function (point) {
          point3D.push(point.x);
          point3D.push(point.y);
          point3D.push(Number(featrue.fieldValues[11]));
        });
        return point3D;
      }

      function getLonLatArray2(points) {
        let point3D = [];
        points.forEach(function (point) {
          point3D.push(point.x);
          point3D.push(point.y);
          point3D.push(13000);
        });
        return point3D;
      }

      function getMaxHeights(featrue) {
        let points = featrue.geometry.points;
        let MaxHeight = [];
        points.forEach(function (point) {
          MaxHeight.push(Number(featrue.fieldValues[11]));
        });
        return MaxHeight;
      }

      function getMinHeights(points) {
        let MinHeight = [];
        points.forEach(function (point) {
          MinHeight.push(0);
        });
        return MinHeight;
      }

      $('#loadingbar').remove();
    }

    if (typeof SuperMap3D !== 'undefined') {
      window.startupCalled = true;
      onload(SuperMap3D);
    }
  </script>
</body>

</html>