<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>重庆市影像地形图</title>
  <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
  <link href="./css/pretty.css" rel="stylesheet">
  <script src="./js/jquery.min.js"></script>
  <script src="./js/config.js"></script>
  <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
  <div id="Container"></div>
  <script type="text/javascript">
    function onload(SuperMap3D) {
      let EngineType = getEngineType();
      const xres = parseInt(window.screen.width * window.devicePixelRatio);
      const yres = parseInt(window.screen.height * window.devicePixelRatio);
      const viewer = new SuperMap3D.Viewer('Container', {
        baseLayerPicker: false,
        orderIndependentTranslucency: false,
        shouldAnimate: true,
        infoBox: false,
        contextOptions: {
          contextType: Number(EngineType),  // Webgl2:2 ; WebGPU:3
          webgl: {
            alpha: true
          },
          maxDrawingBufferWidth: xres,
          maxDrawingBufferHeight: yres
        }
      });

      viewer.scenePromise.then(function (scene) {
        init(SuperMap3D, scene, viewer);
      });
    }

    function init(SuperMap3D, scene, viewer) {
      viewer.resolutionScale = window.devicePixelRatio;
      viewer.useBrowserRecommendedResolution = true;
      
      scene.lightSource.ambientLightColor = new SuperMap3D.Color(0.1, 0.1, 0.1, 1);
      scene.debugShowFramesPerSecond = false;  //帧率信息
      scene.hdrEnabled = false;
  
      //设置系统时间为中午12点，改变太阳光照效果
      const endTime = new Date('2017-05-13');
      endTime.setHours(12);
      viewer.clock.currentTime = SuperMap3D.JulianDate.fromDate(endTime);

      //创建图标集合
      const datasource1 = new SuperMap3D.CustomDataSource("datasource1");
      viewer.dataSources.add(datasource1);
      const datasource2 = new SuperMap3D.CustomDataSource("datasource2");
      viewer.dataSources.add(datasource2);

      const widget = viewer.cesiumWidget;
      try {
        //打开所发布三维服务下的所有图层
        const url = 'https://www.supermapol.com/realspace/services/3D-WorkSpace_CQdemdom/rest/realspace';
        const promise = scene.open(url);
        promise.then(function (layers) {
          for (let i = 0; i < layers.length; i++) {
            layers[i].isOverlapDisplayed = true;  //标签图标不被遮挡
            layers[i].orderIndependentTranslucency = true;  //透明排序
          }
          SuperMap3D.MemoryManager.setCacheSize(2048);
          const layer = viewer.scene.layers.find('S3MB');
          layer.selectEnabled = false;  //图层不可选中
          layer.hue = 6.2;   //调整图层色调
          layer.contrast = 0.88;   //调整图层对比度
          layer.brightness = 1.8;   //调整图层亮度
          layer.saturation = 1.56;
          getLabel();
          rotapic();   //底图旋转
          setWall();  //呼吸墙以及尾迹线
          setFanGuang();  //设置泛光            			
          if (!scene.pickPositionSupported) {
            alert('不支持深度纹理,无法拾取位置！');
          }
        }, function (e) {
          if (widget._showRenderLoopErrors) {
            let title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？';
            widget.showErrorPanel(title, undefined, e);
          }
        });
      } catch (e) {
        if (widget._showRenderLoopErrors) {
          let title = '渲染时发生错误，已停止渲染。';
          widget.showErrorPanel(title, undefined, e);
        }
      }

      function getLabel() {
        $.ajax({
          url: './support/json/ChongQingLabel1.json',
          success: function (data) {
            let geometrys = data.features;
            for (let i = 0; i < geometrys.length; i++) {
              let pos;
              let geometry = geometrys[i].geometry;
              let coordinates = geometry.coordinates;
              let city = geometrys[i].properties.name;
              pos = new SuperMap3D.Cartesian3.fromDegrees(coordinates[0], coordinates[1], coordinates[2]);
              datasource1.entities.add({
                position: pos,
                billboard: {
                  image: './support/imgs/huangbiao.png',
                  verticalOrigin: SuperMap3D.VerticalOrigin.BOTTOM,
                  scale: 0.2,
                  pixelOffset: new SuperMap3D.Cartesian2(0, -10),
                  distanceDisplayCondition: new SuperMap3D.DistanceDisplayCondition(0.0, 200000)
                },
                label: {
                  text: city,
                  outlineColor: SuperMap3D.Color.ORANGE,
                  disableDepthTestDistance: Number.POSITIVE_INFINITY,
                  font: 15 - Math.pow(window.devicePixelRatio, 2) + 'px Arial bold',
                  pixelOffset: new SuperMap3D.Cartesian2(10, -25),
                  eyeOffset: new SuperMap3D.Cartesian3(0, 0, -30),
                  distanceDisplayCondition: new SuperMap3D.DistanceDisplayCondition(0.0, 200000)
                },
              });
            }
          }
        });
        $.ajax({
          url: './support/json/ChongQingLabel2.json',
          success: function (data) {
            let geometrys = data.features;
            for (let i = 0; i < geometrys.length; i++) {
              let pos;
              let geometry = geometrys[i].geometry;
              let coordinates = geometry.coordinates;
              let city = geometrys[i].properties.name;
              pos = new SuperMap3D.Cartesian3.fromDegrees(coordinates[0], coordinates[1], coordinates[2]);
              datasource2.entities.add({
                position: pos,
                billboard: {
                  image: './support/imgs/huangbiao.png',
                  verticalOrigin: SuperMap3D.VerticalOrigin.BOTTOM,
                  scale: 0.2,
                  pixelOffset: new SuperMap3D.Cartesian2(0, -10),
                  distanceDisplayCondition: new SuperMap3D.DistanceDisplayCondition(0.0, 1000000)
                },
                label: {
                  text: city,
                  outlineColor: SuperMap3D.Color.ORANGE,
                  disableDepthTestDistance: Number.POSITIVE_INFINITY,
                  font: 15 - Math.pow(window.devicePixelRatio, 2) + 'px Arial bold',
                  pixelOffset: new SuperMap3D.Cartesian2(10, -25),
                  eyeOffset: new SuperMap3D.Cartesian3(0, 0, -30),
                  distanceDisplayCondition: new SuperMap3D.DistanceDisplayCondition(0.0, 1000000)
                },
              });
            }
          }
        });
      }

      let rotation = SuperMap3D.Math.toRadians(30);
      function rotapic() {
        let POIEntity = viewer.entities.add({     //底部旋转图片
          name: "test1",
          position: new SuperMap3D.Cartesian3.fromDegrees(107.80678201840176, 29.956306936004687, 100),
          ellipse: {
            semiMinorAxis: 300000,
            semiMajorAxis: 300000,
            height: 100,
            material: new SuperMap3D.ImageMaterialProperty({
              image: './support/imgs/bottom_circle.png',
              repeat: new SuperMap3D.Cartesian2(1, 1),
              transparent: true,
            }),
            rotation: new SuperMap3D.CallbackProperty(getRotationValue, false),
            stRotation: new SuperMap3D.CallbackProperty(getRotationValue, false),
            outline: false,
            numberOfVerticalLines: 100
          },
          description: '测试'
        });
      }

      function getRotationValue() {
        rotation += 0.001;
        return rotation;
      }

      function setFanGuang() {
        scene.bloomEffect.show = true;//开启泛光
        scene.bloomEffect.threshold = 10;
        scene.bloomEffect.bloomIntensity = 0.05;
        scene.hdrEnabled = false; // 开启hdr
      }

      function setWall() {
        let alp = 1;
        let num = 0;
        $.ajax({
          url: './support/json/ChongQingSide.json',
          success: function (datas) {
            let points = [], minHeights = [], maxHeights = [];
            let geometrys = datas.features;
            for (let i = 0; i < geometrys.length; i++) {
              let geometry = geometrys[i].geometry;
              let coordinates = geometry.coordinates;
              for (let item of coordinates) {
                points.push(item[0]);
                points.push(item[1]);
                points.push(item[2] + 10);
                minHeights.push(-10000);
                maxHeights.push(item[2]);
              };
              viewer.entities.add({
                wall: {
                  positions: new SuperMap3D.Cartesian3.fromDegreesArrayHeights(points),
                  minimumHeights: minHeights,
                  maximumHeights: maxHeights,
                  material: new SuperMap3D.ImageMaterialProperty({
                    image: "./support/imgs/side.png",
                    transparent: true,
                    color: new SuperMap3D.CallbackProperty(function () {
                      if ((num % 2) === 0) {
                        alp -= 0.005;
                      } else {
                        alp += 0.005;
                      }
                      if (alp <= 0.3) {
                        num++;
                      } else if (alp >= 1) {
                        num++;
                      }
                      return SuperMap3D.Color.WHITE.withAlpha(alp)
                    }, false)
                  })
                },
                polyline: {
                  positions: new SuperMap3D.Cartesian3.fromDegreesArrayHeights(points),
                  material: new SuperMap3D.PolylineTrailMaterialProperty({ // 尾迹线材质
                    color: new SuperMap3D.Color(0, 2.88, 23.9, 1.0),
                    trailLength: 0.5,
                    period: 10,
                  }),
                  width: 2
                }
              });
            }
          }
        });
        $.ajax({
          url: './support/json/ChongQingNeibu.json',
          success: function (datas) {
            let geometrys = datas.features;
            for (let i = 0; i < geometrys.length; i++) {
              let points = [];
              let geometry = geometrys[i].geometry;
              let coordinates = geometry.coordinates;
              for (let item of coordinates) {
                points.push(item[0]);
                points.push(item[1]);
                points.push(0);
              };
              viewer.entities.add({
                polyline: {
                  positions: new SuperMap3D.Cartesian3.fromDegreesArrayHeights(points),
                  material: new SuperMap3D.Color(0.8, 0.8, 0.8, 1.0),
                  classificationType: SuperMap3D.ClassificationType.BOTH,
                  clampToS3M: true,
                  width: 2,
                  distanceDisplayCondition: new SuperMap3D.DistanceDisplayCondition(0, 1500000),
                },
                classificationType: SuperMap3D.ClassificationType.BOTH,
                clampToS3M: true,
              });
            }
          }
        })
      }
      
      $('#loadingbar').remove();
    }

    if (typeof SuperMap3D !== 'undefined') {
      window.startupCalled = true;
      onload(SuperMap3D);
    }
  </script>
</body>

</html>