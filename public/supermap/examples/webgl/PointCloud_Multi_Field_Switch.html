<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>点云特征值</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <link href="./style/PointCloud_Multi_Field_Switch.css" rel="stylesheet">
    <script src="./js/config.js"></script>
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script src="./js/tooltip.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/bootstrap-select.min.js"></script>
    <script src="./js/spectrum.js"></script>
    <script src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>
    <div id='toolbar' style="position: absolute;left: 5px;top: 5px;display: none;padding: 24px 16px;padding-top: 10px;">
        <div class="titleBox">
            <div class="titl">点云特征值</div>
            <span class="close2" aria-hidden="false">x</span>
        </div>
        <div class="inputBox" style="display: flex;">
            <label class="lab">特征字段</label>
            <select id="fieldOption"></select>
        </div>

        <div class="param-item inputBox" style="margin-bottom: 0px;">
            <label for="colorModulation" class="lable">颜色调整</label>
            <input type="checkbox" id="colorModulation" class="toggle" style="margin-left: -15px;">
            <label class="switch" style="margin-left: 45px;"></label>
        </div>

        <script type="text/javascript">
            function onload(SuperMap3D) {
                const EngineType = getEngineType();
                const viewer = new SuperMap3D.Viewer('Container', {
                    timeline: true,
                    contextOptions: {
                        contextType: Number(EngineType)
                    }
                });
                window.viewer = viewer;
                viewer.scenePromise.then(function (scene) {
                    init(SuperMap3D, scene, viewer);
                });
            }

            function init(SuperMap3D, scene, viewer) {
                viewer.resolutionScale = window.devicePixelRatio;

                $('#toolbar').show();
                $('#loadingbar').remove();

                // 加载高德影像地图
                viewer.imageryLayers.addImageryProvider(new SuperMap3D.UrlTemplateImageryProvider({
                    url: 'https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                    minimumLevel: 3,
                    maximumLevel: 18,
                }));

                // 创建Elevation颜色表
                function createColorTable_Elevation(s3mLayer, fieldName) {
                    let categoryInfos = s3mLayer.temporaInfos;
                    let categoryFieldInfo = categoryInfos[fieldName];
                    if (!categoryFieldInfo) {
                        return undefined;
                    }

                    let minValue = categoryFieldInfo.min[0];
                    let maxValue = categoryFieldInfo.max[0];
                    let dValue = (maxValue - minValue) / 10;
                    let colorTable_Elv = new SuperMap3D.ColorTable();
                    colorTable_Elv.insert(minValue, new SuperMap3D.Color(0, 0, 255 / 255));
                    colorTable_Elv.insert(minValue + dValue * 1, new SuperMap3D.Color(51 / 255, 255 / 255, 204 / 255));
                    colorTable_Elv.insert(minValue + dValue * 2, new SuperMap3D.Color(102 / 255, 255 / 255, 153 / 255));
                    colorTable_Elv.insert(minValue + dValue * 3, new SuperMap3D.Color(153 / 255, 255 / 255, 102 / 255));
                    colorTable_Elv.insert(minValue + dValue * 4, new SuperMap3D.Color(204 / 255, 255 / 255, 51 / 255));
                    colorTable_Elv.insert(minValue + dValue * 5, new SuperMap3D.Color(255 / 255, 255 / 255, 0));
                    colorTable_Elv.insert(minValue + dValue * 6, new SuperMap3D.Color(255 / 255, 204 / 255, 0));
                    colorTable_Elv.insert(minValue + dValue * 7, new SuperMap3D.Color(255 / 255, 153 / 255, 0));
                    colorTable_Elv.insert(minValue + dValue * 8, new SuperMap3D.Color(255 / 255, 102 / 255, 0));
                    colorTable_Elv.insert(minValue + dValue * 9, new SuperMap3D.Color(255 / 255, 51 / 255, 0));
                    colorTable_Elv.insert(maxValue, new SuperMap3D.Color(255 / 255, 0, 0));

                    return colorTable_Elv;
                }

                // 创建Intensity颜色表
                function createColorTable_Intensity(s3mLayer, fieldName) {
                    let categoryInfos = s3mLayer.temporaInfos;
                    let categoryFieldInfo = categoryInfos[fieldName];
                    if (!categoryFieldInfo) {
                        return undefined;
                    }

                    let minValue = categoryFieldInfo.min[0];
                    let maxValue = categoryFieldInfo.max[0];
                    let dValue = (maxValue - minValue) / 10;
                    let colorTable_Intensity = new SuperMap3D.ColorTable();
                    colorTable_Intensity.insert(minValue, new SuperMap3D.Color(0, 0, 0));
                    colorTable_Intensity.insert(minValue + dValue * 1, new SuperMap3D.Color(26 / 255, 26 / 255, 26 / 255));
                    colorTable_Intensity.insert(minValue + dValue * 2, new SuperMap3D.Color(54 / 255, 54 / 255, 54 / 255));
                    colorTable_Intensity.insert(minValue + dValue * 3, new SuperMap3D.Color(82 / 255, 82 / 255, 82 / 255));
                    colorTable_Intensity.insert(minValue + dValue * 4, new SuperMap3D.Color(110 / 255, 110 / 255, 110 / 255));
                    colorTable_Intensity.insert(minValue + dValue * 5, new SuperMap3D.Color(138 / 255, 138 / 255, 138 / 255));
                    colorTable_Intensity.insert(minValue + dValue * 6, new SuperMap3D.Color(166 / 255, 166 / 255, 166 / 255));
                    colorTable_Intensity.insert(minValue + dValue * 7, new SuperMap3D.Color(194 / 255, 194 / 255, 194 / 255));
                    colorTable_Intensity.insert(minValue + dValue * 8, new SuperMap3D.Color(222 / 255, 222 / 255, 222 / 255));
                    colorTable_Intensity.insert(minValue + dValue * 9, new SuperMap3D.Color(233 / 255, 233 / 255, 233 / 255));
                    colorTable_Intensity.insert(maxValue, new SuperMap3D.Color(255 / 255, 255 / 255, 255 / 255));

                    return colorTable_Intensity;
                }

                // 创建ClassCode颜色表
                function createColorTable_ClassCode(s3mLayer, fieldName) {
                    let categoryInfos = s3mLayer.temporaInfos;
                    let categoryFieldInfo = categoryInfos[fieldName];
                    if (!categoryFieldInfo) {
                        return undefined;
                    }

                    let minValue = categoryFieldInfo.min[0]; // 2
                    let maxValue = categoryFieldInfo.max[0]; // 18
                    let dValue = 1;
                    let colorTable_classCode = new SuperMap3D.ColorTable();
                    colorTable_classCode.insert(minValue, new SuperMap3D.Color(0, 0, 0));
                    colorTable_classCode.insert(minValue + dValue * 1, new SuperMap3D.Color(26 / 255, 26 / 255, 26 / 255));
                    colorTable_classCode.insert(minValue + dValue * 2, new SuperMap3D.Color(54 / 255, 54 / 255, 54 / 255));
                    colorTable_classCode.insert(minValue + dValue * 3, new SuperMap3D.Color(82 / 255, 82 / 255, 82 / 255));
                    colorTable_classCode.insert(minValue + dValue * 4, new SuperMap3D.Color(110 / 255, 110 / 255, 110 / 255));
                    colorTable_classCode.insert(minValue + dValue * 5, new SuperMap3D.Color(138 / 255, 138 / 255, 138 / 255));
                    colorTable_classCode.insert(minValue + dValue * 6, new SuperMap3D.Color(166 / 255, 166 / 255, 166 / 255));
                    colorTable_classCode.insert(minValue + dValue * 7, new SuperMap3D.Color(194 / 255, 194 / 255, 194 / 255));
                    colorTable_classCode.insert(minValue + dValue * 8, new SuperMap3D.Color(222 / 255, 222 / 255, 222 / 255));
                    colorTable_classCode.insert(minValue + dValue * 9, new SuperMap3D.Color(255 / 255, 205 / 255, 205 / 255));
                    colorTable_classCode.insert(minValue + dValue * 10, new SuperMap3D.Color(51 / 255, 255 / 255, 204 / 255));
                    colorTable_classCode.insert(minValue + dValue * 11, new SuperMap3D.Color(102 / 255, 255 / 255, 153 / 255));
                    colorTable_classCode.insert(minValue + dValue * 12, new SuperMap3D.Color(153 / 255, 255 / 255, 102 / 255));
                    colorTable_classCode.insert(minValue + dValue * 13, new SuperMap3D.Color(204 / 255, 255 / 255, 51 / 255));
                    colorTable_classCode.insert(minValue + dValue * 14, new SuperMap3D.Color(255 / 255, 255 / 255, 0));
                    colorTable_classCode.insert(minValue + dValue * 15, new SuperMap3D.Color(255 / 255, 204 / 255, 0));
                    colorTable_classCode.insert(maxValue, new SuperMap3D.Color(255 / 255, 255 / 255, 255 / 255));

                    return colorTable_classCode;
                }

                // 根据传入的颜色表设置当前S3M图层的分层设色
                function setLayerHypByColorTable(s3mLayer, colorTable, fieldName) {
                    let hyp = new SuperMap3D.HypsometricSetting();
                    hyp.DisplayMode = SuperMap3D.HypsometricSettingEnum.DisplayMode.FACE;
                    hyp.ColorTable = colorTable;
                    s3mLayer.setHypsometricSetting(hyp, {
                        fieldName: fieldName
                    })
                }

                const url = 'https://www.supermapol.com/realspace/services/3D-PointCloudClassific/rest/realspace';//no compress 三种特征值
                let isOpenColorModulation = false; // 是否设置颜色调和

                const promise = viewer.scene.open(url);
                promise.then(function (layers) {
                    let layer = layers[0];

                    // 设置点云大小
                    const style3d = new SuperMap3D.Style3D();
                    style3d.pointSize = parseInt(2);
                    layer.style3D = style3d;

                    // 获取特征字段选项
                    const temporaInfos = layer.temporaInfos;
                    Object.keys(temporaInfos).forEach((key, index) => {
                        if (key === 'VertexWeight') {
                            $("#fieldOption").append(`<option value="${key}" selected>${key}</option>`);
                        } else {
                            $("#fieldOption").append(`<option value="${key}">${key}</option>`);
                        }
                    })

                    // 使用VertexWeight特征字段显示效果
                    let fieldName = 'VertexWeight';
                    let colorTable = createColorTable_Elevation(layer, fieldName);
                    setLayerHypByColorTable(layer, colorTable, fieldName);
                    setColorModulation(isOpenColorModulation) // 颜色调和

                    // 使用强度附加信息进行颜色调整
                    function setColorModulation(flag) {
                        if (flag) {
                            const intensityFieldName = "PointCloudIntensity";
                            const categoryFieldInfo = layer.temporaInfos[intensityFieldName];
                            if(!categoryFieldInfo) return;
                            const minValue = categoryFieldInfo.min[0];
                            const maxValue = categoryFieldInfo.max[0];

                            let colorModulationInfo = new SuperMap3D.ColorModulationInfo();
                            colorModulationInfo.field = intensityFieldName;
                            colorModulationInfo.minValue = minValue;
                            colorModulationInfo.maxValue = maxValue;

                            // colorModulationInfo.minValue = 0;
                            // colorModulationInfo.maxValue = 255;
                            layer.hypsometricSetting.hypsometricSetting.colorModulation = colorModulationInfo;
                        } else {
                            layer.hypsometricSetting.hypsometricSetting.colorModulation = undefined;
                        }
                    }

                    // 字段切换
                    $('#fieldOption').change(function () {
                        const selectField = $(this).val();
                        if (selectField === 'PointCloudIntensity') {
                            let fieldName = 'PointCloudIntensity';
                            let colorTable = createColorTable_Intensity(layer, fieldName);
                            setLayerHypByColorTable(layer, colorTable, fieldName);
                        } else if (selectField === 'VertexWeight') {
                            let fieldName = 'VertexWeight';
                            let colorTable = createColorTable_Elevation(layer, fieldName);
                            setLayerHypByColorTable(layer, colorTable, fieldName);
                        }else if (selectField === 'PointCloudClassCode') {
                            let fieldName = 'PointCloudClassCode';
                            let colorTable = createColorTable_ClassCode(layer, fieldName);
                            setLayerHypByColorTable(layer, colorTable, fieldName);
                        }

                        setColorModulation(isOpenColorModulation) //将强度信息附加到其他属性上，进行调整
                    })

                    // 颜色调整
                    $("#colorModulation").on("input change", function () {
                        isOpenColorModulation = this.checked;
                        if (isOpenColorModulation) {
                            setColorModulation(true)
                        } else {
                            setColorModulation(false)
                        }
                    });
                }, function (e) {
                });
            };

            if (typeof SuperMap3D !== 'undefined') {
                window.startupCalled = true;
                onload(SuperMap3D);
            }
        </script>
</body>

</html>