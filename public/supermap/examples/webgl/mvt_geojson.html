<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>MVT(GeoJson)</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <link href="./style/addGeojson.css" rel="stylesheet">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/tooltip.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/slider.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div id="toolbar" class="param-container tool-bar">
        <div class="titleBox">
            <div class="titl">MVT(GeoJson)</div>
            <span class="close2" aria-hidden="false">x</span>
        </div>
        <div class="inputBox">
            <label class="lable">添加模式</label>
            <select id="toggle-mvt">
                <option value="GeoJson-MVT">GeoJson创建MVT</option>
                <option value="MVT-GeoJson">MVT添加GeoJson</option>
            </select>
        </div>
        <div class="btn-container">
            <button type="button" id="spatialQuery" class="btn_foot"
                style=" background:rgba(52,153,229,1);padding: 5px 10px;">空间查询</button>
                <button type="button" id="clear" class="btn_foot"
                style=" background:rgba(52,153,229,0);padding: 5px 10px; border: 1px solid rgba(255,255,255,0.65);">清除</button>
        </div>
    </div>
    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>
    <!-- 气泡HTML -->
    <div id="bubble" class="bubble" style="bottom:0;left:82%;display:none;">
        <div id="tools" style="text-align : right">
            <span style="color: rgb(95, 74, 121);padding: 5px;position: absolute;left: 10px;top: 4px;">对象属性</span>
            <span class="fui-export" id="bubblePosition" style="color: darkgrey; padding:5px" title="停靠"></span>
            <span class="fui-cross" title="关闭" id="close" style="color: darkgrey;padding:5px"></span>
        </div>
        <div style="overflow-y:scroll;height:150px" id="tableContainer">
            <table id="tab"></table>
        </div>
    </div>
    <script type="text/javascript">
        function onload(SuperMap3D) {
            // 通过config.js中的getEngineType,获取引擎类型（EngineType）用于设置启动方式
            let EngineType = getEngineType();
            let viewer = new SuperMap3D.Viewer('Container', {
                contextOptions: {
                    contextType: Number(EngineType), // Webgl2:2 ; WebGPU:3
                }
            });

            viewer.resolutionScale = window.devicePixelRatio;

            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }

        function init(SuperMap3D, scene, viewer) {
            viewer.imageryLayers.addImageryProvider(
                new SuperMap3D.SuperMapImageryProvider({
                    url: "http://www.supermapol.com/realspace/services/map-China400/rest/maps/China400",
                })
            );

            let mvtMap;
            let tooltip = createTooltip(document.body);
            let selectLayer;
            let highlightLayers = {}; //高亮图层
            let highlightLayerSetting = undefined;
            createGeoJson();

            $('#toggle-mvt').change(function () {
                let addMode = $(this).val();
                if (addMode == 'GeoJson-MVT') {
                    removeLayer();
                    createGeoJson();
                } else {
                    removeLayer();
                    mvtAddGeoJson();
                }
            })

            function createGeoJson() {
                mvtMap = viewer.scene.addVectorTilesMap({
                    canvasWidth: 1024,
                    name: 'testMVT',
                    lineAntialiasing: false
                });
                scene.camera.flyTo({
                    destination: new SuperMap3D.Cartesian3(-2637782.0122890463, 5064643.604199719,
                        4526598.81051376),
                    orientation: {
                        heading: 0.13183121713326607,
                        pitch: -1.4230777001954409,
                        roll: 0.0029876506870687436
                    }
                })
                
                mvtMap.readyPromise.then(function (data) {
                
                    mvtMap.addSource('mian', {
                        type: "geojson",
                        data: './data/json/geo11.json'
                    })
                    let mianLayer = {
                        id: 'mian-layer',
                        type: 'fill',
                        source: 'mian',
                        paint: {
                            'fill-color': [
                                'match',
                                ['get', 'City'], // 属性字段
                                '北京市', '#e1cee1',
                                '天津市', '#ebeabc',
                                // 默认颜色
                                '#d0eacd'
                            ],
                            'fill-opacity': .9
                        }
                    }
                    mvtMap.addLayer(mianLayer)

                    mvtMap.addSource('text', {
                        type: "geojson",
                        data: './data/json/point11.json'
                    })
                    pointLayer = {
                        id: 'point-layer',
                        type: 'symbol',
                        source: 'text',
                        layout: {
                            'text-field': '{NAME}',
                        },
                        paint: {
                            'text-color': 'black'
                        }
                    }

                    mvtMap.addLayer(pointLayer)
                    selectLayer = mianLayer;
                })
            }

            function mvtAddGeoJson() {
                mvtMap = viewer.scene.addVectorTilesMap({
                    url: "https://www.supermapol.com/realspace/services/map-mvt-JingJinDiQuDiTu/restjsr/v1/vectortile/maps/%E4%BA%AC%E6%B4%A5%E5%9C%B0%E5%8C%BA%E5%9C%B0%E5%9B%BE",
                    canvasWidth: 1024,
                    name: 'testMVT',
                    lineAntialiasing: false
                });

                mvtMap.readyPromise.then(function (data) {
                    let bounds = mvtMap.rectangle;
                    selectLayer = mvtMap.mapboxStyle.layers[5]
                    scene.camera.setView({
                        destination: new SuperMap3D.Cartesian3.fromRadians(
                            (bounds.east + bounds.west) * 0.5,
                            (bounds.north + bounds.south) * 0.5,
                            2000),

                        orientation: {
                            heading: 0,
                            roll: 0
                        }
                    });

                    let source = {
                        id: "bianjie", //source id
                        type: "geojson", //source type
                        data: './data/json/beijing_bianjie.json' //geojson data
                    };
                    mvtMap.addSource(source.id, source);


                    let style = {
                        id: "line-layer", //style id
                        type: 'line', //style type
                        source: source.id, //source name
                        paint: {
                            'line-color': 'red',
                        }
                    }
                    mvtMap.addLayer(style);
                });
            }

            // 移除图层
            function removeLayer() {
                spatialFlag = false;
                if (mvtMap) {
                    scene.removeVectorTilesMap(mvtMap.name);
                }

                handlerPolygon.deactivate();
                if (handlerPolygon.polygon) {
                    handlerPolygon.polygon.show = false;
                }
                if (handlerPolygon.polyline) {
                    handlerPolygon.polyline.show = false;
                }
            }
            
            //空间查询
            let spatialFlag = false; 
            $("#spatialQuery").on("click", function () {
                spatialFlag = true;
                if (handlerPolygon.active) {
                    handlerPolygon.deactivate();
                } else {
                    handlerPolygon.activate();
                }
            });

            $("#clear").on("click", function () {
                spatialFlag = false;
                if(handlerPolygon) {
                    handlerPolygon.deactivate();
                    handlerPolygon.clear()
                }
                highlightLayers = {};
                mvtMap.removeLayer(highlightLayerSetting.id)
            });

            let handlerPolygon = new SuperMap3D.DrawHandler(viewer, SuperMap3D.DrawMode.Polygon, 0); handlerPolygon
                .activeEvt.addEventListener(function (isActive) {
                    if (isActive == true) {
                        viewer.enableCursorStyle = false;
                        viewer._element.style.cursor = '';
                        $('body').removeClass('drawCur').addClass('drawCur');
                    } else {
                        viewer.enableCursorStyle = true;
                        $('body').removeClass('drawCur');
                    }
                }); handlerPolygon.movingEvt.addEventListener(function (windowPosition) {
                    if (handlerPolygon.isDrawing) {
                        tooltip.showAt(windowPosition, '<p>绘制相交区域(右键结束绘制)</p>');
                    }
                });

            handlerPolygon.drawEvt.addEventListener(function (result) {
                tooltip.setVisible(false);
                queryFeatures(result.object.positions);
            });

            let queryFeatures = function (positions) {
                if (mvtMap) {
                    let cartographics = positions.map(pos => SuperMap3D.Cartographic.fromCartesian(pos));
                    //查询出相交图层的feature
                    let features = mvtMap.queryRenderedFeatures(cartographics, {
                        layers: [selectLayer.id]
                    });

                    let layerSetting = selectLayer;
                    let highlightLayerID = selectLayer.id + "_highlight";
                    let highlightLayer = highlightLayers[highlightLayerID];
                    if (!SuperMap3D.defined(highlightLayer)) {
                        highlightLayerSetting = SuperMap3D.clone(layerSetting, true);
                        highlightLayerSetting.id = highlightLayerID;
                        if (selectLayer.type == "line") { // 线
                            highlightLayerSetting.paint["line-width"] = 2.0;
                            highlightLayerSetting.paint["line-color"] = "rgba(255,0,0,1.00)";
                        } else if (selectLayer.type == "fill") { // 面
                            highlightLayerSetting.paint["fill-color"] = "rgba(0,255,255,1.00)";
                        } else if (selectLayer.type == "symbol") {
                            highlightLayerSetting.paint["text-color"] = 'rgba(0,255,255,1.00)';
                            highlightLayerSetting.paint["text-halo-color"] = 'rgba(255, 255, 255, 1)';
                        }
                        mvtMap.addLayer(highlightLayerSetting);
                        highlightLayers[highlightLayerID] = true;
                    }


                    let filter = features.reduce(function (memo, feature) {
                        memo.push(feature.id);
                        return memo;
                    }, ["in", "$id"]);
                    mvtMap.setFilter(highlightLayerID, filter);
                }
            };

            //点击，弹出属性
            viewer.selectedEntityChanged.addEventListener(function (entity) {
                if (!spatialFlag) {
                    $("#bubble").hide();

                    let selectedEntity = viewer.selectedEntity;
                    if (!SuperMap3D.defined(selectedEntity) || !SuperMap3D.defined(selectedEntity.pickResult)) {
                        return;
                    }
                    let feature = selectedEntity.pickResult;
                    let properties = feature.properties;

                    if (!properties) {
                        return;
                    }

                    for (i = table.rows.length - 1; i > -1; i--) {
                        table.deleteRow(i);
                    }
                    $("#bubble").show();

                    let newRow = table.insertRow();
                    let cell1 = newRow.insertCell();
                    let cell2 = newRow.insertCell();
                    cell1.innerHTML = "<b style='font-size: 1.00rem;'>属性</b>";
                    cell2.innerHTML = "<b style='font-size: 1.00rem;'>值</b>";

                    //添加图层和id信息
                    newRow = table.insertRow();
                    cell1 = newRow.insertCell();
                    cell2 = newRow.insertCell();
                    cell1.innerHTML = "图层";
                    cell2.innerHTML = selectedEntity.layerID;

                    newRow = table.insertRow();
                    cell1 = newRow.insertCell();
                    cell2 = newRow.insertCell();
                    cell1.innerHTML = "ID";
                    cell2.innerHTML = selectedEntity.id;

                    for (let key in properties) {
                        let newRow = table.insertRow();
                        let cell1 = newRow.insertCell();
                        let cell2 = newRow.insertCell();
                        cell1.innerHTML = key;
                        cell2.innerHTML = properties[key];
                    }
                }
            });

            /* 气泡相关 1/4 start */
            let scenePosition = null; // 记录在场景中点击的笛卡尔坐标点
            let dock = false; // 是否停靠
            let infoboxContainer = document.getElementById("bubble");
            let table = document.getElementById("tab"); // 气泡内的表格
            $("#bubblePosition").click(function () { // 停靠状态切换
                dock = !dock;
                if ($("#bubblePosition").hasClass("fui-export")) {
                    $("#bubble").removeClass("bubble").addClass("float");
                    $("#bubblePosition").removeClass("fui-export").addClass("fui-bubble");
                    $("#bubblePosition")[0].title = "悬浮";
                    $("#bubble").css({
                        'left': '82%',
                        'bottom': '39%'
                    });
                    $("#tableContainer").css({
                        'height': '350px'
                    });
                } else if ($("#bubblePosition").hasClass("fui-bubble")) {
                    $("#bubble").removeClass("float").addClass("bubble");
                    $("#bubblePosition").removeClass("fui-bubble").addClass("fui-export");
                    $("#bubblePosition")[0].title = "停靠";
                    $("#tableContainer").css({
                        'height': '150px'
                    });
                }
            });

            $("#close").click(function () { // 关闭气泡
                $("#bubble").hide();
            });

            scene.postRender.addEventListener(function () { // 每一帧都去计算气泡的正确位置
                if (scenePosition && !dock) {
                    let canvasHeight = scene.canvas.height;
                    let windowPosition = new SuperMap3D.Cartesian2();
                    SuperMap3D.SceneTransforms.wgs84ToWindowCoordinates(scene, scenePosition,
                        windowPosition);
                    infoboxContainer.style.bottom = (canvasHeight - windowPosition.y - 120) + 'px';
                    infoboxContainer.style.left = (windowPosition.x - 70) + 'px';
                    infoboxContainer.style.visibility = "visible";
                }
            });

            let handler = new SuperMap3D.ScreenSpaceEventHandler(scene.canvas);
            handler.setInputAction(function (e) {
                // 获取点击位置笛卡尔坐标
                let cameraPosition = scene.camera.position;
                // 获取点击位置笛卡尔坐标
                scene.pickPositionAsync(e.position).then((position)=>{
                    scenePosition = position; // 气泡相关 2/4
                })
                scenePosition = position; // 气泡相关 2/4
            }, SuperMap3D.ScreenSpaceEventType.LEFT_CLICK);

            scenePosition = null;

            $("#bubble").hide();
            $('#loadingbar').remove();
        }

        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>