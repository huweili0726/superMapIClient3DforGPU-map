<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>模型编辑（旋转、平移、缩放）</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./style/KML_edit.css" rel="stylesheet">
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script src="./js/slider.js"></script>
    <script type="text/javascript" src="./js/saveKml.js"></script>
    <script type="text/javascript" src="./js/sweetalert-dev.js"></script>
    <link rel="stylesheet" href="./css/sweetalert.css">
    <script src="./js/config.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>
    <div id="toolbar" class="param-container tool-bar">
        <div style="margin: 10px 0px;">
            <b>改变位置</b>
            <input type="range" id="changePosition" min="0" max="13" value="0">
        </div>
        <div style="margin: 10px 0px;">
            <b>旋转角度</b>
            <input type="range" id="rotate" min="0" max="60" value="38">
        </div>
        <div style="margin: 10px 0px;">
            <b>模型大小</b>
            <input type="range" id="setSize" min="1" max="8" value="0">
        </div>
    </div>
    <script>
        function onload(SuperMap3D) {
            // 通过config.js中的getEngineType,获取引擎类型（EngineType）用于设置启动方式
            var EngineType = getEngineType();
            var viewer = new SuperMap3D.Viewer('Container', {
                shouldAnimate: true,
                contextOptions: {
                    contextType: Number(EngineType), // Webgl2:2 ; WebGPU:3
                }
            });

            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }
        function init(SuperMap3D, scene, viewer) {
            // 加载高德影像地图
            viewer.imageryLayers.addImageryProvider(new SuperMap3D.UrlTemplateImageryProvider({
                url: 'https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                minimumLevel: 3,
                maximumLevel: 18,
            }));
            viewer.resolutionScale = window.devicePixelRatio;

            var widget = viewer.Widget;
            var nodeAnimationFlag = false;
            try {
                //添加S3M图层服务
                var promise = scene.open(URL_CONFIG.SCENE_JINJIANG2);
                promise.then(function (layers) {
                    viewer.scene.camera.setView({
                        destination: new SuperMap3D.Cartesian3(-2768530.0785199646, 5088886.5198286865, 2659403.2721356247),
                        orientation: {
                            heading: 3.836925903232255,
                            pitch: -0.35141268551663174,
                            roll: 0.0035480416143034432
                        }
                    });
                        
                    // 导入KML模型
                    viewer.dataSources.removeAll();
                    viewer.dataSources.add(SuperMap3D.KmlDataSource.load('./SampleData/kml/model.kml', {
                        camera: viewer.scene.camera,
                        canvas: viewer.scene.canvas
                    })).then(function (dataSource) {
                        viewer.clock.clockRange = SuperMap3D.ClockRange.CLAMPED;
                    });

                    function rotate(value) {
                        if (viewer.dataSources.length === 0) {
                            sweetAlert("error", "Please add KML file firstly", "error");
                            return;
                        }
                        var entity = viewer.dataSources._dataSources[0]._entityCollection._entities._array[0];
                        if (!SuperMap3D.defined(entity.currentPosition)) {
                            var position = entity.position;
                            var time = position._composite.intervals._intervals[0].stop;
                            entity.currentPosition = position.getValue(time);
                        }
                        entity.orientation = SuperMap3D.Transforms.headingPitchRollQuaternion(entity.currentPosition, new SuperMap3D.HeadingPitchRoll(value / 10, 0, 0));
                    }

                    function changePosition(value) {
                        var sceme = viewer.scene;
                        if (viewer.dataSources.length === 0) {
                            sweetAlert("error", "Please add KML file firstly", "error");
                            return;
                        }
                        var entity = viewer.dataSources._dataSources[0]._entityCollection._entities._array[0];
                        if (!SuperMap3D.defined(entity.currentPosition)) {
                            var position = entity.position;
                            var time = position._composite.intervals._intervals[0].stop;
                            entity.currentPosition = position.getValue(time);
                        }
                        var coordinate = SuperMap3D.Cartographic.fromCartesian(entity.currentPosition);
                        var longitude = SuperMap3D.Math.toDegrees(coordinate.longitude);
                        var latitude = SuperMap3D.Math.toDegrees(coordinate.latitude);
                        var height = coordinate.height;
                        longitude -= value / 50000;
                        latitude -= value / 50000;
                        var newPosition = SuperMap3D.Cartesian3.fromDegrees(longitude, latitude, height);
                        entity.position = newPosition;
                    }

                    function bigger() {
                        if (viewer.dataSources.length === 0) {
                            sweetAlert("error", "Please add KML file firstly", "error");
                            return;
                        }
                        var entity = viewer.dataSources._dataSources[0]._entityCollection._entities._array[0];
                        if (!SuperMap3D.defined(entity.model.scale)) {
                            entity.model.scale = 1;
                        }
                        entity.model.scale = entity.model.scale._value + 1;
                    }

                    function smaller() {
                        if (viewer.dataSources.length === 0) {
                            sweetAlert("error", "Please add KML file firstly", "error");
                            return;
                        }
                        var entity = viewer.dataSources._dataSources[0]._entityCollection._entities._array[0];
                        if (!SuperMap3D.defined(entity.model.scale)) {
                            entity.model.scale = 1;
                        }
                        if (entity.model.scale._value > 1) {
                            entity.model.scale = entity.model.scale._value - 1;
                        }
                    }

                    function setSize(size) {
                        var entity = viewer.dataSources._dataSources[0]._entityCollection._entities._array[0];
                        entity.model.scale = size;
                    }

                    function saveAsKml() {
                        saveKml(SuperMap3D, viewer);
                    }

                    $('#rotate').bind('input propertychange', function () {
                        var value = Number($(this).val());
                        rotate(value);
                    });
                    $('#changePosition').bind('input propertychange', function () {
                        var value = Number($(this).val());
                        changePosition(value);
                    });
                    $('#setSize').bind('input propertychange', function () {
                        var value = Number($(this).val());
                        setSize(value);
                    });
                    $('#loadingbar').remove();
                    $('#toolbar').show();
                }, function (e) {
                    if (widget._showRenderLoopErrors) {
                        var title = '渲染时发生错误，已停止渲染。';
                        widget.showErrorPanel(title, undefined, e);
                    }
                });
            }
            catch (e) {
                if (widget._showRenderLoopErrors) {
                    var title = '渲染时发生错误，已停止渲染。';
                    widget.showErrorPanel(title, undefined, e);
                }
            }
        }
        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>