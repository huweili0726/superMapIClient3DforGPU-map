<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>点云分类</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./style/vuecommon.css" rel="stylesheet">
    <script src="./js/config.js"></script>
    <script src="./js/layerTree/vue.global.js"></script>
    <script src="./js/layerTree/naive-ui.min.js"></script>
    <script src="../../Build/SuperMap3D/SuperMap3D.js"></script>
    <style>
        .row-item .title{
            text-wrap: nowrap;
            width: 20%;
        }
    </style>
</head>

<body>
    <div id="Container"></div>
    <div class="vue-container" style="display: none;width: 320px;">
        <div id="app">
            <div class="panel-container" style=" padding: 24px 16px; padding-top: 10px;">
                <div class="panel-header">
                    <div class="panel-header-title">点云分类</div>
                    <span class="panel-header-close" id="close">X</span>
                </div>

                <!-- vue component content -->
                <n-config-provider :theme-overrides="overridesTheme" :theme="darkTheme" style="margin-top: 20px;">
                    <n-scrollbar style="max-height: 520px;padding-right: 10px;" trigger="none">

                        <div class="row-item">
                            <span class="title">地面</span>
                            <div class="color-pick-box" style="width: 80%;" >
                              <n-color-picker v-model:value="state.groundColor" :render-label="
                                () => { return ''; } " size="small">
                              </n-color-picker>
                            </div>
                        </div>
                        <div class="row-item">
                            <span class="title">植被</span>
                            <div class="color-pick-box" style="width: 80%;" >
                              <n-color-picker  v-model:value="state.vegetationColor" :render-label="
                                () => { return ''; } " size="small">
                              </n-color-picker>
                            </div>
                        </div>
                        <div class="row-item">
                            <span class="title">电缆</span>
                            <div class="color-pick-box" style="width: 80%;" >
                              <n-color-picker  v-model:value="state.wireColor" :render-label="
                                () => {  return ''; } " size="small">
                              </n-color-picker>
                            </div>
                        </div>
                        <div class="row-item">
                            <span class="title">电力塔</span>
                            <div class="color-pick-box" style="width: 80%;" >
                              <n-color-picker  v-model:value="state.towerColor" :render-label="
                                () => { return ''; }" size="small">
                              </n-color-picker>
                            </div>
                        </div>
                        <div class="row-item">
                            <span class="title">噪点</span>
                            <div class="color-pick-box" style="width: 80%;" >
                              <n-color-picker  v-model:value="state.noiseColor" :render-label="
                                () => { return ''; } " size="small">
                              </n-color-picker>
                            </div>
                        </div>

                    </n-scrollbar>

                    <div class="btn-row-item" style="margin-left: 30%;">
                        <n-button type="info" color="#3499E5" text-color="#fff" :focusable="false" @click="add"
                            style="margin-right: 10px">添加</n-button>
                        <n-button :focusable="false" text-color="#fff" @click="clear">清除</n-button>
                    </div>
                </n-config-provider>

            </div>
        </div>
    </div>
    <canvas id="image"
        style="display: none; width: 600px; height: 450px; position: absolute; right: 2%; bottom: 2%; background-color:rgba(65, 65, 65, 0.5)">
    </canvas>
    <div class="loading-container">
        <div class="circle"></div>
    </div>
    <script type="module">
        function onload(SuperMap3D) {
            // 通过config.js中的getEngineType,获取引擎类型（EngineType）用于设置启动方式
            const EngineType = getEngineType();
            const viewer = new SuperMap3D.Viewer('Container', {
                contextOptions: {
                    contextType: Number(EngineType),  // Webgl2:2 ; WebGPU:3
                }
            });
            window.viewer = viewer;
            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }

        function init(SuperMap3D, scene, viewer) {
            viewer.resolutionScale = window.devicePixelRatio;

			// 设置鼠标缩放系数
            viewer.scene.screenSpaceCameraController.zoomFactor = 1;

            // 打开场景
            const promise = scene.open("https://www.supermapol.com/realspace/services/3D-PointCloudClassific/rest/realspace"); 
            promise.then(function (layers) {
                document.querySelector('.loading-container').style.display = 'none';
                document.querySelector('.vue-container').style.display = 'block';

                // 初始化Vue组件
                initVueComponents(scene, viewer);
            })
        }

        // 初始化Vue组件
        async function initVueComponents(scene, viewer) {
            // 对象解构
            const { reactive, watch } = Vue;
            const { darkTheme } = naive;

            // 初始化变量
            const state = reactive({
                groundColor: 'rgb(232,173,10)',
                vegetationColor: 'rgb(0,255,0)',
                wireColor: 'rgb(0,0,255)',
                towerColor: 'rgb(0,255,255)',
                noiseColor: 'rgb(255,0,0)',
            });

            // 添加必应地图
            // 加载高德影像地图
            viewer.imageryLayers.addImageryProvider(new SuperMap3D.UrlTemplateImageryProvider({
                url: 'https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                minimumLevel: 3,
                maximumLevel: 18,
            }));

            const s3mLayer = viewer.scene.layers.layerQueue[0];
            if(!s3mLayer) return;

            const fieldVals = await s3mLayer.getAllFieldValues(SuperMap3D.S3MFieldType.PointCloudClassification);
            console.log("fieldVals:", fieldVals);

            function getColorByID(id) {
                switch (Number(id)) {
                    case 2:
                        return state.groundColor;
                        break
                    case 5:
                        return state.vegetationColor;
                        break
                    case 14:
                        return state.wireColor;
                        break
                    case 15:
                        return state.towerColor;
                        break
                    case 18:
                        return state.noiseColor;
                        break
                    default:
                        break;
                }
            }

            function randomRGB() {
                return `rgb(${[
                Math.floor(Math.random()  * 256),
                Math.floor(Math.random()  * 256),
                Math.floor(Math.random()  * 256)
                ].join(',')})`;
            }
            
            // 添加
            const updateThemeStyle = function(){
                if(!fieldVals || !s3mLayer) return;

                const conditionList = [];
                fieldVals.forEach(element => {
                    const id = element.id;
                    const condition = "${classID} === " + id;
                    const color = getColorByID(id) ?? randomRGB();
                    conditionList.push([condition, color]);
                });

                s3mLayer.queryFieldNames = ["classID"];
                s3mLayer.themeStyle = new SuperMap3D.Cesium3DTileStyle({
                    color: {
                        conditions: conditionList
                    }
                });
            }
            updateThemeStyle();

            let isClear = false;
            const add = function(){
                isClear = false;
                updateThemeStyle();
            }

            const clear = function(){
                if(!s3mLayer) return;
                isClear = true;
                s3mLayer.themeStyle = new SuperMap3D.Cesium3DTileStyle({
                    color: {
                        conditions: [['true', 'rgb(255,255,255)']]
                    }
                });;
            }

            // 创建Vue示例
            const App = {
                setup() {
                    watch(() => state.groundColor,
                        (val) => {
                            if(!isClear) updateThemeStyle();
                        }
                    );
                    watch(() => state.vegetationColor,
                        (val) => {
                            if(!isClear) updateThemeStyle();
                        }
                    );
                    watch(() => state.wireColor,
                        (val) => {
                            if(!isClear) updateThemeStyle();
                        }
                    );
                    watch(() => state.towerColor,
                        (val) => {
                            if(!isClear) updateThemeStyle();
                        }
                    );
                    watch(() => state.noiseColor,
                        (val) => {
                            if(!isClear) updateThemeStyle();
                        }
                    );

                    return {
                        state,
                        darkTheme,
                        add,
                        clear,
                        overridesTheme: { // 重写主题样式
                            common: {
                                primaryColor: "rgba(52, 153, 229, 1)",
                                primaryColorHover: "rgba(52, 153, 229, 1)",
                                primaryColorPressed: "rgba(255,255,255,0.85)",
                                primaryColorSuppl: "rgba(255,255,255,0.45)",
                            },
                            Button: {
                                fontSizeMedium: "14px", // 底部操作按钮：宽高和文字大小自适应浏览器
                                textColor: "rgba(255,255,255,0.65)", // 设置默认n-button全局样式
                                border: "1px solid rgba(255,255,255,0.65)",
                                textColorHover: "#5EB7F2",
                                borderHover: "1px solid #5EB7F2",
                                textColorPressed: "#2276BF",
                                borderPressed: "1px solid #2276BF",
                            },
                            Tabs: {
                                barColor: "#3499e5", // tabs底部横条颜色
                                tabFontSizeMedium: "14px", // tabs标签文字大小 - 兼容移动端样式
                            },
                            ColorPicker: {
                                border: "none", // color-pick颜色条去掉边框
                            },
                            Divider: {
                                color: "rgba(255, 255, 255, 0.15)", // 分割条颜色
                            },
                            Checkbox: {
                                colorChecked: "#3499E5",
                                checkMarkColor: "#fff",
                            },
                            Slider: {
                                fillColor: "#3499E5",
                                fillColorHover: "#3499E5",
                                handleSize: "12px",
                            },
                            Switch: {
                                railColorActive: "#3499E5",
                            },
                            Select: {
                                color: "rgba(255, 255, 255, 0.15)"
                            }
                        },
                    }
                }
            }
            const app = Vue.createApp(App);
            app.use(naive);
            app.mount('#app');
        }

        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>