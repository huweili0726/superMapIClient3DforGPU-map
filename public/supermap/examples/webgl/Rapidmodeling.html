<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>快速建模</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <link href="./style/Rapidmodeling.css" rel="stylesheet">
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/tooltip.js"></script>
    <script src="./js/spectrum.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>

<body>
    <div id="Container"></div>
    <div id="toolbar">
        <div class="title-box" style="margin-top: 10px;">
            <div class="titl" style="font-size: 18px;width: 100px;">快速建模</div>
            <span class="close2" aria-hidden="false">×</span>
        </div>
        <div class="input-box">
            <label class="lable">选择模式</label>
            <div class="content radio-box">
                <div style="display: flex;flex-direction: row;margin-right: 28px;">
                    <input type="radio" name="operateMode" value="stretch" id="stretch" checked>
                    <label for="stretch">拉伸</label>
                </div>
                <div style="display: flex;flex-direction: row;margin-right: 28px;">
                    <input type="radio" name="operateMode" value="lofting" id="lofting">
                    <label for="lofting">放样</label>
                </div>
            </div>
        </div>
        <div id="stretch-container">
            <div class="input-box">
                <label class="lable">拉伸高度（米）</label>
                <input id="stre_hei" class="content" value="100" type="number" max="1000" min="0" step="1" />
            </div>
            <div class="input-box">
                <label class="lable">底部高程（米）</label>
                <input id="bom_hei" class="content" value="0" type="number" max="300" min="-10" step="1" />
            </div>
        </div>
        <div id="lofting-container" style="display: none;">
            <div class="input-box">
                <label class="lable">上部宽度（米）</label>
                <input id="top_wid" class="content" class="min-solider" value="36" type="number" max="500" min="2"
                    step="1" />
            </div>
            <div class="input-box">
                <label class="lable">下部宽度（米）</label>
                <input id="bom_wid" class="content" class="min-solider" value="36" type="number" max="300" min="2"
                    step="1" />
            </div>
            <div class="input-box">
                <label class="lable">道路厚度（米）</label>
                <input id="road_thick" class="content" class="min-solider" value="0.01" type="number" max="3" min="0.01"
                    step="0.01" />
            </div>
        </div>
        <div id="geometry-edit-box">
            <div class="input-box">
                <label class="lable">开启编辑</label>
                <div class="content radio-box">
                    <div style="display: flex;flex-direction: row;margin-right: 28px;">
                        <input type="checkbox" name="geometryEdit" value="edit" id="geometry_edit">
                    </div>
                </div>
            </div>
        </div>
        <div id="geometry-edit-box-z" style="display: none;">
            <div class="input-box">
                <label class="lable">编辑z轴</label>
                <div class="content radio-box">
                    <div style="display: flex;flex-direction: row;margin-right: 28px;">
                        <input type="checkbox" name="geometryEditZ" value="edit" id="geometry_edit_z">
                    </div>
                </div>
            </div>
        </div>

        <div class="texture-container" style="margin-bottom: -12px;">
            <div class="input-box">
                <label class="lable">材质设置</label>
                <div class="content radio-box">
                    <div style="display: flex;flex-direction: row;margin-right: 28px;">
                        <input type="checkbox" name="material" value="texture" id="material_texture">
                        <label for="material_texture">纹理</label>
                    </div>
                    <div style="display: flex;flex-direction: row;margin-right: 28px;">
                        <input type="checkbox" name="material" value="color" id="material_color" checked>
                        <label for="material_color">颜色</label>
                    </div>
                </div>
            </div>
            <div id="material-color-container">
                <div class="input-box">
                    <label class="lable" style="margin-right: 15px;">颜色设置</label>
                    <input class="colorPicker content" data-bind="value: color,valueUpdate: 'input'" id="colorPicker">
                </div>
            </div>
            <div id="material-texture-container" style="display: none;">
                <div class="input-box">
                    <label class="lable">贴图模式</label>
                    <div class="content radio-box">
                        <div style="display: flex;flex-direction: row;">
                            <input type="radio" name="texture" value="real" id="texture_real" checked>
                            <label for="texture_real">实际大小</label>
                        </div>
                        <div style="display: flex;flex-direction: row;">
                            <input type="radio" name="texture" value="virtual" id="texture_virtual">
                            <label for="texture_virtual">重复次数</label>
                        </div>
                    </div>
                </div>
                <div id="texture-option-stretch">
                    <div class="input-box">
                        <label class="lable">纹理图片</label>
                        <div class="content radio-box">
                            <div style="display: flex;flex-direction: row;">
                                <input type="radio" name="textureStretchOption" value="normal" id="texture_stretch_1"
                                    checked>
                                <label for="texture_stretch_1">纹理1</label>
                            </div>
                            <div style="display: flex;flex-direction: row;">
                                <input type="radio" name="textureStretchOption" value="senior" id="texture_stretch_2">
                                <label for="texture_stretch_2" style="margin-right: 22px;">纹理2</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="texture-option-lofting" style="display: none;">
                    <div class="input-box">
                        <label class="lable">纹理图片</label>
                        <div class="content radio-box">
                            <div style="display: flex;flex-direction: row;">
                                <input type="radio" name="textureLoftingOption" value="two" id="texture_lofting_1"
                                    checked>
                                <label for="texture_lofting_1">纹理1</label>
                            </div>
                            <div style="display: flex;flex-direction: row;">
                                <input type="radio" name="textureLoftingOption" value="one" id="texture_lofting_2">
                                <label for="texture_lofting_2" style="margin-right: 22px;">纹理2</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="realsize-container">
                    <div class="input-box">
                        <label class="lable">横向重复（米）</label>
                        <input id="u_size" class="content" class="min-solider" value="100" type="number" max="1000"
                            min="0" step="1" />
                    </div>
                    <div class="input-box">
                        <label class="lable">纵向重复（米）</label>
                        <input id="v_size" class="content" class="min-solider" value="100" type="number" max="1000"
                            min="0" step="1" />
                    </div>
                </div>
                <div id="virtualSize-container" style="display: none;">
                    <div class="input-box">
                        <label class="lable">横向重复（次）</label>
                        <input id="v_repeat" class="content" class="min-solider" value="1" type="number" max="100"
                            min="1" step="1" />
                    </div>
                    <div class="input-box">
                        <label class="lable">纵向重复（次）</label>
                        <input id="u_repeat" class="content" class="min-solider" value="1" type="number" max="100"
                            min="1" step="1" />
                    </div>
                </div>
            </div>
            <div class="input-box-foot">
                <button type="button" id="draw" class="btn_foot" style=" background:rgba(52,153,229,1);">绘制</button>
                <button type="button" id="clear" class="btn_foot"
                    style="border: 1px solid rgba(174, 174, 174, 1);">清除</button>
            </div>
        </div>

    </div>
    <script>
        function onload(SuperMap3D) {
            // 通过config.js中的getEngineType,获取引擎类型（EngineType）用于设置启动方式
            let EngineType = getEngineType();
            let viewer = new SuperMap3D.Viewer('Container', {
                infoBox : false,
                contextOptions: {
                    contextType: Number(EngineType), // Webgl2:2 ; WebGPU:3
                }
            });        

            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }

        function init(SuperMap3D, scene, viewer) {
            window.viewer = viewer; 
            viewer.resolutionScale = window.devicePixelRatio;
            
            
            viewer.terrainProvider = new SuperMap3D.EllipsoidTerrainProvider();
            let geometry_stretch = undefined;
            let geometry_lofting = undefined;
            let handlerPolygon = new SuperMap3D.DrawHandler(viewer, SuperMap3D.DrawMode.Polygon);
            let handlerPolyLine = new SuperMap3D.DrawHandler(viewer, SuperMap3D.DrawMode.Line);
            let handlerOrthogonal = new SuperMap3D.ScreenSpaceEventHandler(viewer.scene.canvas);
            let tooltip = createTooltip(document.body);
            let entityList = [];
            let operateMode = "stretch";
            let textureMode = "real";
            let currentPolygon = undefined;
            let currentPolyline = undefined;
            let materialColor = "rgba(255,255,255,1.0)";
            let currentOperateEntityList = [];
            let extrudedHeight = 1;
            let editHandler = undefined;
            let building_img_side = "./images/stretchLofting/building_one.jpg"; // building_one building_two
            let building_img_top = "./images/stretchLofting/cement.png";
            let driveway_img = "./images/stretchLofting/driveway.jpg";

            // 加载高德影像地图
            viewer.imageryLayers.addImageryProvider(new SuperMap3D.UrlTemplateImageryProvider({
                url: 'https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                minimumLevel: 3,
                maximumLevel: 18,
            }));

            // viewer.imageryLayers.addImageryProvider(imageryProvider);
            // 设置相机位置、视角，便于观察场景
            viewer.scene.camera.setView({
                "destination": {
                    "x": -2182839.820579321,
                    "y": 4386513.0540620955,
                    "z": 4069800.773166678
                },
                "orientation": {
                    "heading": 3.5019877658732086,
                    "pitch": 0.0006897055033980859,
                    "roll": 6.28195184804747
                }
            });

            // 移除自带的左键双击实体跳转的事件
            viewer.Widget.screenSpaceEventHandler.removeInputAction(SuperMap3D.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);

            // 初始化绘制线面的handle
            initDrawHandle();

            $.ajax({
                url: "./data/json/stretchLofting.json",
                method: "GET",
            }).done((result) => {
                setTimeout(() => {
                    createAdvancedFacilities(result);
                }, 1000)
            })

            // 初始化绘制线面的handle
            function initDrawHandle() {
                //绘制多边形底面
                handlerPolygon.activeEvt.addEventListener(function (isActive) {
                    if (isActive == true) {
                        viewer.enableCursorStyle = false;
                        viewer._element.style.cursor = '';
                        $('body').removeClass('drawCur').addClass('drawCur');
                        currentPolygon.show = false;
                    } else {
                        viewer.enableCursorStyle = true;
                        $('body').removeClass('drawCur');
                    }
                });
                handlerPolygon.movingEvt.addEventListener(function (windowPosition) {
                    tooltip.showAt(windowPosition, '<p>绘制楼层基底</p>');
                });
                handlerPolygon.drawEvt.addEventListener(function (res) {
                    console.log("res-面:",res);
                    let material = SuperMap3D.Color.fromCssColorString("rgb(224,207,226)");
                    let entity = createPolygon(res.positions, material);
                    geometry_stretch = createGeometry(res.positions, 'polygon');

                    if (handlerPolygon.polygon) handlerPolygon.polygon.show = false;
                    if (handlerPolygon.polyline) handlerPolygon.polyline.show = false;
                    handlerPolygon.deactivate();
                    tooltip.setVisible(false);

                    handlerOrthogonal.setInputAction(e => {
                        tooltip.showAt(e.endPosition, '<p>鼠标上下拉伸面实体,左键双击结束</p>');

                        // 实现编辑Z轴，获取Z轴上编辑后的点坐标
                        let pWindow = e.endPosition;
                        let editPoint = getEditZPoint(pWindow, res.positions);
                        let degree = CartesiantoDegrees(editPoint);

                        if (degree[2] > 1) {
                            extrudedHeight = degree[2];
                            $("#stre_hei").val(Number(extrudedHeight).toFixed(2));
                        } else {
                            extrudedHeight = 1;
                        }

                    }, SuperMap3D.ScreenSpaceEventType.MOUSE_MOVE);

                    // 左键双击移除拉伸事件
                    handlerOrthogonal.setInputAction(e => {
                        viewer.trackedEntity = undefined;
                        handlerOrthogonal.removeInputAction(SuperMap3D.ScreenSpaceEventType.MOUSE_MOVE);//移除事件
                        $('body').removeClass('drawCur');
                        if (!handlerOrthogonal.isDestroyed()) handlerOrthogonal.destroy;
                        tooltip.setVisible(false);

                        updateOperation();

                    }, SuperMap3D.ScreenSpaceEventType.LEFT_DOUBLE_CLICK)
                })

                // 绘制线条
                handlerPolyLine.activeEvt.addEventListener(function (isActive) {
                    if (isActive == true) {
                        viewer.enableCursorStyle = false;
                        viewer._element.style.cursor = '';
                        $('body').removeClass('drawCur').addClass('drawCur');
                    } else {
                        viewer.enableCursorStyle = true;
                        $('body').removeClass('drawCur');
                    }
                });
                handlerPolyLine.movingEvt.addEventListener(function (windowPosition) {
                    tooltip.showAt(windowPosition, '<p>绘制道路中心线</p>');
                });
                handlerPolyLine.drawEvt.addEventListener(function (res) {
                    console.log("res-线:",res);
                    let material = SuperMap3D.Color.fromCssColorString("rgb(0,255,0)");
                    let entity = createPolyline(res.positions, material);
                    geometry_lofting = createGeometry(res.positions, 'polyline');

                    if (handlerPolyLine.polyline) handlerPolyLine.polyline.show = false;
                    handlerPolyLine.deactivate();
                    tooltip.setVisible(false);

                    updateOperation();

                })

            }

            //笛卡尔转point3d
            function cartesiansToPoint3D(positions) {
                let array = [].concat(positions);
                let result = [];
                for (let i = 0, len = array.length; i < len; i++) {
                    let cartographic = SuperMap3D.Cartographic.fromCartesian(array[i]);
                    result.push(new SuperMap3D.Point3D(SuperMap3D.Math.toDegrees(cartographic.longitude), SuperMap3D.Math.toDegrees(cartographic.latitude), cartographic.height));
                }
                return result;
            }

            //笛卡尔转经纬度
            function CartesiantoDegrees(Cartesians) {
                let array = [].concat(Cartesians);
                let positions = [];
                for (let i = 0, len = array.length; i < len; i++) {
                    let cartographic = SuperMap3D.Cartographic.fromCartesian(array[i]);
                    let longitude = Number(SuperMap3D.Math.toDegrees(cartographic.longitude));
                    let latitude = Number(SuperMap3D.Math.toDegrees(cartographic.latitude));
                    let h = Number(cartographic.height);
                    if (positions.indexOf(longitude) == -1 && positions.indexOf(latitude) == -1) {
                        positions.push(longitude);
                        positions.push(latitude);
                        positions.push(h);
                    }
                }
                return positions
            };

            // 实现编辑Z轴
            function getEditZPoint(windowPosition, cornerPointArray) {
                let ray0 = viewer.camera.getPickRay(windowPosition);
                let pWindow1 = new SuperMap3D.Cartesian2(windowPosition.x + 5, windowPosition.y);
                let ray1 = viewer.camera.getPickRay(pWindow1);

                let normal = new SuperMap3D.Cartesian3();
                normal = SuperMap3D.Cartesian3.cross(ray0.direction, ray1.direction, normal);

                let normalize = new SuperMap3D.Cartesian3();
                SuperMap3D.Cartesian3.normalize(normal, normalize);
                let plane = SuperMap3D.Plane.fromPointNormal(viewer.camera.position, normalize);

                let ray = new SuperMap3D.Ray(SuperMap3D.Cartesian3.ZERO, cornerPointArray[cornerPointArray.length - 1])
                let editPoint = SuperMap3D.IntersectionTests.rayPlane(ray, plane);

                return editPoint;
            }

            // 创建面entity
            function createPolygon(pos, material) {
                let entity = viewer?.entities.add({
                    show: true,
                    name: 'add-surface-1',
                    polygon: {
                        hierarchy: {
                            positions: [...pos],
                        },
                        material: material,
                        perPositionHeight: false,
                        // classificationType: SuperMap3D.ClassificationType.BOTH, // 这个会导致编辑Z轴失效
                        extrudedHeight: new SuperMap3D.CallbackProperty(function () {
                            return extrudedHeight;
                        }, false)
                    }
                });
                // entityList.push(entity);
                viewer.selectedEntity = currentPolygon = entity;
                return entity;
            }

            // 创建线实体
            function createPolyline(pos, material) {
                let entity = viewer?.entities.add({
                    show: true,
                    polyline: {
                        positions: [...pos],
                        width: 4,
                        material: material,
                        // classificationType: SuperMap3D.ClassificationType.BOTH, //贴地贴对象模式设置
                        clampToGround: true //贴地贴对象需要设置true
                    }
                })
                currentPolyline = entity;
                currentPolyline.show = false; // 关闭绿色中心线显示
                entityList.push(entity);
                return entity;
            }

            // 根据传入的type创建GeoRegion3D或GeoLine3D类型的Geometry
            function createGeometry(positions, type) {
                let geometry = undefined;
                let part = positions.length;
                let points = cartesiansToPoint3D(positions);

                if (type === 'polygon') {
                    geometry = new SuperMap3D.GeoRegion3D();
                    part++;
                    points.push(points[0]);
                } else if (type === 'polyline') {
                    geometry = new SuperMap3D.GeoLine3D();
                }

                geometry.parts.push(part);
                geometry.points = geometry.points.concat(points);
                geometry.position = geometry.points[0];

                return geometry;
            }

            // 创建拉伸多边形
            function createModelByExtrude(geometry, options, isEdit = true) {
                if (!geometry) return;

                let material = setMaterial(options.material);
                let region = getRegionByHeight(geometry, options.baseHeight);

                let entity = viewer.entities.add({
                    show: true,
                    geometry: {
                        linearExtrudeParam: {
                            region: region, //拉伸底面
                            buildParam: {
                                createTexCoord: true, //是否创建纹理坐标
                                generateNormal: true, //是否生成法线
                                group: true, //是否打组
                                att: 7,  //4只有侧面， 5不封顶，6不封底  7 都有
                                height: options.extrudedHeight,  //拉伸高度
                                scaleX: 1,  //
                                scaleY: 1,  //
                            },
                            uvwParam: {  //纹理设置参数对象
                                realTexMapSize: options.realTexMapSize, //是否真实尺寸生成
                                mappingMode: 0, //0-BOX  1-PLANAR 2-SPHERICAL
                                uTiling: options.uTiling, //u方向重复
                                vTiling: options.vTiling, //v方向重复
                            }
                        },
                        material: material,
                    }
                });
                if (isEdit) {
                    currentOperateEntityList.push(entity);
                    entityList.push(entity);
                }
                currentPolygon.show = false;
            }

            // 创建放样线
            function createModelByLofting(geometry, options, parameter, isEdit = true) {
                if (!geometry) return;

                let material = setMaterial(options.material);
                let line3d = createGeoLine3D(geometry);
                let region = getRegion(parameter);

                let entity = viewer.entities.add({
                    show: true,
                    geometry: {
                        loftParam: {
                            line: line3d,  //放样中心线
                            region: region, //放样截面
                            buildParam: {  //建模参数对象
                                createTexCoord: true, //是否创建纹理坐标
                                generateNormal: true, //是否生成法线
                                group: true, //是否打组
                                att: 3, //1-3 设置起始终止面
                                splitSegment: true, //是否拆分成段
                                splitSide: true, //是否拆分侧面
                                chamferFactor: 0, //平滑参数0-100
                                segmentClosed: true //每段是否闭合
                            },
                            uvwParam: {  //纹理设置参数对象
                                realTexMapSize: options.realTexMapSize, //是否真实尺寸生成
                                mappingMode: 0, //0-BOX  1-PLANAR 2-SPHERICAL
                                uTiling: options.uTiling, //u方向重复
                                vTiling: options.vTiling, //v方向重复
                            }
                        },
                        material: material
                    }
                })
                if (isEdit) {
                    currentOperateEntityList.push(entity);
                    entityList.push(entity);
                }
            }

            // 通过geometry构建GeoRegion3D
            function getRegionByHeight(geometry, baseHeight) {
                let region3d = new SuperMap3D.GeoRegion3D();
                region3d.parts = [...geometry.parts];
                if (SuperMap3D.defined(baseHeight)) {
                    geometry.points.forEach((point) => {
                        region3d.points.push({ x: point.x, y: point.y, z: (point.z || 0) + baseHeight })
                    })
                }
                return region3d;
            }

            // 设置材质
            function setMaterial(materialOptions) {
                if (!materialOptions) return;
                let material = new SuperMap3D.ImageMaterialProperty({
                    image: materialOptions.image,
                    color: SuperMap3D.Color.fromCssColorString(materialOptions.color),
                    unique: true,
                    repeat: new SuperMap3D.Cartesian2(1, 1),
                });

                return material;
            }


            // 创建GeoLine3D
            function createGeoLine3D(geometry) {
                let line3d = new SuperMap3D.GeoLine3D();
                line3d.parts = [...geometry.parts];
                let points = [...geometry.points];
                points.forEach((point) => {
                    line3d.points.push({ x: point.x, y: point.y, z: (point.z || 0) })
                })
                return line3d;
            }

            // 获取截面
            function getRegion(pam) {
                let region3d = new SuperMap3D.GeoRegion3D();
                let regionpts = new SuperMap3D.Point3Ds();
                regionpts.add(new SuperMap3D.Point3D(-pam.bomWidth / 2, 0, 0));
                regionpts.add(new SuperMap3D.Point3D(pam.bomWidth / 2, 0, 0));
                regionpts.add(new SuperMap3D.Point3D(pam.topWidth / 2, pam.height, 0));
                regionpts.add(new SuperMap3D.Point3D(-pam.topWidth / 2, pam.height, 0));
                region3d.addPart(regionpts);
                region3d.points.forEach((point) => {
                    point.x += pam.offset.x;
                    point.y += pam.offset.y;
                })
                return region3d;
            }

            // 创建预先设置好的楼层和道路
            function createAdvancedFacilities(result) {
                if (result && result.substrate) {
                    advancedFloor(result.substrate);//楼层
                    geometry_stretch = undefined;
                }
                if (result && result.centerline) {
                    advancedRoad(result.centerline);//道路
                    geometry_lofting = undefined;
                }
            }

            // 预先设置好参数的楼层
            function advancedFloor(positions) {
                if (!positions || positions.length <= 2) return;
                let material = SuperMap3D.Color.fromCssColorString("rgb(224,207,226)");
                let entity = createPolygon(positions, material);
                geometry_stretch = createGeometry(positions, 'polygon');
                let options = {
                    baseHeight: -2,
                    extrudedHeight: 100,
                    realTexMapSize: true,
                    vTiling: 100,
                    uTiling: 100,
                    material: {
                        image: building_img_side,
                        color: "rgba(255,255,255,1.0)"
                    }
                }

                // 生成侧面
                createModelByExtrude(geometry_stretch, options, false);

                let options_top = {
                    baseHeight: 98,
                    extrudedHeight: 0.5,
                    realTexMapSize: true,
                    vTiling: 100,
                    uTiling: 100,
                    material: {
                        image: building_img_top,
                        color: "rgba(255,255,255,1.0)"
                    }
                }
                // 生成顶面
                createModelByExtrude(geometry_stretch, options_top, false);
            }

            // 预先设置好参数的道路
            function advancedRoad(positions) {
                if (!positions || positions.length <= 1) return;
                let material = SuperMap3D.Color.fromCssColorString("rgb(224,207,226)");
                let entity = createPolyline(positions, material);
                geometry_lofting = createGeometry(positions, 'polyline');
                let options = {
                    realTexMapSize: true,
                    vTiling: 26,
                    uTiling: 26,
                    material: {
                        image: driveway_img,
                        color: "rgba(255,255,255,1.0)"
                    }
                }
                let parameter = {
                    bomWidth: 26,
                    topWidth: 26,
                    height: 0.01,
                    offset: {
                        x: 0,
                        y: 0
                    }
                }
                createModelByLofting(geometry_lofting, options, parameter, false);
            }

            // 自定义拉伸
            function stretchByCustom() {
                if (currentOperateEntityList.length > 0) {
                    currentOperateEntityList.forEach(entity => {
                        viewer.entities.remove(entity);
                    })
                }
                currentOperateEntityList = []
                let options = {
                    baseHeight: Number($('#bom_hei').val()) || 1,
                    extrudedHeight: Number($('#stre_hei').val()) || 100,
                    realTexMapSize: textureMode == 'real',
                    vTiling: textureMode == 'real' ? (Number($('#u_size').val()) || 100) : (Number($('#u_repeat').val()) || 1),
                    uTiling: textureMode == 'real' ? (Number($('#v_size').val()) || 100) : (Number($('#v_repeat').val()) || 1),
                    material: {
                        image: $("#material_texture")[0].checked ? building_img_side : undefined,
                        color: $("#material_color")[0].checked ? materialColor : "rgba(255,255,255,1)"
                    }
                }
                createModelByExtrude(geometry_stretch, options);

                let options_top = {
                    baseHeight: Number(options.extrudedHeight) + Number(options.baseHeight),
                    extrudedHeight: 0.5,
                    realTexMapSize: textureMode == 'real',
                    vTiling: textureMode == 'real' ? (Number($('#u_size').val()) || 100) : (Number($('#u_repeat').val()) || 1),
                    uTiling: textureMode == 'real' ? (Number($('#v_size').val()) || 100) : (Number($('#v_repeat').val()) || 1),
                    material: {
                        image: $("#material_texture")[0].checked ? building_img_top : undefined,
                        color: $("#material_color")[0].checked ? materialColor : "rgba(255,255,255,1)"
                    }
                }
                // 生成顶面
                createModelByExtrude(geometry_stretch, options_top);
            }

            // 自定义放样
            function loftingByCustom() {
                if (currentOperateEntityList.length > 0) {
                    currentOperateEntityList.forEach(entity => {
                        entity.show = false;
                    })
                }
                currentOperateEntityList = [];
                let options = {
                    realTexMapSize: textureMode == 'real',
                    vTiling: textureMode == 'real' ? (Number($('#u_size').val()) || 100) : (Number($('#u_repeat').val()) || 1),
                    uTiling: textureMode == 'real' ? (Number($('#v_size').val()) || 100) : (Number($('#v_repeat').val()) || 1),
                    material: {
                        image: $("#material_texture")[0].checked ? driveway_img : undefined,
                        color: $("#material_color")[0].checked ? materialColor : "rgba(255,255,255,1)"
                    },
                }
                let parameter = {
                    bomWidth: Number($('#bom_wid').val()) || 36,
                    topWidth: Number($('#top_wid').val()) || 36,
                    height: Number($('#road_thick').val()) || 0.01,
                    offset: {
                        x: 0,
                        y: 0
                    }
                }
                createModelByLofting(geometry_lofting, options, parameter);
            }

            // 更新实体状态
            function updateOperation() {
                if (geometry_stretch || geometry_lofting) {
                    if (operateMode == "stretch") {
                        stretchByCustom();
                    } else if (operateMode == "lofting") {
                        loftingByCustom();
                    }
                }
            }

            // 设置编辑
            function setEditHandler(entity, isEditZ, callback) {
                if (!SuperMap3D.defined(entity)) {
                    if (SuperMap3D.defined(editHandler)) editHandler.clear();
                    else { };
                    return;
                }
                if (!SuperMap3D.defined(editHandler)) {
                    editHandler = new SuperMap3D.EditHandler(viewer, entity);
                    editHandler.isEditZ = isEditZ ? isEditZ : false;
                    editHandler.changedEvt.addEventListener(() => {
                        if (operateMode == 'stretch') {
                            geometry_stretch = createGeometry(editHandler._positions, 'polygon');
                        } else if (operateMode == 'lofting') {
                            geometry_lofting = createGeometry(editHandler._positions, 'polyline');
                        }
                        updateOperation();
                        if (SuperMap3D.defined(callback)) {
                            callback(editHandler._positions);
                        }
                    })
                } else {
                    editHandler.deactivate();
                    editHandler.setEditObject(entity);
                    editHandler.activate();
                }
            }

            // 清除编辑
            function clearEdit() {
                if(editHandler) editHandler.clear();
                $("#geometry_edit")[0].checked = false;
            }

            $("#stretch").click(function () {
                operateMode = "stretch";
                $(".colorlable").text("基底颜色");
                $("#u_size").val(100);
                $("#v_size").val(100);
                $("#lofting-container").hide();
                $("#stretch-container").show();
                $("#texture-option-stretch").show();
                $("#texture-option-lofting").hide();
                currentOperateEntityList = [];
                if (handlerPolyLine) handlerPolyLine.clear();
                if (handlerPolygon) handlerPolygon.clear();
                tooltip.setVisible(false);
                clearEdit();
            });
            $("#lofting").click(function () {
                operateMode = "lofting";
                $(".colorlable").text("中心线颜色");
                $("#u_size").val(36);
                $("#v_size").val(36);
                $("#lofting-container").show();
                $("#stretch-container").hide();
                $("#texture-option-lofting").show();
                $("#texture-option-stretch").hide();
                currentOperateEntityList = [];
                if (handlerPolyLine) handlerPolyLine.clear();
                if (handlerPolygon) handlerPolygon.clear();
                tooltip.setVisible(false);
                clearEdit();
            });

            $("#material_texture").click(function () {
                if (this.checked) {
                    $("#material_color")[0].checked = false;
                    $("#material-color-container").hide();
                    $("#material-texture-container").show();
                } else {
                    $("#material_color")[0].checked = true;
                    $("#material-color-container").show();
                    $("#material-texture-container").hide();
                }
            });
            $("#material_color").click(function () {
                if (this.checked) {
                    $("#material_texture")[0].checked = false;
                    $("#material-color-container").show();
                    $("#material-texture-container").hide();
                } else {
                    $("#material_texture")[0].checked = true;
                    $("#material-color-container").hide();
                    $("#material-texture-container").show();
                }
            });
            $("#texture_real").click(function () {
                $("#virtualSize-container").hide();
                $("#realsize-container").show();
            });
            $("#texture_virtual").click(function () {
                $("#virtualSize-container").show();
                $("#realsize-container").hide();
            });
            $("#texture_stretch_1").click(function () {
                building_img_side = "./images/stretchLofting/building_one.jpg"
                updateOperation();
            });
            $("#texture_stretch_2").click(function () {
                building_img_side = "./images/stretchLofting/building_two.jpg"
                updateOperation();
            });
            $("#texture_lofting_1").click(function () {
                driveway_img = "./images/stretchLofting/driveway.jpg"
                updateOperation();
            });
            $("#texture_lofting_2").click(function () {
                driveway_img = "./images/stretchLofting/driveway2.jpg"
                updateOperation();
            });
            $("input[name='texture']").change(function () {
                let selectedValue = $(this).val();
                textureMode = selectedValue;
            });
            $("#colorPicker").spectrum({
                color: "rgba(255,255,255,1.0)",
                showPalette: true,
                showAlpha: true,
                localStorageKey: "spectrum.demo",
                preferredFormat: 'rgba'
            });
            $("#colorPicker").on('change', function (event) {
                materialColor = event.target.value;
                updateOperation();
            });

            $('#draw').on("click", function () {
                clearEdit();
                currentOperateEntityList = [];
                if (operateMode == "stretch") {
                    handlerPolygon.activate();
                } else if (operateMode == "lofting") {
                    handlerPolyLine.activate();
                }
            });

            $("#geometry_edit").click(function () {
                if(entityList.length == 0) return;
                if (this.checked) {
                    if (currentPolygon && operateMode == 'stretch') {
                        currentPolygon.show = true;
                        setEditHandler(currentPolygon, false);
                    } else if (currentPolyline && operateMode == 'lofting') {
                        setEditHandler(currentPolyline, false);
                    }
                    $("#geometry-edit-box-z").show();
                } else {
                    editHandler.clear();
                    $("#geometry-edit-box-z").hide();
                    $("#geometry_edit_z")[0].checked = false;

                }
            });

            $("#geometry_edit_z").click(function () {
                if (!SuperMap3D.defined(editHandler)) return;
                if (this.checked) {
                     editHandler.isEditZ = true;    
                } else {
                    editHandler.isEditZ = false;    
                }
            });

            // 监听:值一旦改变就更新
            $("input[type='number']").change(function () {
                updateOperation();
            });
            $("input[type='checkbox']").change(function () {
                updateOperation();
            });
            $("input[type='radio']").change(function () {
                updateOperation();
            });

            $('#clear').on("click", function () {
                let length = entityList.length;
                for(let i=0;i<length;i++){
                    let entity = entityList.pop();
                    viewer.entities.remove(entity);
                }
                entityList = [];
                if (currentPolygon) currentPolygon.show = false;
                if (currentPolyline) currentPolyline.show = false;
                geometry_stretch = undefined;
                geometry_lofting = undefined;
                clearEdit();
            });

        }
        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>