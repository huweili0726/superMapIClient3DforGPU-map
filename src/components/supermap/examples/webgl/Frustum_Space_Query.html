<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>视域体空间查询</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./style/vuecommon.css" rel="stylesheet">
    <script src="./js/config.js"></script>
    <script src="./js/layerTree/vue.global.js"></script>
    <script src="./js/layerTree/naive-ui.min.js"></script>
    <script src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div class="vue-container" style="display: none;">
        <div id="app">
            <div class="panel-container">
                <div class="panel-header">
                    <div class="panel-header-title">视域体空间查询</div>
                    <span class="panel-header-close" id="close">X</span>
                </div>

                <!-- vue component content -->
                <n-config-provider :theme-overrides="overridesTheme" :theme="darkTheme" style="margin-top: 20px;">
                    <n-scrollbar style="max-height: 520px;padding-right: 10px;" trigger="none">

                        <div class="row-item">
                            <span>方位角(&deg;)</span>
                            <div class="slider-box" style="width: 120px; margin-left: 70px;">
                                <n-slider v-model:value="state.heading" :min="0.0" :max="360.0" :step="1" />
                            </div>
                            <n-input-number v-model:value="state.heading" style="width:60px" :min="0.0" :max="360.0"
                                :step="1" :focusable="false" :show-button="false">
                            </n-input-number>
                        </div>

                        <div class="row-item">
                            <span>俯仰角(&deg;)</span>
                            <div class="slider-box" style="width: 120px; margin-left: 70px;">
                                <n-slider v-model:value="state.pitch" :min="0.0" :max="360.0" :step="1" />
                            </div>
                            <n-input-number v-model:value="state.pitch" style="width:60px" :min="0.0" :max="360.0"
                                :step="1" :focusable="false" :show-button="false">
                            </n-input-number>
                        </div>

                        <div class="row-item">
                            <span>旋转角(&deg;)</span>
                            <div class="slider-box" style="width: 120px; margin-left: 70px;">
                                <n-slider v-model:value="state.roll" :min="0.0" :max="360.0" :step="1" />
                            </div>
                            <n-input-number v-model:value="state.roll" style="width:60px" :min="0.0" :max="360.0"
                                :step="1" :focusable="false" :show-button="false">
                            </n-input-number>
                        </div>

                        <div class="row-item">
                            <span>距离(m)</span>
                            <div class="slider-box" style="width: 120px; margin-left: 77px;">
                                <n-slider v-model:value="state.distance" :min="1.0" :max="2000.0" :step="1" />
                            </div>
                            <n-input-number v-model:value="state.distance" style="width:60px" :min="1.0" :max="2000.0"
                                :step="1" :focusable="false":show-button="false">
                            </n-input-number>
                        </div>

                        <div class="row-item">
                            <span>水平视角(&deg;)</span>
                            <div class="slider-box" style="width: 120px; margin-left: 56px;">
                                <n-slider v-model:value="state.horizontalFov" :min="1.0" :max="179.0" :step="1" />
                            </div>
                            <n-input-number v-model:value="state.horizontalFov" style="width:60px" :min="1.0"
                                :max="360.0" :step="1" :focusable="false" :show-button="false">
                            </n-input-number>
                        </div>

                        <div class="row-item">
                            <span>垂直视角(&deg;)</span>
                            <div class="slider-box" style="width: 120px; margin-left: 56px;">
                                <n-slider v-model:value="state.verticalFov" :min="1.0" :max="179.0" :step="1" />
                            </div>
                            <n-input-number v-model:value="state.verticalFov" style="width:60px" :min="1.0" :max="360.0"
                                :step="1" :focusable="false" :show-button="false">
                            </n-input-number>
                        </div>

                    </n-scrollbar>

                    <div class="btn-row-item" style="margin-left: 134px;">
                        <n-button type="info" color="#3499E5" text-color="#fff" :focusable="false" @click="draw"
                            style="margin-right: 5px;width: 76px;">选择位置</n-button>
                        <n-button type="info" color="#3499E5" text-color="#fff" :focusable="false" @click="query"
                            style="margin-right: 5px;">查询</n-button>
                        <n-button :focusable="false" text-color="#fff" @click="clear">清除</n-button>
                    </div>
                </n-config-provider>

            </div>
        </div>
    </div>
    <div class="loading-container">
        <div class="circle"></div>
    </div>
    <script type="module">
        import DrawHandler from "./js/lib/DrawHandler.js";

        function onload(SuperMap3D) {
            const viewer = new SuperMap3D.Viewer('Container', {
                contextOptions: {
                    contextType: Number(2),  // Webgl2:2 ; WebGPU:3
                }
            });
            window.viewer = viewer;
            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }

        function init(SuperMap3D, scene, viewer) {
            viewer.resolutionScale = window.devicePixelRatio;

            // 加载高德影像地图
            viewer.imageryLayers.addImageryProvider(new SuperMap3D.UrlTemplateImageryProvider({
                url: 'https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                minimumLevel: 3,
                maximumLevel: 18,
            }));
            
            // 打开场景
            const promise = scene.open(URL_CONFIG.SCENE_CHONGQING_TX);
            promise.then(function (layers) {
                document.querySelector('.loading-container').style.display = 'none';
                document.querySelector('.vue-container').style.display = 'block';

                // 初始化Vue组件
                initVueComponents(scene, viewer);
            })
        }


        // 初始化Vue组件
        function initVueComponents(scene, viewer) {
            // 对象解构
            const { reactive, watch } = Vue;
            const { darkTheme } = naive;

            // 初始化变量
            const state = reactive({
                heading: 0,
                pitch: 0,
                roll: 0,
                distance: 200,
                verticalFov: 60,
                horizontalFov: 80,
                area:"5623.23"
            });

            // 绘制类
            const drawHandler = new DrawHandler(viewer, { 
                openMouseTip: false,
            });

            const layers = viewer.scene.layers.layerQueue;
            for (let i = 0; i < layers.length; i++) {
                let layer = layers[i];
                layer.selectEnabled = true;
                layer.selectedColor = new SuperMap3D.Color(232 / 255, 239 / 255, 28 / 255, 0.6);
                layer.selectColorType = SuperMap3D.SelectColorType.REPLACE;
            }

            // 初始化空间查询
            const spatialQuery = new SuperMap3D.SpatialQuery3D(scene);
            spatialQuery.positionMode = SuperMap3D.PositionMode.Intersects;
            spatialQuery.layers = layers;

            // 根据监控参数构建视域体模型并返回
            function getGeometryByParams(params) {
                console.log(params);
                let { viewPosition, heading, pitch, roll, distance, verticalFov, horizontalFov } = params;
                let fovRadianX = horizontalFov * SuperMap3D.Math.RADIANS_PER_DEGREE;
                let fovRadianY = verticalFov * SuperMap3D.Math.RADIANS_PER_DEGREE;
                let tanThetaX = Math.tan(fovRadianX * 0.5);
                let tanThetaY = Math.tan(fovRadianY * 0.5);
                let aspect = tanThetaX / tanThetaY;
                let nearDist = 1;
                let farDist = Math.max(distance, 10.0);
                let viewPos = SuperMap3D.Cartesian3.fromDegreesArrayHeights(viewPosition)[0];
                let headingRadian = heading * SuperMap3D.Math.RADIANS_PER_DEGREE;
                let pitchRadian = pitch * SuperMap3D.Math.RADIANS_PER_DEGREE;
                let rollRadian = roll * SuperMap3D.Math.RADIANS_PER_DEGREE;

                const frustum = new SuperMap3D.PerspectiveFrustum({
                    fov: fovRadianX,
                    aspectRatio: aspect,
                    near: nearDist,
                    far: farDist
                })

                const hpr = new SuperMap3D.HeadingPitchRoll(headingRadian, pitchRadian, rollRadian);

                const frustumGeometry = new SuperMap3D.FrustumGeometry({ // FrustumOutlineGeometry => 线框模式
                    frustum: frustum,
                    origin: viewPos,
                    // orientation: SuperMap3D.Quaternion.fromHeadingPitchRoll(new SuperMap3D.HeadingPitchRoll(headingRadian, pitchRadian, rollRadian))
                    orientation: SuperMap3D.Transforms.headingPitchRollQuaternion(viewPos,hpr)
                })

                const instance = new SuperMap3D.GeometryInstance({
                    geometry: frustumGeometry,
                    attributes: {
                        color: SuperMap3D.ColorGeometryInstanceAttribute.fromColor(SuperMap3D.Color.AQUA.withAlpha(0.3))
                    }
                })

                const primitive = new SuperMap3D.Primitive({
                    geometryInstances: instance,
                    appearance: new SuperMap3D.PerInstanceColorAppearance({
                        closed: true
                    })
                })
                return primitive
            }

            const param = {
                viewPosition: [116.45403447947534, 39.90403086210966, 10],
                heading: 0,
                pitch: 0,
                roll: 0,
                distance: 400,
                verticalFov: 60,
                horizontalFov: 80,
            }
            const updateGeometry = function (option) {
                if (option && option.key && option.value) {
                    if(Object.keys(param).includes(option.key)){
                        param[option.key] = option.value;
                    }
                }

                viewer.scene.primitives.removeAll();
                let geometry = getGeometryByParams(param);

                spatialQuery.geometry = geometry;
                viewer.scene.primitives.add(geometry);

                for (let i = 0; i < layers.length; i++) {
                    layers[i].setSelection([]);
                }
            }

            const draw = async function(){
                const position = await drawHandler.startPoint();
                if (!position) return;

                console.log("position:",position);
                
                const cartographic = SuperMap3D.Cartographic.fromCartesian(position);
                const longitude = SuperMap3D.Math.toDegrees(cartographic.longitude);
                const latitude = SuperMap3D.Math.toDegrees(cartographic.latitude);
                const height = cartographic.height;

                updateGeometry({ key: "viewPosition", value: [longitude, latitude, height] });
            }
            const query = function () {
                spatialQuery.positionMode = SuperMap3D.PositionMode.Intersects
                spatialQuery.build();
            }
            const clear = function () {
                viewer.scene.primitives.removeAll();
                spatialQuery.clear();
                for (let i = 0; i < layers.length; i++) {
                    layers[i].setSelection([]);
                }
            }

            // 创建Vue示例
            const App = {
                setup() {
                    watch(() => state.heading,
                        (val) => {
                            updateGeometry({ key: "heading", value: Number(val) });
                        }
                    );

                    watch(() => state.pitch,
                        (val) => {
                            updateGeometry({ key: "pitch", value: Number(val) });
                        }
                    );

                    watch(() => state.roll,
                        (val) => {
                            updateGeometry({ key: "roll", value: Number(val) });
                        }
                    );

                    watch(() => state.distance,
                        (val) => {
                            updateGeometry({ key: "distance", value: Number(val) });
                        }
                    );

                    watch(() => state.verticalFov,
                        (val) => {
                            updateGeometry({ key: "verticalFov", value: Number(val) });
                        }
                    );

                    watch(() => state.horizontalFov,
                        (val) => {
                            updateGeometry({ key: "horizontalFov", value: Number(val) });
                        }
                    );

                    return {
                        state,
                        darkTheme,
                        draw,
                        query,
                        clear,
                        overridesTheme: { // 重写主题样式
                            common: {
                                primaryColor: "rgba(52, 153, 229, 1)",
                                primaryColorHover: "rgba(52, 153, 229, 1)",
                                primaryColorPressed: "rgba(255,255,255,0.85)",
                                primaryColorSuppl: "rgba(255,255,255,0.45)",
                            },
                            Button: {
                                fontSizeMedium: "14px", // 底部操作按钮：宽高和文字大小自适应浏览器
                                textColor: "rgba(255,255,255,0.65)", // 设置默认n-button全局样式
                                border: "1px solid rgba(255,255,255,0.65)",
                                textColorHover: "#5EB7F2",
                                borderHover: "1px solid #5EB7F2",
                                textColorPressed: "#2276BF",
                                borderPressed: "1px solid #2276BF",
                            },
                            Tabs: {
                                barColor: "#3499e5", // tabs底部横条颜色
                                tabFontSizeMedium: "14px", // tabs标签文字大小 - 兼容移动端样式
                            },
                            ColorPicker: {
                                border: "none", // color-pick颜色条去掉边框
                            },
                            Divider: {
                                color: "rgba(255, 255, 255, 0.15)", // 分割条颜色
                            },
                            Checkbox: {
                                colorChecked: "#3499E5",
                                checkMarkColor: "#fff",
                            },
                            Slider: {
                                fillColor: "#3499E5",
                                fillColorHover: "#3499E5",
                                handleSize: "12px",
                            },
                            Switch: {
                                railColorActive: "#3499E5",
                            },
                            Select: {
                                color: "rgba(255, 255, 255, 0.15)"
                            }
                        },
                    }
                }
            }
            const app = Vue.createApp(App);
            app.use(naive);
            app.mount('#app');
        }

        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>