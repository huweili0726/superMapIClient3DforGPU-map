<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>水场</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/font-awesome.min.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <link href="./style/particleWaterFlow.css" rel="stylesheet">
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script src="./js/slider.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/tooltip.js"></script>
    <script src="./js/spectrum.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>

    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>

    <div class="legend-toolbar">
        <p style="font-size: 1.3em;">水流速度</p>
        <div id="color-legend">
            <div class="color-legend-label"> 2 </div>
            <br />
            <div class="color-legend-label"> 1.5 </div>
            <br />
            <div class="color-legend-label"> 1 </div>
            <br />
            <div class="color-legend-label" style="margin-top:0.5em;"> 0.5 </div>
            <br />
            <div class="color-legend-label" style="margin-top:0.5em;"> 0</div>
        </div>
    </div>

    <div class="tool-bar param-container lable-title" style=" top: 10px;left: 47%; opacity: 0.8; padding: 10px; font-weight: bold; font-size: 20px;">
        <span>WebGL渲染</span>
    </div>
    
    <script>
        function onload(SuperMap3D) {
            let EngineType = getEngineType();
            if(Number(EngineType) === 3) {
                alert('WebGPU暂不支持风场，请使用WebGL渲染');
                EngineType = 2;
            }
            const viewer = new SuperMap3D.Viewer('Container', {
                contextOptions: {
                    infobox: false,
                    skyAtmosphere: true,
                    contextType: Number(EngineType)  // Webgl2:2 ; WebGPU:3
                }
            });

            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }

        function setHypsometric(layer){
          var hyp = new SuperMap3D.HypsometricSetting();

       
          let floor = 0.1;
          let ceil = 1.6841634341693739;
          let dx = (ceil - floor) / 5;
          const colorTable = new SuperMap3D.ColorTable();
          colorTable.insert(floor, new SuperMap3D.Color(255 / 255, 35 / 255, 35 / 255, 1.0));
          colorTable.insert(floor + dx, new SuperMap3D.Color(223 / 255, 202 / 255, 67 / 255, 1.0));
          colorTable.insert(floor + dx * 2, new SuperMap3D.Color(116 / 255, 205 / 255, 180 / 255, 1.0));
          colorTable.insert(floor + dx * 3, new SuperMap3D.Color(107 / 255, 159 / 255, 204 / 255, 1.0));
          colorTable.insert(floor + dx * 4, new SuperMap3D.Color(107 / 255, 143 / 255, 204 / 255, 1.0));
          
          hyp.ColorTable = colorTable;
          hyp.Opacity = 0.5;

          hyp.LineInterval = 10.0;

          //设置图层分层设色属性
          layer.hypsometricSetting = {
              hypsometricSetting: hyp,
              analysisMode: SuperMap3D.HypsometricSettingEnum.AnalysisRegionMode.ARM_ALL
          };
        }

        function init(SuperMap3D, scene, viewer) {
            window.viewer = viewer;
            viewer.scene.skyBox.show = false;
            viewer.scene.sun.show = false;
            scene.globe.depthTestAgainstTerrain = false;
            scene.fog.enabled = false;

            // 加载高德影像地图
            viewer.imageryLayers.addImageryProvider(new SuperMap3D.UrlTemplateImageryProvider({
                url: 'https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                minimumLevel: 3,
                maximumLevel: 18,
            }));

            //全球影像图层调节
            const imageryLayer = viewer.imageryLayers._layers[1];
            imageryLayer.brightness = 1.2
            imageryLayer.saturation = 0.6
            imageryLayer.contrast = 1.0


            const fieldLayer = new SuperMap3D.FieldLayer3D(scene, scene.context); //场数据图层
            setHypsometric(fieldLayer);
            fieldLayer.particleVelocityFieldEffect.velocityScale = 0.1; 
            fieldLayer.particleVelocityFieldEffect.particleSize = 40;
            fieldLayer.particleVelocityFieldEffect.horizontalDensity = 500;

            let dataBounds = SuperMap3D.Rectangle.fromDegrees(118.60696, 31.933451, 118.780261, 32.150184);
            fieldLayer.layerBounds = dataBounds;

            scene.camera.setView({
                destination: {
                    x: -2594398.9692613464,
                    y: 4755823.194206494,
                    z: 3360216.0783820394
                },
                orientation: {
                    heading: 0.7819054516945378,
                    pitch: -0.16842947534961894,
                    roll: 6.283182480483738
                }
            });

            scene.primitives.add(fieldLayer); //添加场图层

            let particleWindField = [];
            let particleWindInverseField = [];

            //加载水场数据
            $.ajax({
                url: './data/grid-water.json',
                success: function (data) {
                    let p = 0;
                    for (let j = 0; j < data.ny; j++) {
                        particleWindField[j] = [];
                        particleWindInverseField[j] = [];
                        for (let i = 0; i < data.nx; i++, p++) {
                            particleWindField[j][i] = data.data[p];
                            particleWindInverseField[j][i] = [-data.data[p][0], -data.data[p][1]];
                        }
                    }
                    $('#loadingbar').remove();
                    setTimeout(function () {
                        fieldLayer.fieldData = particleWindField;
                    }, 3000)
                }
            });

        }
        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>