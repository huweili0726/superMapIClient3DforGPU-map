<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>云南省地形渲染图</title>
  <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
  <link href="./css/pretty.css" rel="stylesheet">
  <script src="./js/jquery.min.js"></script>
  <script src="./js/echarts.min.js"></script>
  <script src="./js/EchartsLayer.js"></script>
  <script src="./js/config.js"></script>
  <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>

  <div id="Container" style="width: 100%;height: 100%;background-image: url('./support/imgs/background.png');"></div>
  <div id='loadingbar' class="spinner">
    <div class="spinner-container container1">
      <div class="circle1"></div>
      <div class="circle2"></div>
      <div class="circle3"></div>
      <div class="circle4"></div>
    </div>
    <div class="spinner-container container2">
      <div class="circle1"></div>
      <div class="circle2"></div>
      <div class="circle3"></div>
      <div class="circle4"></div>
    </div>
    <div class="spinner-container container3">
      <div class="circle1"></div>
      <div class="circle2"></div>
      <div class="circle3"></div>
      <div class="circle4"></div>
    </div>
  </div>
  <script>
    function onload(SuperMap3D) {
      let EngineType = getEngineType();
      const xres = parseInt(window.screen.width * window.devicePixelRatio);
      const yres = parseInt(window.screen.height * window.devicePixelRatio);
      const viewer = new SuperMap3D.Viewer('Container', {
        baseLayerPicker: false,
        orderIndependentTranslucency: false,
        shouldAnimate: true,
        infoBox: false,
        contextOptions: {
          contextType: Number(EngineType),  // Webgl2:2 ; WebGPU:3
          webgl: {
            alpha: true
          },
          maxDrawingBufferWidth: xres,
          maxDrawingBufferHeight: yres
        }
      });

      viewer.scenePromise.then(function (scene) {
        init(SuperMap3D, scene, viewer);
      });
    }

    function init(SuperMap3D, scene, viewer) {
      viewer.resolutionScale = window.devicePixelRatio;
      viewer.scene.globe.depthTestAgainstTerrain = false;
      viewer.scene.postProcessStages.fxaa.enabled = false;
      viewer.scene.bloomEffect.show = true;
      viewer.scene.bloomEffect.threshold = 0.5;
      viewer.scene.bloomEffect.bloomIntensity = 0.5;
      viewer.scene.hdrEnabled = true;
      scene.skyBox.show = false;
      scene.backgroundColor = new SuperMap3D.Color(0.0, 0.0, 0.0, 0.0);
      scene.lightSource.ambientLightColor = new SuperMap3D.Color(0.3, 0.3, 0.3, 0.4);

      const endTime = new Date('2017-05-13');
      endTime.setHours(16);
      viewer.clock.currentTime = SuperMap3D.JulianDate.fromDate(endTime);

      viewer.imageryLayers.addImageryProvider(new SuperMap3D.SingleTileImageryProvider({
        url: './support/imgs/worldblack2.jpg',
      }));

      const widget = viewer.cesiumWidget;
      const promise = viewer.scene.open("https://www.supermapol.com/realspace/services/3D-yunnan_model_432602/rest/realspace")
      promise.then(function (layers) {
        scene.camera.setView({
          //将经度、纬度、高度的坐标转换为笛卡尔坐标
          destination: new SuperMap3D.Cartesian3(-1475398.1045195472, 6799059.686416988, 2146389.299047779),
          orientation: {
            heading: 6.204582659873341,
            pitch: -0.8832380426152957,
            roll: 2.6645352591003757e-14
          }
        });
        let layertop = scene.layers.find('yunnan_model_432602');
        layertop.selectColorType = SuperMap3D.SelectColorType.SILHOUETTE_EDGE; // SILHOUETTE_EDGE
        layertop.selectedColor = new SuperMap3D.Color(0, 1, 1, 1);
        layertop.selectedLineColor = new SuperMap3D.Color(0, 1, 1, 1);
      }, function () {
        let title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？';
        widget.showErrorPanel(title, undefined, e);
      });

      let position = new SuperMap3D.Cartesian3.fromDegrees(109.40543308511627, 26.993328925156895, -50000);
      let targetPosition = new SuperMap3D.Cartesian3.fromDegrees(101.98226836938083, 24.519626362055106, -50000);
      let options_n = {
        targetPosition: targetPosition,
        color: new SuperMap3D.Color(255 / 255, 255 / 255, 255 / 255, 1),
        intensity: 3,
      };
      let directionalLight_n = new SuperMap3D.DirectionalLight(position, options_n);
      viewer.scene.addLightSource(directionalLight_n);

      let chinaRegion = [];
      const handlerPoint = new SuperMap3D.ScreenSpaceEventHandler(scene.canvas);
      handlerPoint.setInputAction(function (event) {
        viewer.entities.removeById("selectedId");
        let layertop = scene.layers.find('yunnan_model_432602');
        let selection = layertop.getSelection();
        if (selection.length > 0) {
          let selectedId = Number(selection[selection.length - 1]);
          viewer.entities.add({
            id: "selectedId",
            polygon: {
              hierarchy: new SuperMap3D.PolygonHierarchy(chinaRegion[selectedId]),
              material: new SuperMap3D.Color(0 / 255, 255 / 255, 255 / 255, 0.3)
            }
          })
        }
      }, SuperMap3D.ScreenSpaceEventType.LEFT_CLICK);

      $.ajax({
        url: './support/json/yunnanfenjie4326.json',
        success: function (data) {
          let geometrys = data.features;
          for (let i = 0; i < geometrys.length; i++) {
            let geometry = geometrys[i].geometry;
            let coordinates = geometry.coordinates;
            let pipeLinePts = [];
            for (let j = 0; j < coordinates.length; j++) {
              let convertPos = new SuperMap3D.Cartesian3.fromDegrees(coordinates[j][0], coordinates[j][
                1
              ], 500);
              pipeLinePts.push(convertPos);
            }
            viewer.entities.add({
              polyline: {
                positions: pipeLinePts,
                width: 1,
                material: new SuperMap3D.Color(200 / 255, 200 / 255, 200 / 255, 0.5)
              }
            })
          }
        }
      });
      
      $.ajax({
        url: './support/json/yunnanbounds4326.json',
        success: function (data) {
          let geometrys = data.features;
          for (let i = 0; i < geometrys.length; i++) {
            let geometry = geometrys[i].geometry;
            let coordinates = geometry.coordinates;
            let pipeLinePts = [];
            let pipeLineBottomPts = [];
            for (let j = 0; j < coordinates.length; j++) {
              let convertPos = new SuperMap3D.Cartesian3.fromDegrees(coordinates[j][0], coordinates[j][
                1
              ], 500);
              pipeLinePts.push(convertPos);
              let convertBottomPos = new SuperMap3D.Cartesian3.fromDegrees(coordinates[j][0], coordinates[j][
                1
              ], -20000);
              pipeLineBottomPts.push(convertBottomPos);
            }
            viewer.entities.add({
              polyline: {
                positions: pipeLinePts,
                width: 2,
                material: new SuperMap3D.Color(200 / 255, 200 / 255, 200 / 255, 1)
              }
            })
            viewer.entities.add({
              polyline: {
                positions: pipeLineBottomPts,
                width: 10,
                material: new SuperMap3D.PolylineGlowMaterialProperty({
                  glowPower: 1,
                  color: SuperMap3D.Color.BLUE
                })
              }
            })
          }
        }
      });

      $.ajax({
        url: './support/json/yunnanregion4326.json',
        success: function (data) {
          let geometrys = data.features;
          for (let i = 0; i < geometrys.length; i++) {
            let geometry = geometrys[i].geometry;
            let coordinates;
            if (geometry.coordinates.length == 1) {
              coordinates = geometry.coordinates[0];
            } else {
              coordinates = geometry.coordinates[0][0];
            }
            let pipeLinePts = [];
            for (let j = 0; j < coordinates.length; j++) {
              pipeLinePts.push(new SuperMap3D.Cartesian3.fromDegrees(coordinates[j][0], coordinates[j][
                1
              ], 80000));
            }
            chinaRegion[geometrys[i].properties.UserID] = pipeLinePts;
          }
        }
      });

      addPOIeChart();
      function addPOIeChart() {
        let data = [];
        let geoCoordMap = {};
        $.ajax({
          url: './support/json/yunnan_city_name_P.json',
          success: function (datas) {
            let realtimeDataEntities = []
            let geometrys = datas.features;
            for (let i = 0; i < geometrys.length; i++) {
              let geometry = geometrys[i].geometry;
              let coordinates = geometry.coordinates;
              let name = geometrys[i].properties.name;
              let level = Number(geometrys[i].properties.level) - 1;
              data.push({
                'name': name,
                'value': 220 + level * 150
              })
              geoCoordMap[name] = [coordinates[0], coordinates[1]];;
              let convertposition = new SuperMap3D.Cartesian3.fromDegrees(coordinates[0], coordinates[
                1], 500);
              viewer.entities.add({
                // id: name,
                position: convertposition,
                label: {
                  text: name,
                  style: SuperMap3D.LabelStyle.FILL_AND_OUTLINE,
                  fillColor: name === "昆明" ? new SuperMap3D.Color(240 / 255, 255 / 255, 0 /
                    255, 1) : new SuperMap3D.Color(255 / 255, 255 / 255, 255 / 255,
                      0.9),
                  outlineColor: name === "昆明" ? new SuperMap3D.Color(0 / 255, 18 / 255, 4 /
                    255, 1) : new SuperMap3D.Color(79 / 255, 128 / 255, 169 / 255, 0.9),
                  disableDepthTestDistance: Number.POSITIVE_INFINITY,
                  font: 20 + level * 8 - Math.pow(window.devicePixelRatio, 2) +
                    'px Arial bold',
                  pixelOffset: new window.SuperMap3D.Cartesian2(15 * name.length + level *
                    15, 0)
                }
              })
            }

            const convertData = function (data) {
              const res = [];
              for (let i = 0; i < data.length; i++) {
                const geoCoord = geoCoordMap[data[i].name];
                if (geoCoord) {
                  res.push({
                    name: data[i].name,
                    value: geoCoord.concat(data[i].value)
                  });
                }
              }
              return res;
            };

            const options = {
              animation: !1,
              GLMap: {},
              series: [{
                name: '前5',
                type: 'effectScatter',
                coordinateSystem: 'GLMap',
                data: convertData(data.sort(function (a, b) {
                  return b.value - a.value;
                }).slice(0, 50)),
                symbolSize: function (val) {
                  return val[2] / 20;
                },
                showEffectOn: 'render',
                rippleEffect: {
                  brushType: 'stroke'
                },
                hoverAnimation: true,
                itemStyle: {
                  normal: {
                    color: '#FFFFFF',
                    shadowBlur: 20,
                    shadowColor: '#333'
                  }
                },
                zlevel: 1
              }]
            };

            let echartsLayer = new EchartsLayer(viewer);
            echartsLayer.chart.setOption(options);
          }
        });
      }

      $('#loadingbar').remove();
    }
    if (typeof SuperMap3D !== 'undefined') {
      window.startupCalled = true;
      onload(SuperMap3D);
    }
  </script>
</body>

</html>