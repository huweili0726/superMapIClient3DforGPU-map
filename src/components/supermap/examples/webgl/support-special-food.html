<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>全国粮食产量TOP10</title>
	<link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
	<link href="./css/pretty.css" rel="stylesheet">
	<script src="./js/jquery.min.js"></script>
	<script src="./js/config.js"></script>
	<script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>
<body>
<div id="cesiumContainer">
  <div id="nanhai"
       style="position: absolute;right: 20px;bottom: 20px; width: 180px;height: 280px;background-image: url('./support/special/food/images/nanhai3.png');z-index: 100;background-size: 100% 100%;">
  </div>
</div>
<div id='loadingbar' class="spinner">
  <div class="spinner-container container1">
    <div class="circle1"></div>
    <div class="circle2"></div>
    <div class="circle3"></div>
    <div class="circle4"></div>
  </div>
  <div class="spinner-container container2">
    <div class="circle1"></div>
    <div class="circle2"></div>
    <div class="circle3"></div>
    <div class="circle4"></div>
  </div>
  <div class="spinner-container container3">
    <div class="circle1"></div>
    <div class="circle2"></div>
    <div class="circle3"></div>
    <div class="circle4"></div>
  </div>
</div>
<div style="height: 200px;width: 100%;position: absolute;top: 0;z-index: 100000;color: white;text-align: center;font-size: 30px;font-weight: 900;">
  <p>2021年全国粮食产量TOP10区域展示</p>
</div>
<script type="text/javascript">
  function onload(SuperMap3D) {
    var xres = parseInt(window.screen.width * window.devicePixelRatio);
    var yres = parseInt(window.screen.height * window.devicePixelRatio);
    var viewer = new SuperMap3D.Viewer('cesiumContainer', {
      timeline: false,
      infoBox: false,
      selectionIndicator: false,
      contextOptions: {
        maxDrawingBufferWidth: xres,
        maxDrawingBufferHeight: yres
      },
    });
    viewer.resolutionScale = window.devicePixelRatio;
    viewer.useBrowserRecommendedResolution = true;
    var scene = viewer.scene;
    scene.skyAtmosphere.brightnessShift = 0.4;  //修改大气的亮度
    scene.debugShowFramesPerSecond = false;
    
    scene.hdrEnabled = true;
    scene.fog.enabled = true;
    scene.lightSource.ambientLightColor = new SuperMap3D.Color(1, 1, 1, 1);
    scene.globe.enableLighting = false;
    scene.lightSource.visibleDistanceMax = 50000000000;
    viewer.clock.currentTime = SuperMap3D.JulianDate.fromDate(new Date(2024, 1, 20, 14));
    scene.globe.lightingFadeInDistance = 50000000000;
    scene.globe.lightingFadeOutDistance = 50000000000;
    var widget = viewer.cesiumWidget;
    try {
      viewer.imageryLayers.addImageryProvider(new SuperMap3D.SingleTileImageryProvider({
        url: './support/special/food/images/world3D5.png'
      }));
      //打开所发布三维服务下的所有图层
      var url = 'https://www.supermapol.com/realspace/services/3D-globe3/rest/realspace';
      var promise = scene.open(url);
      promise.then(function (layers) {
        var imglayer = layers[2];
        imglayer.show = false;
        var layer = viewer.scene.layers.find('中华人民共和国_R4326@chinavec#1');
        layer.selectEnabled = false;
        layer.brightness = 2.5;
        layer.selectedColor = new SuperMap3D.Color(0, 11 / 255, 160 / 255, 0.5);
        scene.camera.setView({
          destination: new SuperMap3D.Cartesian3(-3426657.7857333203, 10444000.815967645, 3756445.0517184734),
          orientation: {
            heading: 6.211450137008368,
            pitch: -1.2560140028224742,
            roll: 1.1368683772161603e-13
          }
        });
        lightSource();
        borderline();
        fanguang();
        getLabel();
        var selsctline;
        var handler = new SuperMap3D.ScreenSpaceEventHandler(scene.canvas);
        //设置鼠标左键单击回调事件
        handler.setInputAction(function (e) {
          if (selsctline) {
            viewer.entities.remove(selsctline)
          }
          // 获取点击位置笛卡尔坐标
          viewer.scene.pickPositionAsync(e.position, new SuperMap3D.Cartesian3())
            .then(position=>{
              var cartographic = SuperMap3D.Cartographic.fromCartesian(position);
              var longitude = SuperMap3D.Math.toDegrees(cartographic.longitude);
              var latitude = SuperMap3D.Math.toDegrees(cartographic.latitude);
              var queryPoint = { // 查询点对象
                x: longitude,
                y: latitude
              };
              // queryByPoint(queryPoint); // 找不到服务
            })
        }, SuperMap3D.ScreenSpaceEventType.LEFT_CLICK);

        // 通过点击查询用于表示单体化的面要素，添加到场景中高亮显示。
        function queryByPoint(queryPoint) {
          var queryObj = {
            "getFeatureMode": "SPATIAL",
            "spatialQueryMode": "INTERSECT",
            "datasetNames": ["DataSource_globe3:" + "中华人民共和国_R4326"],
            "geometry": {
              id: 0,
              parts: [1],
              points: [queryPoint],
              type: "POINT"
            }
          };
          queryObjJSON = JSON.stringify(queryObj); // 转化为JSON字符串作为查询参数
          $.ajax({
            type: "post",
            url: 'https://www.supermapol.com/proxy/22905ebb2998b07c/iserver/services/data_chinatop10_lvunxqbh/rest/data/featureResults.rjson?returnContent=true',
            data: queryObjJSON,
            success: function (result) {
              var resultObj = JSON.parse(result);
              if (resultObj.featureCount > 0) {
                addClapFeature(resultObj.features[0]);
              }
            },
            error: function (msg) {
              console.log(msg);
            }
          })
        }

        // 将数据服务查询到的要素添加到场景中高亮显示，表示选中效果。
        function addClapFeature(feature) {
          var lonLatArr = getLonLatArray(feature.geometry.points);
          selsctline = viewer.entities.add({
            polyline: {
              positions: SuperMap3D.Cartesian3.fromDegreesArrayHeights(lonLatArr),
              material: new SuperMap3D.PolylineGlowMaterialProperty({
                glowPower: 0.99,
                color: new SuperMap3D.Color(0, 10.88, 23.9, 1.0),
              }),
              width: 2
            },
          });
        }

        // 得到[经度,纬度,经度,纬度...]形式的数组，用于构造面。
        function getLonLatArray(points) {
          var point3D = [];
          points.forEach(function (point) {
            point3D.push(point.x);
            point3D.push(point.y);
            point3D.push(2000);
          });
          return point3D;
        }

        if (!scene.pickPositionSupported) {
          alert('不支持深度纹理,无法拾取位置！');
        }
      }, function (e) {
        if (widget._showRenderLoopErrors) {
          var title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？';
          widget.showErrorPanel(title, undefined, e);
        }
      });
    } catch (e) {
      if (widget._showRenderLoopErrors) {
        var title = '渲染时发生错误，已停止渲染。';
        widget.showErrorPanel(title, undefined, e);
      }
    }

    function getLabel() {
      $.ajax({
        url: './support/special/food/json/chinasheng.json',
        success: function (data) {
          var geometrys = data.features;
          for (var i = 0; i < geometrys.length; i++) {
            var pos;
            var geometry = geometrys[i].geometry;
            var coordinates = geometry.coordinates;
            var la = geometrys[i].properties.name;
            pos = new SuperMap3D.Cartesian3.fromDegrees(coordinates[0], coordinates[1], 500);
            viewer.entities.add({
              position: pos,
              label: {
                text: la,
                outlineColor: SuperMap3D.Color.ORANGE,
                disableDepthTestDistance: Number.POSITIVE_INFINITY,
                pixelOffset: new SuperMap3D.Cartesian2(0, 0),
                eyeOffset: new SuperMap3D.Cartesian3(0, 0, -30),
                font: 15 - Math.pow(window.devicePixelRatio, 2) + 'px Arial'
              },
            })
          }
        }
      });
      $.ajax({
        url: './support/special/food/json/liangshipoint.json',
        success: function (data) {
          var geometrys = data.features;
          for (var i = 0; i < geometrys.length; i++) {
            var pos;
            var geometry = geometrys[i].geometry;
            var coordinates = geometry.coordinates;
            var value = geometrys[i].properties.value;
            var height = value / 15;
            pos = new SuperMap3D.Cartesian3.fromDegrees(coordinates[0], coordinates[1], 500);
            var labelpos = new SuperMap3D.Cartesian3.fromDegrees(coordinates[0], coordinates[1], 500);
            var pxx = (308 - height) / 4;
            viewer.entities.add({
              position: labelpos,
              billboard: {
                image: './support/special/food/images/biaoqian3.png',
                verticalOrigin: SuperMap3D.VerticalOrigin.BOTTOM,
                scale: 0.44,
                pixelOffset: new SuperMap3D.Cartesian2(0, -80 + pxx),
              },
            });
            viewer.entities.add({
              position: pos,
              label: {
                text: String(value),
                outlineColor: SuperMap3D.Color.ORANGE,
                disableDepthTestDistance: Number.POSITIVE_INFINITY,
                pixelOffset: new SuperMap3D.Cartesian2(1, -94 + pxx),
                eyeOffset: new SuperMap3D.Cartesian3(0, 0, -30),
                font: 15 - Math.pow(window.devicePixelRatio, 2) + 'px Arial bold'
              },
              billboard: {
                image: './support/special/food/images/zhuzi3.png',
                verticalOrigin: SuperMap3D.VerticalOrigin.BOTTOM,
                scale: 0.25,
                height: height,
                pixelOffset: new SuperMap3D.Cartesian2(0, 0),
              },

            });
          }
        }
      });
    }

    function fanguang() {
      scene.bloomEffect.show = true;//开启泛光
      scene.bloomEffect.threshold = 20;
      scene.bloomEffect.bloomIntensity = 0.03;
      scene.hdrEnabled = true; // 开启hdr
    }

    var spotLight;

    function lightSource() {
      var positions = new SuperMap3D.Cartesian3.fromDegrees(146.37249023096038, 49.4944681704779, 3000000);
      var targetPosition = new SuperMap3D.Cartesian3.fromDegrees(95.42409807335486, 35.87274680861022, 0);
      var options = {
        color: SuperMap3D.Color.WHITE,
        distance: 4003270,
        decay: 0,
        intensity: 3.6
      };
      spotLight = new SuperMap3D.SpotLight(positions, targetPosition, options);
      scene.addLightSource(spotLight);
    }

    function borderline() {
			var promise = SuperMap3D.GeoJsonDataSource.load('./support/special/food/json/chinabounds3D_2.json');
			promise.then(function (dataSource) {
				for (let entityy of dataSource._entityCollection._entities._array) {
					let aa = entityy._polyline._positions._value;
					var minHeights = [], maxHeights = [], wallPOSlonlat = [];
					for (let i = 0; i < aa.length; i++) {
						var cartographic = SuperMap3D.Cartographic.fromCartesian(aa[i]);
						var longitude = SuperMap3D.Math.toDegrees(cartographic.longitude);
						var latitude = SuperMap3D.Math.toDegrees(cartographic.latitude);
						var height = cartographic.height;
						wallPOSlonlat.push(longitude);
						wallPOSlonlat.push(latitude);
						wallPOSlonlat.push(height);
						minHeights.push(0);
						maxHeights.push(height);
					}
					viewer.entities.add({
						polyline: {
							positions: new SuperMap3D.Cartesian3.fromDegreesArrayHeights(wallPOSlonlat),
							material: new SuperMap3D.PolylineGlowMaterialProperty({
								glowPower: 0.2,
								color: new SuperMap3D.Color(0, 2.88, 23.9, 1.0),
							}),
							width: 2
						}
					})
				}
			})
			

      var promise2 = SuperMap3D.GeoJsonDataSource.load('./support/special/food/json/chinaneibu3D_2.json');
      promise2.then(function (dataSource) {
        for (let entityy of dataSource._entityCollection._entities._array) {
          let aa = entityy._polyline._positions._value;
          var wallPOSlonlat = [];
          for (let i = 0; i < aa.length; i++) {
            var cartographic = SuperMap3D.Cartographic.fromCartesian(aa[i]);
            var longitude = SuperMap3D.Math.toDegrees(cartographic.longitude);
            var latitude = SuperMap3D.Math.toDegrees(cartographic.latitude);
            var height = cartographic.height;
            wallPOSlonlat.push(longitude);
            wallPOSlonlat.push(latitude);
            wallPOSlonlat.push(1000);
          }
          viewer.entities.add({
            polyline: {
              positions: new SuperMap3D.Cartesian3.fromDegreesArrayHeights(wallPOSlonlat),
              material: new SuperMap3D.Color(109 / 255, 146 / 255, 210 / 255),
              width: 2
            }
          })
        }
      })
    }

    $('#loadingbar').remove();
  }

  if (typeof SuperMap3D !== 'undefined') {
    window.startupCalled = true;
    onload(SuperMap3D);
  }
</script>
</body>
</html>
