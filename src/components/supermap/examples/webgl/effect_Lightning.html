<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>闪电</title>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <link href="./css/bootstrap-select.min.css" rel="stylesheet">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/bootstrap-select.min.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/shader/LightningShader.js"></script>
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
</head>

<body>
    <div id="Container"></div>
    <div id='loadingbar' class="spinner">
        <div class="spinner-container container1">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container2">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
        <div class="spinner-container container3">
            <div class="circle1"></div>
            <div class="circle2"></div>
            <div class="circle3"></div>
            <div class="circle4"></div>
        </div>
    </div>

    <script>
        function onload(SuperMap3D) {
            // 通过config.js中的getEngineType,获取引擎类型（EngineType）用于设置启动方式
            let EngineType = getEngineType();
            let viewer = new SuperMap3D.Viewer('Container', {
                navigation: false,
                contextOptions: {
                    contextType: 2, // Webgl2:2 ; WebGPU:3
                },
            });

            window.viewer = viewer;
            viewer.resolutionScale = window.devicePixelRatio;

            viewer.scenePromise.then(function (scene) {
                init(SuperMap3D, scene, viewer);
            });
        }

        function init(SuperMap3D, scene, viewer) {
            // 加载高德影像地图
            viewer.imageryLayers.addImageryProvider(new SuperMap3D.UrlTemplateImageryProvider({
                url: 'https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                minimumLevel: 3,
                maximumLevel: 18,
            }));

            scene.skyAtmosphere.show = false; // 开启天空盒时，需要关闭大气渲染
            //创建天空盒
            var cloudSkyBox = new SuperMap3D.SkyBox({
                sources: {
                    positiveX: './images/SkyBox/cloudy/Right.jpg',
                    negativeX: './images/SkyBox/cloudy/Left.jpg',
                    positiveY: './images/SkyBox/cloudy/Front.jpg',
                    negativeY: './images/SkyBox/cloudy/Back.jpg',
                    positiveZ: './images/SkyBox/cloudy/Up.jpg',
                    negativeZ: './images/SkyBox/cloudy/Down.jpg'
                }
            });
            scene.skyBox = cloudSkyBox;

            let promise = viewer.scene.open(URL_CONFIG.SCENE_CBD);
            promise.then(function () {
                // 开启雨景
                viewer.scene.postProcessStages.rain.enabled = true;
                viewer.scene.postProcessStages.rain.uniforms.angle = 0;
                viewer.scene.postProcessStages.rain.uniforms.speed = 14;

                let LightningPostStage = new SuperMap3D.PostProcessStage({
                    fragmentShader: LightningShader, // 导入的闪电shader
                    uniforms: {
                        mix_factor: 0.5,//混合系数0-1之间的数
                        fall_interval: 0.7,//0-1之间的数
                    }
                })
                
                // 添加到场景后处理中
                viewer.scene.postProcessStages.add(LightningPostStage);

                $('#loadingbar').remove();
            })
        }
        if (typeof SuperMap3D !== 'undefined') {
            window.startupCalled = true;
            onload(SuperMap3D);
        }
    </script>
</body>

</html>