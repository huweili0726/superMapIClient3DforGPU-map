<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="Test">
    <meta name="SuperMap3D-sandcastle-labels" content="Geometries">
    <title>SuperMap 路径规划</title>

    <!-- MGIS_SuperMap3D插件 -->
    <!-- <script src="./js/load-mgisclient3d.js"></script> -->

    <!-- MGIS_SuperMap3D插件打包 -->
    <!-- <script src="../MGIS_SuperMap3D/MGIS_SuperMap3D.js"></script> -->

    <!-- 组件源码 -->
    <!-- <script type="module" src="./js/load-cesium-es6.js"></script>
    <link href="../Source/Widgets/widgets.css" rel="stylesheet">
    <script type="text/javascript" src="../Source/ThirdParty/Workers/MGIS_SuperMap3D/MGIS_SuperMap3D.js"></script> -->

    <!-- 组件打包 -->
    <script type="text/javascript" src="../../Build/SuperMap3D/SuperMap3D.js"></script>
    <link href="../../Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
    <script type="text/javascript" src="../../Build/SuperMap3D/ThirdParty/Workers/MGIS_SuperMap3D/MGIS_SuperMap3D.js"></script>

    <script src="js/jquery.min.js"></script>

    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <style>
        .mInput[type=number] {
            margin: 5px 0px;
        }

        .mInput[type=text] {
            margin: 5px 0px;
        }

        .mButton {
            margin: 5px 0px;
        }

        .mSelect {
            margin: 0px;
        }
    </style>
</head>

<body>
    <div class="param-container tool-bar" style="width: 350px;height: auto;padding: 0px;border-radius: 5px;">
        <summary style="font-size: 20px;padding: 10px;background-color: rgba(50, 50, 50, 1);">路径信息</summary>
        <div style="padding: 10px;background-color: rgba(38, 38, 38, 0.75);text-align: center;">
            <div>
                <b class='panel-title text-center'>起点</b>
            </div>
            <div style="margin-left: 10px;margin-bottom: 5px;">
                <b>经度：</b>
                <input class="mInput" style="width: 80px;" id="startX-input" type="number" value="120.18" step="1"
                    min="-180" max="180" oninput="startChanged()" />
                <b>纬度：</b>
                <input class="mInput" style="width: 80px;" id="startY-input" type="number" value="22.99" step="1"
                    min="-90" max="90" oninput="startChanged()" />
            </div>
            <div>
                <b class='panel-title text-center'>终点：</b>
            </div>
            <div style="margin-left: 10px;margin-bottom: 5px;">
                <b>经度：</b>
                <input class="mInput" style="width: 80px;" id="stopX-input" type="number" value="121.56" step="1"
                    min="-180" max="180" oninput="stopChanged()" />
                <b>纬度：</b>
                <input class="mInput" style="width: 80px;" id="stopY-input" type="number" value="25.04" step="1"
                    min="-90" max="90" oninput="stopChanged()" />
            </div>
            <div>
                <b class='panel-title text-center'>途径点</b>
            </div>
            <div style="margin-left: 10px;margin-bottom: 5px;">
                <b>经度：</b>
                <input class="mInput" style="width: 80px;" id="passingX-input" type="number" value="120.64" step="1"
                    min="1" max="100000" oninput="passingChanged()" />
                <b>纬度：</b>
                <input class="mInput" style="width: 80px;" id="passingY-input" type="number" value="24.13" step="1"
                    min="1" max="100000" oninput="passingChanged()" />
            </div>
            <div>
                <b class='panel-title text-center'>规避点</b>
            </div>
            <div style="margin-left: 10px;margin-bottom: 5px;">
                <b>经度：</b>
                <input class="mInput" style="width: 80px;" id="barrierX-input" type="number" value="120.72" step="1"
                    min="-180" max="180" oninput="barrierChanged()" />
                <b>纬度：</b>
                <input class="mInput" style="width: 80px;" id="barrierY-input" type="number" value="24.25" step="1"
                    min="-180" max="180" oninput="barrierChanged()" />
            </div>
        </div>

        <summary style="font-size: 20px;padding: 10px;background-color: rgba(50, 50, 50, 1);">车辆信息</summary>
        <div style="padding: 10px;background-color: rgba(38, 38, 38, 0.75);">
            <div>
                <div style="margin-left: 10px;">
                    <b>长度(米)：</b>
                    <input class="mInput" style="width: 50px;" id="vehicleLength-input" type="number" value="5" step="1"
                        min="0" max="100" oninput="vehicleChanged()" />
                    <b>宽度(米)：</b>
                    <input class="mInput" style="width: 50px;" id="vehicleWidth-input" type="number" value="2.3"
                        step="1" min="0" max="100" oninput="vehicleChanged()" />
                </div>
            </div>
            <div>
                <div style="margin-left: 10px;">
                    <b>高度(米)：</b>
                    <input class="mInput" style="width: 50px;" id="vehicleHeight-input" type="number" value="3" step="1"
                        min="0" max="100" oninput="vehicleChanged()" />
                    <b>重量(吨)：</b>
                    <input class="mInput" style="width: 50px;" id="vehicleWeight-input" type="number" value="50"
                        step="1" min="0" max="100" oninput="vehicleChanged()" />
                </div>
            </div>
        </div>
        <div style="padding: 10px;background-color: rgba(38, 38, 38, 0.75);">
            <button type="button" class="button black mButton" onclick="drawBarrierArea()">绘制障碍区域</button>
            <button type="button" class="button black mButton" onclick="clearBarrierArea()">清空障碍区域</button>
            <button type="button" class="button black mButton" onclick="plan()">开始规划</button>
        </div>
    </div>

    <div id="Container" class="fullSize"
        style="position: absolute;left: 0;width: 100%;height: 100%;border: 1px solid #3473b7;">
        <script id="_sandcastle_script">

            var scene, viewer;
            var markerStart;
            var markerStop;
            var markerPassing;
            var markerBarrier;
            var routeLine3D;

            var plottingLayer;
            var plotEditControl;
            var plotDrawControl;
            var plotPanel;

            var routePlan;

            var selectedAreaGeo;

            function onload(MGIS_SuperMap3D) {
                'use strict';
                if (window.Cesium) {
                    window.SuperMap3D = MGIS_SuperMap3D;
                }
                //若本地没有标绘相关服务则可访问支持中心的iserver
                var host = document.location.toString().match(/file:\/\//) ? "http://localhost:8090" : 'http://' + document.location.hostname + ":8090";
                viewer = new SuperMap3D.Viewer('Container', {
                    timeline: false,
                    animation: false,
                    shouldAnimation: true,
                    skyAtmosphere: false,
                    infoBox: false
                });
                scene = viewer.scene;

                let serverUrl = host + '/iserver/services/plot-jingyong/rest/plot';

                SuperMap3D.Plotting.getInstance(serverUrl, scene);
                plottingLayer = new SuperMap3D.PlottingLayer(scene, "plottingLayer");
                scene.plotLayers.add(plottingLayer);

                plotEditControl = new SuperMap3D.PlotEditControl(scene, plottingLayer);//编辑控件
                plotDrawControl = new SuperMap3D.PlotDrawControl(scene, plottingLayer);//绘制控件

                routePlan = new SuperMap3D.MotorDrivenRoutePlanning({ serverUri: host + "/iserver/services/MGISMotorDrivenRoutePlanningServer/rest" })

                init();
            }

            if (typeof MGIS_SuperMap3D !== 'undefined') {
                window.startupCalled = true;
                onload(MGIS_SuperMap3D);
            }

            document.addEventListener("contextmenu", function event(e) {
                e.preventDefault();
            })


            document.onkeydown = function (event) {
                var event = event || window.event;
                if (event && event.keyCode === 46) {//Delete键
                    let plotLayers = scene.plotLayers.getAllPlottingLayers();
                    for (let i = 0; i < plotLayers.length; i++) {
                        if (selectedAreaGeo) {
                            if (plotLayers[i].getFeatureByUuid(selectedAreaGeo.id)) {
                                plotLayers[i].removeFeatureByUuId(selectedAreaGeo.id, true);
                            }
                        }
                    }
                }
            }

            function checkFindPathData() {
                let startPoint = cartesian3ToDegrees(markerStart.position);;
                let endPoint = cartesian3ToDegrees(markerPassing.position);;
                let wayPoint = cartesian3ToDegrees(markerStop.position);;

                let barrierAreaBounds = [];
                plottingLayer.geoGraphicObjects.forEach(element => {
                    let points = [];
                    let point1 = element.localPoints[0];
                    let point2 = element.localPoints[1];
                    points.push({ x: point1.x, y: point1.y });
                    points.push({ x: point2.x, y: point2.y });
                    barrierAreaBounds.push(points);
                });

                let points = [];
                points.push(startPoint);
                points.push(wayPoint);
                points.push(endPoint);
                // 检查点规划点是否在避让区域内
                let nCount = points.length;
                for (let i = 0; i < nCount; i++) {
                    let point = points[i];
                    for (let j = 0; j < barrierAreaBounds.length; j++) {
                        let barrierAreaBound = barrierAreaBounds[j];
                        let left = barrierAreaBound[0].x;
                        let right = barrierAreaBound[1].x;
                        if (left > right) {
                            left = barrierAreaBound[1].x;
                            right = barrierAreaBound[0].x;
                        }

                        let bottom = barrierAreaBound[0].y;
                        let up = barrierAreaBound[1].y;
                        if (bottom > up) {
                            bottom = barrierAreaBound[1].y;
                            up = barrierAreaBound[0].y;
                        }
                        if (left < point.x && right > point.x && bottom < point.y && up > point.y) {
                            return false;
                        }
                    }
                }
                return true;
            }

            function startChanged() {
                let startPointX = $('#startX-input').val();
                let startPointY = $('#startY-input').val();
                markerStart.position = SuperMap3D.Cartesian3.fromDegrees(parseFloat(startPointX), parseFloat(startPointY), 10);
            }

            function stopChanged() {
                let stopPointX = $('#stopX-input').val();
                let stopPointY = $('#stopY-input').val();
                markerStop.position = SuperMap3D.Cartesian3.fromDegrees(parseFloat(stopPointX), parseFloat(stopPointY), 10);
            }

            function passingChanged() {
                let passingPointX = $('#passingX-input').val();
                let passingPointY = $('#passingY-input').val();
                markerPassing.position = SuperMap3D.Cartesian3.fromDegrees(parseFloat(passingPointX), parseFloat(passingPointY), 10);
            }

            function barrierChanged() {
                let barrierPointX = $('#barrierX-input').val();
                let barrierPointY = $('#barrierY-input').val();
                markerBarrier.position = SuperMap3D.Cartesian3.fromDegrees(parseFloat(barrierPointX), parseFloat(barrierPointY), 10);
            }

            function vehicleChanged() {
                let vehicleLength = $('#vehicleLength-input').val();
                let vehicleWidth = $('#vehicleWidth-input').val();
                let vehicleHeight = $('#vehicleHeight-input').val();
                let vehicleWeight = $('#vehicleWeight-input').val();

                let vehicle = new SuperMap3D.Vehicle({
                    totalWidth: vehicleWidth,
                    totalLength: vehicleLength,
                    totalHeight: vehicleHeight,
                    totalWeight: vehicleWeight
                });

                routePlan.setVehicle(vehicle);
            }

            function cartesian3ToDegrees(position) {
                let cartograhphic = MGIS_SuperMap3D.Cartographic.fromCartesian(position);
                return new SuperMap3D.MPoint3D(MGIS_SuperMap3D.Math.toDegrees(cartograhphic.longitude), MGIS_SuperMap3D.Math.toDegrees(cartograhphic.latitude), cartograhphic.height);
            }

            function plan() {
                if (routeLine3D) {
                    scene.primitives.remove(this.routeLine3D);
                }

                if (!checkFindPathData()) {
                    alert("规划失败");
                    return;
                }

                let schemes = routePlan.getRouteSchemes();
                if (schemes.length > 0) {
                    let routeSchemeUuid = schemes[0].uuid;

                    let point2Ds = [];
                    let pt = cartesian3ToDegrees(markerStart.position);
                    point2Ds.push(new SuperMap3D.Point2D(pt.x, pt.y));
                    pt = cartesian3ToDegrees(markerPassing.position);
                    point2Ds.push(new SuperMap3D.Point2D(pt.x, pt.y));
                    pt = cartesian3ToDegrees(markerStop.position);
                    point2Ds.push(new SuperMap3D.Point2D(pt.x, pt.y));

                    let barrier2Ds = [];
                    pt = cartesian3ToDegrees(markerBarrier.position);
                    barrier2Ds.push(new SuperMap3D.Point2D(pt.x, pt.y));

                    let barrierAreaUUIDs = [];
                    for (var i = plottingLayer.geoGraphicObjects.length - 1; i >= 0; i--) {
                        barrierAreaUUIDs.push(plottingLayer.geoGraphicObjects[i].id);
                    }

                    let path = routePlan.findPath(routeSchemeUuid, point2Ds, barrier2Ds, barrierAreaUUIDs);
                    if (!path || path.point2Ds.length == 0) {
                        alert("规划失败");
                    } else {
                        let latlngs = [];

                        for (let point of path.point2Ds) {
                            latlngs.push(point.x);
                            latlngs.push(point.y);
                        }

                        routeLine3D = new SuperMap3D.GroundPolylinePrimitive({
                            geometryInstances: new SuperMap3D.GeometryInstance({
                                geometry: new SuperMap3D.GroundPolylineGeometry({
                                    positions: SuperMap3D.Cartesian3.fromDegreesArray(latlngs),
                                    width: 7.0
                                })
                            }),
                            appearance: new SuperMap3D.PolylineMaterialAppearance({
                                material: SuperMap3D.Material.fromType('Color', {
                                    color: new SuperMap3D.Color(255, 0, 0),
                                }),
                            }),
                        });
                        scene.primitives.add(routeLine3D);
                    }
                }
            }

            function clearBarrierArea() {
                for (var i = plottingLayer.geoGraphicObjects.length - 1; i >= 0; i--) {
                    routePlan.removeBarrierArea(plottingLayer.geoGraphicObjects[i].id);
                }
                selectedAreaGeo = undefined;
                plottingLayer.removeAll();
            }

            function drawBarrierArea() {
                plotDrawControl.activate(0, 26);
            }

            function registerEvent() {
                plotDrawControl.drawControlEndEvent.addEventListener(function () {//标绘结束，激活编辑控件
                    plotEditControl.activate();
                });

                plotDrawControl.drawFinishEvent.addEventListener(function (geo) {
                    let bounds = geo.computeBounds();

                    let rectangle2D = new SuperMap3D.Rectangle2D();
                    rectangle2D.leftBottom.x = bounds.minX;
                    rectangle2D.leftBottom.y = bounds.minY;
                    rectangle2D.rightTop.x = bounds.maxX;
                    rectangle2D.rightTop.y = bounds.maxY;

                    routePlan.addBarrierArea(geo.id, rectangle2D);
                });

                plotEditControl.FeatureRemoveEvent.addEventListener(() => {
                    if (this._selectedAreaGeo) {
                        let id = this._selectedAreaGeo.id;

                        routePlan.removeBarrierArea(id);
                    }
                });

                plotEditControl.ModifiedEvent.addEventListener((geo) => {
                    if (geo && geo.id) {
                        let bounds = geo.computeBounds();

                        let rectangle2D = new SuperMap3D.Rectangle2D();
                        rectangle2D.leftBottom.x = bounds.minX;
                        rectangle2D.leftBottom.y = bounds.minY;
                        rectangle2D.rightTop.x = bounds.maxX;
                        rectangle2D.rightTop.y = bounds.maxY;

                        routePlan.addBarrierArea(geo.id, rectangle2D);
                    }
                });

                plotEditControl.SelectedEvent.addEventListener((geo) => {
                    selectedAreaGeo = geo;
                });

                plotEditControl.UnSelectedEvent.addEventListener(() => {
                    selectedAreaGeo = undefined;
                });
            }

            function init() {
                let billboardCollection = scene.primitives.add(new SuperMap3D.BillboardCollection());

                let startPointX = $('#startX-input').val();
                let startPointY = $('#startY-input').val();
                let position = SuperMap3D.Cartesian3.fromDegrees(parseFloat(startPointX), parseFloat(startPointY), 10);
                markerStart = billboardCollection.add({
                    show: true,
                    position: position,
                    image: "./img/routePlanning/marker-start-position.png",
                    pixelOffset: new SuperMap3D.Cartesian2(0, 0),
                    horizontalOrigin: SuperMap3D.HorizontalOrigin.CENTER,//水平方向的原点
                    verticalOrigin: SuperMap3D.VerticalOrigin.BOTTOM,    //竖直方向的原点
                    disableDepthTestDistance: Number.MIN_VALUE,
                    sizeInMeters: false,
                    scale: 0.5,
                });

                let stopPointX = $('#stopX-input').val();
                let stopPointY = $('#stopY-input').val();
                position = SuperMap3D.Cartesian3.fromDegrees(parseFloat(stopPointX), parseFloat(stopPointY), 10);
                markerStop = billboardCollection.add({
                    show: true,
                    position: position,
                    image: "./img/routePlanning/marker-end-position.png",
                    pixelOffset: new SuperMap3D.Cartesian2(0, 0),
                    horizontalOrigin: SuperMap3D.HorizontalOrigin.CENTER,//水平方向的原点
                    verticalOrigin: SuperMap3D.VerticalOrigin.BOTTOM,    //竖直方向的原点
                    disableDepthTestDistance: Number.MIN_VALUE,
                    sizeInMeters: false,
                    scale: 0.5,
                });

                let passingPointX = $('#passingX-input').val();
                let passingPointY = $('#passingY-input').val();
                position = SuperMap3D.Cartesian3.fromDegrees(parseFloat(passingPointX), parseFloat(passingPointY), 10);
                markerPassing = billboardCollection.add({
                    show: true,
                    position: position,
                    image: "./img/routePlanning/marker-passing-position.png",
                    pixelOffset: new SuperMap3D.Cartesian2(0, 0),
                    horizontalOrigin: SuperMap3D.HorizontalOrigin.CENTER,//水平方向的原点
                    verticalOrigin: SuperMap3D.VerticalOrigin.BOTTOM,    //竖直方向的原点
                    disableDepthTestDistance: Number.MIN_VALUE,
                    sizeInMeters: false,
                    scale: 0.5,
                });

                let barrierPointX = $('#barrierX-input').val();
                let barrierPointY = $('#barrierY-input').val();
                position = SuperMap3D.Cartesian3.fromDegrees(parseFloat(barrierPointX), parseFloat(barrierPointY), 10);
                markerBarrier = billboardCollection.add({
                    show: true,
                    position: position,
                    image: "./img/routePlanning/marker-barrier-position.png",
                    pixelOffset: new SuperMap3D.Cartesian2(0, 0),
                    horizontalOrigin: SuperMap3D.HorizontalOrigin.CENTER,//水平方向的原点
                    verticalOrigin: SuperMap3D.VerticalOrigin.BOTTOM,    //竖直方向的原点
                    disableDepthTestDistance: Number.MIN_VALUE,
                    sizeInMeters: false,
                    scale: 0.5,
                });

                registerEvent();

                let vehicle = routePlan.getVehicle();
                $('#vehicleLength-input').val(vehicle.totalLength);
                $('#vehicleWidth-input').val(vehicle.totalWidth);
                $('#vehicleHeight-input').val(vehicle.totalHeight);
                $('#vehicleWeight-input').val(vehicle.totalWeight);
            }
        </script>
    </div>
</body>


</html>